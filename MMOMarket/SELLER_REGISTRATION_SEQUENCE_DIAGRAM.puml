@startuml Seller Registration - Sequence Diagram
!theme plain
skinparam backgroundColor #FAFAFA

title Seller Registration - Sequence Diagram\nObject Level - Overview

actor User
participant ":SellerController" as Controller
participant ":SellerRegistrationPublisher" as Publisher
participant "RabbitMQ" as MQ
participant ":SellerRegistrationListener" as Listener
participant ":UserRepository" as UserRepo
participant ":Database" as DB

== Step 1: Send OTP ==

User -> Controller: POST /seller/register/send-otp
activate Controller
Controller -> Controller: Authenticate & generate OTP
Controller -> DB: Save EmailVerification & send email
activate DB
deactivate DB
Controller --> User: OTP sent
deactivate Controller

== Step 2: Submit Registration ==

User -> Controller: POST /seller/register(shopName, description, OTP)
activate Controller

Controller -> Controller: Validate fields & OTP format

alt Validation failed
    Controller --> User: Error
    deactivate Controller
else Validation passed

    Controller -> DB: Validate OTP & check balance
    activate DB
    DB --> Controller: OTP valid, balance OK
    deactivate DB

    alt Balance < 200,000 coins
        Controller --> User: Error (insufficient balance)
        deactivate Controller
    else Balance sufficient

        Controller -> DB: Mark OTP as used
        activate DB
        deactivate DB

        Controller -> Publisher: Publish registration message
        activate Publisher
        Publisher -> MQ: Send message
        activate MQ
        deactivate Publisher

        Controller --> User: Registration queued
        deactivate Controller
    end
end

== Step 3: Process Registration (Async) ==

MQ -> Listener: Consume message
deactivate MQ
activate Listener

Listener -> DB: Load User
activate DB
DB --> Listener: User
deactivate DB

Listener -> UserRepo: activateSellerAndDeductIfNotActive(userId, 200000)
activate UserRepo
UserRepo -> DB: Atomic: UPDATE User\nSET coins = coins - 200000, shopStatus = 'Active'\nWHERE id = ? AND shopStatus != 'Active' AND coins >= 200000
activate DB
DB --> UserRepo: Rows updated (1 or 0)
deactivate DB
deactivate UserRepo

alt Already active or insufficient coins
    alt Already active
        Listener -> DB: Update ShopInfo (idempotent)
        activate DB
        deactivate DB
        deactivate Listener
    else Insufficient coins
        Listener -> DB: Notify user (failed)
        activate DB
        deactivate DB
        deactivate Listener
    end
else Registration success

    Listener -> DB: Create/Update ShopInfo
    activate DB
    deactivate DB

    Listener -> DB: Notify user (success) & send email
    activate DB
    deactivate DB

    deactivate Listener
end

@enduml
@startuml Seller Registration - Class Diagram
!define ENTITY_COLOR #E8F5E9

skinparam backgroundColor #FAFAFA
skinparam linetype ortho
skinparam nodesep 120
skinparam ranksep 120
skinparam padding 15
skinparam classBackgroundColor ENTITY_COLOR
skinparam classBorderColor #81C784
skinparam arrowThickness 1.5

' Title
title Seller Registration - Class Diagram\nEntity Level - Relationships Focus

' =============== ENTITIES ===============

class User <<Entity>> {
}

class ShopInfo <<Entity>> {
}

class EmailVerification <<Entity>> {
}

' =============== LAYOUT HINTS (Hidden) ===============

User -[hidden]right- ShopInfo
User -[hidden]down- EmailVerification

' =============== MAIN RELATIONSHIPS ===============

User "1" -right-> "0..1" ShopInfo : <<has>>

User "1" ..> "0..*" EmailVerification : <<OTP>>

' =============== LEGEND ===============

legend bottom
  **Relationship Types:**
  | Symbol | Meaning |
  | ━━━━━▶ | Association (solid) |
  | ┄┄┄┄┄▶ | Dependency (dotted) |

  **Seller Registration Flow:**
  1. User sends OTP request
  2. User submits registration (shopName, description, OTP)
  3. Validate OTP & balance (200,000 coins)
  4. Deduct coins & update User.shopStatus = Active
  5. Create/Update ShopInfo
  6. User becomes Seller (can list products)

  **Key Points:**
  - Registration fee: 200,000 coins
  - Queue-based processing (RabbitMQ)
  - Atomic: deduct coins + activate shop
  - User role unchanged (CUSTOMER)
  - shopStatus changed to "Active"
end legend

@enduml

