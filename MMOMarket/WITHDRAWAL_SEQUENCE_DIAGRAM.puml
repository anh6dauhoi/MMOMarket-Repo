@startuml Withdrawal - Sequence Diagram
!theme plain
skinparam backgroundColor #FAFAFA

title Withdrawal - Sequence Diagram\nObject Level - Overview

actor Seller
actor Admin
participant ":SellerController" as Controller
participant ":WithdrawalQueuePublisher" as Publisher
participant "RabbitMQ" as MQ
participant ":WithdrawalCreateListener" as Listener
participant ":UserRepository" as UserRepo
participant ":Database" as DB

== Step 1: Send OTP ==

Seller -> Controller: POST /seller/withdrawals/send-otp
activate Controller
Controller -> Controller: Authenticate & generate OTP
Controller -> DB: Save EmailVerification & send email
activate DB
deactivate DB
Controller --> Seller: OTP sent
deactivate Controller

== Step 2: Create Withdrawal Request ==

Seller -> Controller: POST /seller/withdrawals(bankInfoId, amount, OTP)
activate Controller

Controller -> Controller: Validate amount, bankInfo, OTP format

alt Validation failed
    Controller --> Seller: Error
    deactivate Controller
else Validation passed

    Controller -> DB: Pre-validate OTP
    activate DB
    DB --> Controller: OTP valid
    deactivate DB

    Controller -> Publisher: publishCreate(message)
    activate Publisher
    Publisher -> MQ: Send message
    activate MQ
    deactivate Publisher

    Controller --> Seller: Request queued (202 Accepted)
    deactivate Controller
end

== Step 3: Process Withdrawal (Async) ==

MQ -> Listener: Consume message
deactivate MQ
activate Listener

Listener -> DB: Load entities & validate OTP
activate DB
DB --> Listener: Entities & EmailVerification
deactivate DB

alt OTP invalid
    Listener -> Listener: Skip
    deactivate Listener
else OTP valid

    Listener -> DB: Mark OTP used & check open complaints
    activate DB
    DB --> Listener: Complaint count
    deactivate DB

    alt Has open complaints
        Listener -> DB: Notify seller (blocked)
        activate DB
        deactivate DB
        deactivate Listener
    else No complaints

        Listener -> UserRepo: deductCoinsIfEnough(sellerId, amount)
        activate UserRepo
        UserRepo -> DB: Atomic deduct
        activate DB
        DB --> UserRepo: Result (1 or 0)
        deactivate DB
        deactivate UserRepo

        alt Insufficient balance
            Listener -> DB: Notify seller
            activate DB
            deactivate DB
            deactivate Listener
        else Balance OK

            Listener -> DB: INSERT Withdrawal (Pending) & notify
            activate DB
            deactivate DB

            deactivate Listener
        end
    end
end

== Step 4: Admin Approves/Rejects ==

Admin -> Controller: GET /admin/withdrawals
activate Controller
Controller -> DB: Load pending withdrawals
activate DB
DB --> Controller: List
deactivate DB
Controller --> Admin: Display list
deactivate Controller

Admin -> Controller: POST /admin/withdrawals/{id}/approve OR reject
activate Controller

Controller -> DB: Load Withdrawal
activate DB
DB --> Controller: Withdrawal
deactivate DB

alt Approve
    Controller -> DB: UPDATE status=Approved & notify
    activate DB
    deactivate DB
    Controller --> Admin: Success
    deactivate Controller

else Reject
    Controller -> DB: UPDATE status=Rejected
    activate DB
    deactivate DB

    Controller -> UserRepo: Refund coins
    activate UserRepo
    UserRepo -> DB: ADD coins back
    activate DB
    deactivate DB
    deactivate UserRepo

    Controller -> DB: Notify seller
    activate DB
    deactivate DB

    Controller --> Admin: Success
    deactivate Controller
end

@enduml

