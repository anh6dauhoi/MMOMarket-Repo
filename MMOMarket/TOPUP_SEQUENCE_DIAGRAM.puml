@startuml Top-Up (Coin Deposit) - Sequence Diagram
!theme plain
skinparam backgroundColor #FAFAFA

title Top-Up (Coin Deposit) - Sequence Diagram\nObject Level - Overview

actor User
participant "Banking App" as BankApp
participant "SePay System" as SePay
participant ":SepayWebhookController" as Controller
participant ":SepayWebhookService" as Service
participant ":Database" as DB

== Step 1: User Views Top-Up Page ==

User -> Controller: GET /customer/topup
activate Controller
Controller -> DB: Load User & bank info
activate DB
DB --> Controller: User, depositCode
deactivate DB
Controller -> Controller: Generate QR code
Controller --> User: Display page (QR, depositCode)
deactivate Controller

== Step 2: User Makes Bank Transfer ==

User -> BankApp: Scan QR & transfer\n(with depositCode in description)
activate BankApp
BankApp -> SePay: Bank transfer completed
deactivate BankApp

== Step 3: SePay Webhook Processing ==

SePay -> Controller: POST /api/webhook/sepay(Apikey, payload)
activate Controller

Controller -> Controller: Validate API Key

alt Invalid API Key
    Controller --> SePay: 403 Forbidden
    deactivate Controller
else Valid API Key

    Controller -> Service: processSepayDepositWebhook(payload)
    activate Service

    Service -> Service: Validate transferType = "in"

    alt transferType != "in"
        Service --> Controller: Exception
        Controller --> SePay: 200 OK {success: false}
        deactivate Service
        deactivate Controller
    else Valid

        Service -> DB: Check duplicate (sepayTransactionId)
        activate DB
        DB --> Service: exists or not
        deactivate DB

        alt Duplicate transaction
            Service --> Controller: Exception
            Controller --> SePay: 200 OK {success: false}
            deactivate Service
            deactivate Controller
        else New transaction

            Service -> DB: Find User by depositCode
            activate DB
            DB --> Service: User or null
            deactivate DB

            alt User not found
                Service --> Controller: Exception
                Controller --> SePay: 200 OK {success: false}
                deactivate Service
                deactivate Controller
            else User found

                Service -> DB: INSERT CoinDeposit & UPDATE User coins & notify
                activate DB
                deactivate DB

                Service --> Controller: Success
                deactivate Service

                Controller --> SePay: 200 OK {success: true}
                deactivate Controller
            end
        end
    end
end

@enduml

