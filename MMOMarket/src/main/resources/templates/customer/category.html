<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MMO Market - Category</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Tông đỏ chủ đạo */
        :root {
            --primary-red: #F53E32;
        }

        .chip {
            @apply px-4 py-2 rounded-full border text-sm font-medium transition-all duration-200 cursor-pointer;
            border-color: var(--primary-red);
            color: var(--primary-red);
        }
        .chip-active {
            @apply bg-red-600 text-white shadow-lg;
        }
        .product-card {
            @apply bg-white border rounded-xl overflow-hidden transition-transform duration-300 hover:shadow-lg hover:-translate-y-1;
            border-color: #f5f5f5;
        }
        .toggle-btn {
            @apply text-red-600 text-sm mt-2 hover:underline cursor-pointer;
        }
        .range-slider::-webkit-slider-thumb {
            @apply bg-red-600;
        }
        .range-slider::-moz-range-thumb {
            @apply bg-red-600;
        }

        /* top search styles */
        .top-search-input {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 15px;
            background: white;
            width: 100%;
            box-shadow: 0 6px 18px rgba(245,62,50,0.04);
        }
        .top-search-btn {
            padding: 10px 16px;
            background: var(--primary-red);
            color: #fff;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            box-shadow: 0 6px 18px rgba(245,62,50,0.12);
        }
        .top-search-btn:hover { opacity: .95; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div th:replace="~{fragments/header :: header}"></div>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="grid grid-cols-12 gap-8">
        <!-- Sidebar -->
        <aside class="col-span-12 md:col-span-3">
            <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                <h2 class="text-gray-900 font-semibold text-lg mb-4">Categories</h2>
                <div class="space-y-3 text-sm" id="category-list">
                    <div>
                        <a th:href="@{/category}"
                           th:class="${selectedCategory == 'All Products' ? 'block w-full text-left py-2 px-3 rounded bg-red-600 text-white font-semibold shadow' : 'block w-full text-left py-2 px-3 rounded hover:bg-red-50 text-red-600 transition'}">
                            All Products
                        </a>
                    </div>
                    <div th:each="cat, iterStat : ${categories}"
                         th:classappend="${iterStat.index >= 4 ? ' hidden extra-category' : ''}">
                        <a th:href="@{/category/{id}(id=${cat.id})}"
                           th:class="${cat.name == selectedCategory ? 'block w-full text-left py-2 px-3 rounded bg-red-600 text-white font-semibold shadow' : 'block w-full text-left py-2 px-3 rounded hover:bg-red-50 text-red-600 transition'}">
                            <span th:text="${cat.name}">Category Name</span>
                        </a>
                    </div>
                </div>

                <button id="toggle-btn" th:if="${#lists.size(categories) > 4}" class="toggle-btn">Show more</button>

                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        const btn = document.getElementById("toggle-btn");
                        const extraCats = document.querySelectorAll(".extra-category");
                        let expanded = false;
                        if (btn) {
                            btn.addEventListener("click", function () {
                                expanded = !expanded;
                                extraCats.forEach(el => el.classList.toggle("hidden"));
                                btn.textContent = expanded ? "Show less" : "Show more";
                            });
                        }
                    });
                </script>

                <div class="my-6 border-t"></div>

                <h3 class="text-gray-900 font-semibold text-lg mb-3">Filters</h3>
                <form id="filter-form" th:action="@{/category/{id}(id=${categoryId})}" method="get">
                    <div>
                        <p class="text-sm font-medium text-gray-800 mb-2">Price Range</p>
                        <div class="px-1">
                            <input type="range" name="maxPrice"
                                   th:value="${maxPrice != null ? maxPrice : 500000}"
                                   min="0" max="500000" class="w-full accent-red-600 range-slider" oninput="updatePrice(this.value)" />
                            <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span id="max-price-display" th:text="${#numbers.formatDecimal((maxPrice != null ? maxPrice : 500000), 0, 0)}">500,000</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-1 gap-2">
                        <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(0)">All Ratings</button>
                        <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(4)">4 Stars & Up</button>
                        <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(3)">3 Stars & Up</button>
                        <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(2)">2 Stars & Up</button>
                        <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(1)">1 Star & Up</button>
                    </div>
                    <input type="hidden" name="minRating" id="min-rating" th:value="${minRating != null ? minRating : 0}">
                    <input type="hidden" name="sort" id="sort" th:value="${sort != null ? sort : 'newest'}">
                </form>

                <script>
                    function updatePrice(value) {
                        document.getElementById('max-price-display').textContent = Number(value).toLocaleString();
                        document.getElementById('filter-form').submit();
                    }
                    function setRating(rating) {
                        document.getElementById('min-rating').value = rating;
                        document.getElementById('filter-form').submit();
                    }
                    function setSort(sort) {
                        document.getElementById('sort').value = sort;
                        document.getElementById('filter-form').submit();
                    }
                </script>
            </div>
        </aside>

        <!-- Content -->
        <section class="col-span-12 md:col-span-9">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold mb-1" th:text="${selectedCategory}">Category Name</h1>
                    <p class="text-gray-600 text-sm">Explore a wide range of digital resources from top sellers.</p>
                </div>
            </div>

            <!-- Top search: new -->
            <form id="category-search-form" class="mb-6" onsubmit="return false;">
                <div class="flex gap-3">
                    <input id="category-search-input" type="search" placeholder="Search products in this category..." class="top-search-input" />
                    <button id="category-search-clear" type="button" class="top-search-btn">Clear</button>
                </div>
            </form>

            <!-- Sorting: responsive segmented buttons + mobile select -->
            <div class="flex items-center justify-between mb-6">
                <div class="hidden sm:flex items-center gap-2 bg-white p-1 rounded-lg border border-gray-100 shadow-sm" role="tablist" aria-label="Sort products">
                    <button role="tab" type="button"
                            onclick="setSort('newest')"
                            th:classappend="${sort == 'newest' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                            class="px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-bolt mr-2"></i>Newest
                    </button>

                    <button role="tab" type="button"
                            onclick="setSort('price-low-to-high')"
                            th:classappend="${sort == 'price-low-to-high' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                            class="px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-sort-amount-down mr-2"></i>Price: Low → High
                    </button>

                    <button role="tab" type="button"
                            onclick="setSort('price-high-to-low')"
                            th:classappend="${sort == 'price-high-to-low' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                            class="px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-sort-amount-up mr-2"></i>Price: High → Low
                    </button>

                    <button role="tab" type="button"
                            onclick="setSort('rating')"
                            th:classappend="${sort == 'rating' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                            class="px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-star mr-2"></i>Top Rated
                    </button>
                </div>

                <!-- Mobile: compact select -->
                <div class="sm:hidden w-full">
                    <label for="sortSelect" class="sr-only">Sort products</label>
                    <select id="sortSelect" onchange="setSort(this.value)"
                            class="w-full py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm shadow-sm">
                        <option th:value="newest" th:selected="${sort == 'newest'}">Newest</option>
                        <option th:value="price-low-to-high" th:selected="${sort == 'price-low-to-high'}">Price: Low → High</option>
                        <option th:value="price-high-to-low" th:selected="${sort == 'price-high-to-low'}">Price: High → Low</option>
                        <option th:value="rating" th:selected="${sort == 'rating'}">Top Rated</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid (Đồng bộ giao diện với Homepage) -->
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <div th:each="item : ${products}"
                     class="hover-card product-item bg-white rounded-2xl overflow-hidden border border-gray-100 transition-all duration-300 hover:-translate-y-2">
                    <!-- CHANGED: make entire card clickable -->
                    <a th:href="@{/products/{id}(id=${item.product.id})}" class="block group">
                        <img th:src="${item.product.image != null ? item.product.image : '/images/default.jpg'}"
                             alt="Product Image"
                             class="w-full h-56 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 text-center">
                            <h3 class="font-semibold text-lg text-gray-900 truncate product-title group-hover:text-[#F53E32]"
                                th:text="${item.product.name}">Product Name</h3>

                            <p class="text-[#F53E32] font-bold mt-1 product-price"
                               th:text="${#numbers.formatDecimal(item.price,0,0)} + ' coins'">0 coins</p>

                            <p class="text-gray-500 text-sm"
                               th:text="'Sold: ' + ${item.totalSold}">Sold: 0</p>

                            <a th:href="@{/shop/{id}(id=${item.product.seller.id})}"
                               class="text-gray-600 text-sm hover:text-[#F53E32] product-shop"
                               th:text="'Shop: ' + ${item.shopName}"
                               onclick="event.stopPropagation();">Shop: Name</a>

                            <p class="text-yellow-500 text-sm mt-1"
                               th:text="'⭐ ' + ${#numbers.formatDecimal(item.averageRating,1,1)} + ' / 5'">⭐ 0.0 / 5</p>
                        </div>
                    </a>
                </div>

                <!-- Hiển thị nếu không có sản phẩm -->
                <div id="no-results" th:if="${#lists.isEmpty(products)}" class="col-span-full text-center text-gray-500 py-10">
                    No products found in this category.
                </div>
            </div>


            <!-- Pagination (client-side, populated dynamically) -->
            <div id="paginationControls" class="mt-8 flex items-center justify-center gap-2" aria-label="Pagination"></div>
        </section>
    </div>
</main>

<script>
    // Debounce helper
    function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }

    // --- Pagination config ---
    const PAGE_SIZE = 9;
    let currentPage = 1;

    // Helper: live list of product item elements
    function getAllProductItems() {
        return Array.from(document.querySelectorAll('.product-item'));
    }

    // Determine currently "filter-visible" items (not filtered-out via 'hidden' class)
    function getVisibleItems() {
        return getAllProductItems().filter(el => !el.classList.contains('hidden'));
    }

    // Show only items for the requested page (1-based)
    function renderPage(page) {
        const allItems = getAllProductItems();
        const visible = getVisibleItems();
        const totalPages = Math.max(1, Math.ceil(visible.length / PAGE_SIZE));
        currentPage = Math.min(Math.max(1, page), totalPages);

        // Hide all items first (we will selectively display the page slice)
        allItems.forEach(i => {
            i.style.display = 'none';
            i.classList.remove('visible-by-page');
        });

        // Compute start/end on visible list and show them
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        visible.forEach((el, idx) => {
            if (idx >= start && idx < end) {
                el.style.display = '';
                el.classList.add('visible-by-page');
            }
        });

        updateNoResultsAndControls();
    }

    // Build/update pagination controls
    function updatePaginationControls() {
        const visible = getVisibleItems();
        const totalPages = Math.max(1, Math.ceil(visible.length / PAGE_SIZE));
        const container = document.getElementById('paginationControls');
        container.innerHTML = '';

        if (visible.length === 0) return;

        // Prev
        const prev = document.createElement('button');
        prev.type = 'button';
        prev.className = 'px-3 py-1 rounded-md border text-sm bg-white hover:bg-red-50 transition';
        prev.innerText = 'Prev';
        prev.disabled = currentPage <= 1;
        prev.onclick = () => { if (currentPage > 1) renderPage(currentPage - 1); };
        container.appendChild(prev);

        // page numbers (condensed)
        const maxButtons = 7;
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);

        if (startPage > 1) {
            container.appendChild(makePageButton(1));
            if (startPage > 2) {
                const dots = document.createElement('span'); dots.className = 'px-2 text-gray-400'; dots.innerText = '...'; container.appendChild(dots);
            }
        }

        for (let p = startPage; p <= endPage; p++) container.appendChild(makePageButton(p));

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('span'); dots.className = 'px-2 text-gray-400'; dots.innerText = '...'; container.appendChild(dots);
            }
            container.appendChild(makePageButton(totalPages));
        }

        // Next
        const next = document.createElement('button');
        next.type = 'button';
        next.className = 'px-3 py-1 rounded-md border text-sm bg-white hover:bg-red-50 transition';
        next.innerText = 'Next';
        next.disabled = currentPage >= totalPages;
        next.onclick = () => { if (currentPage < totalPages) renderPage(currentPage + 1); };
        container.appendChild(next);
    }

    function makePageButton(p) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-10 h-10 grid place-items-center rounded-full text-sm transition';
        btn.style.border = '1px solid #e5e7eb';
        btn.innerText = p;
        if (p === currentPage) {
            btn.classList.add('bg-red-600', 'text-white', 'shadow');
            btn.style.border = '1px solid rgba(245,62,50,0.9)';
        } else {
            btn.classList.add('text-gray-700', 'hover:bg-red-50');
        }
        btn.onclick = () => renderPage(p);
        return btn;
    }

    // Update "No results" visibility and controls
    function updateNoResultsAndControls() {
        const visible = getVisibleItems();
        const noResults = document.getElementById('no-results');
        if (visible.length === 0) {
            if (noResults) { noResults.classList.remove('hidden'); noResults.style.display = ''; }
        } else {
            if (noResults) { noResults.classList.add('hidden'); noResults.style.display = 'none'; }
        }
        updatePaginationControls();
    }

    // Reset pagination to page 1 and render
    function applyPaginationReset() {
        currentPage = 1;
        renderPage(currentPage);
    }

    // Filter product cards by query (name, shop, price) and re-run pagination
    function filterCategoryProducts(query){
        const q = (query || '').trim().toLowerCase();
        const items = document.querySelectorAll('.product-item');
        let visibleCount = 0;
        items.forEach(item => {
            const titleEl = item.querySelector('.product-title');
            const shopEl = item.querySelector('.product-shop');
            const priceEl = item.querySelector('.product-price');

            const title = titleEl ? titleEl.textContent.trim().toLowerCase() : '';
            const shop = shopEl ? shopEl.textContent.trim().toLowerCase() : '';
            const price = priceEl ? priceEl.textContent.trim().toLowerCase() : '';

            const match = q === '' || title.includes(q) || shop.includes(q) || price.includes(q);
            item.classList.toggle('hidden', !match);
            if(match) visibleCount++;
        });

        applyPaginationReset();
    }

    document.addEventListener('DOMContentLoaded', function(){
        const input = document.getElementById('category-search-input');
        const clearBtn = document.getElementById('category-search-clear');

        // live search with debounce
        input && input.addEventListener('input', debounce(function(e){
            filterCategoryProducts(e.target.value);
        }, 220));

        // clear button
        clearBtn && clearBtn.addEventListener('click', function(){
            if(input) input.value = '';
            filterCategoryProducts('');
            input && input.focus();
        });

        // initial pagination render (honors server-side 'no products' rendering)
        applyPaginationReset();
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
