<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MMO Market - Category</title>
    <!-- Favicon - Multiple sizes for crisp display -->
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="48x48" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/logo.png}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/images/logo.png}">
    <link rel="shortcut icon" type="image/png" th:href="@{/images/logo.png}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/customer/css/category.css}">
    <style>
        body {
            background: url('/images/home1.jpg') no-repeat center center fixed;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }
        @media (max-width: 640px) {
            body { background-position: top center; }
        }
    </style>
</head>
<body class="text-gray-900">
<div th:replace="~{fragments/header :: header(active='category')}"></div>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <!-- Semi-transparent white wrapper for all content -->
    <div class="bg-white bg-opacity-50 backdrop-blur-sm rounded-2xl p-6 sm:p-8 lg:p-10 shadow-lg">
        <div class="grid grid-cols-12 gap-8">
            <!-- Sidebar -->
            <aside class="col-span-12 md:col-span-3">
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-gray-900 font-semibold text-lg mb-4">Categories</h2>
                    <div class="space-y-3 text-sm" id="category-list">
                        <div>
                            <a th:href="@{/category}"
                               th:class="${selectedCategory == 'All Products' ? 'block w-full text-left py-2 px-3 rounded bg-red-600 text-white font-semibold shadow' : 'block w-full text-left py-2 px-3 rounded hover:bg-red-50 text-red-600 transition'}">
                                All Products
                            </a>
                        </div>
                        <div th:each="cat, iterStat : ${categories}"
                             th:classappend="${iterStat.index >= 4 ? ' hidden extra-category' : ''}">
                            <a th:href="@{/category/{id}(id=${cat.id})}"
                               th:class="${cat.name == selectedCategory ? 'block w-full text-left py-2 px-3 rounded bg-red-600 text-white font-semibold shadow' : 'block w-full text-left py-2 px-3 rounded hover:bg-red-50 text-red-600 transition'}">
                                <span th:text="${cat.name}">Category Name</span>
                            </a>
                        </div>
                    </div>

                    <button id="toggle-btn" th:if="${#lists.size(categories) > 4}" class="toggle-btn">Show more</button>

                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const btn = document.getElementById("toggle-btn");
                            const extraCats = document.querySelectorAll(".extra-category");
                            let expanded = false;
                            if (btn) {
                                btn.addEventListener("click", function () {
                                    expanded = !expanded;
                                    extraCats.forEach(el => el.classList.toggle("hidden"));
                                    btn.textContent = expanded ? "Show less" : "Show more";
                                });
                            }
                        });
                    </script>

                    <div class="my-6 border-t"></div>

                    <h3 class="text-gray-900 font-semibold text-lg mb-3">Filters</h3>
                    <form id="filter-form" th:action="${categoryId != null ? '/category/' + categoryId : '/category'}" method="get">
                        <div>
                            <p class="text-sm font-medium text-gray-800 mb-2">Price Range</p>
                            <div class="px-1">
                                <input type="range" name="maxPrice"
                                       th:value="${maxPrice != null ? maxPrice : 500000}"
                                       min="0" max="500000" class="w-full accent-red-600 range-slider" oninput="updatePrice(this.value)" />
                                <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                                    <span>0</span>
                                    <span id="max-price-display" th:text="${#numbers.formatDecimal((maxPrice != null ? maxPrice : 500000), 0, 0)}">500,000</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-1 gap-2">
                            <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(0)">All Ratings</button>
                            <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(4)">4 Stars & Up</button>
                            <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(3)">3 Stars & Up</button>
                            <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(2)">2 Stars & Up</button>
                            <button type="button" class="px-4 py-2 border rounded-lg text-sm text-red-600 hover:bg-red-50 transition" onclick="setRating(1)">1 Star & Up</button>
                        </div>
                        <input type="hidden" name="minRating" id="min-rating" th:value="${minRating != null ? minRating : 0}">
                        <input type="hidden" name="sort" id="sort" th:value="${sort != null ? sort : 'newest'}">
                    </form>

                    <script>
                        function updatePrice(value) {
                            document.getElementById('max-price-display').textContent = Number(value).toLocaleString();
                            document.getElementById('filter-form').submit();
                        }
                        function setRating(rating) {
                            document.getElementById('min-rating').value = rating;
                            document.getElementById('filter-form').submit();
                        }
                        function setSort(sort) {
                            document.getElementById('sort').value = sort;
                            document.getElementById('filter-form').submit();
                        }
                    </script>
                </div>
            </aside>

            <!-- Content -->
            <section class="col-span-12 md:col-span-9">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold mb-1" th:text="${selectedCategory}">Category Name</h1>
                        <p class="text-gray-600 text-sm">Explore a wide range of digital resources from top sellers.</p>
                    </div>
                </div>

                <!-- Search removed for server-side pagination simplicity -->

                <!-- Sorting: responsive segmented buttons + mobile select -->
                <div class="flex items-center justify-between mb-6">
                    <div class="hidden sm:flex items-center gap-2 bg-white p-1 rounded-lg border border-gray-100 shadow-sm" role="tablist" aria-label="Sort products">
                        <button role="tab" type="button"
                                onclick="setSort('newest')"
                                th:classappend="${sort == 'newest' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                                class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-bolt mr-2"></i>Newest
                        </button>

                        <button role="tab" type="button"
                                onclick="setSort('price-low-to-high')"
                                th:classappend="${sort == 'price-low-to-high' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                                class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-sort-amount-down mr-2"></i>Price: Low → High
                        </button>

                        <button role="tab" type="button"
                                onclick="setSort('price-high-to-low')"
                                th:classappend="${sort == 'price-high-to-low' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                                class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-sort-amount-up mr-2"></i>Price: High → Low
                        </button>

                        <button role="tab" type="button"
                                onclick="setSort('rating')"
                                th:classappend="${sort == 'rating' ? ' bg-red-600 text-white shadow' : ' text-red-600 hover:bg-red-50'}"
                                class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-star mr-2"></i>Top Rated
                        </button>
                    </div>

                    <!-- Mobile: compact select -->
                    <div class="sm:hidden w-full">
                        <label for="sortSelect" class="sr-only">Sort products</label>
                        <select id="sortSelect" onchange="setSort(this.value)"
                                class="w-full py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm shadow-sm">
                            <option th:value="newest" th:selected="${sort == 'newest'}">Newest</option>
                            <option th:value="price-low-to-high" th:selected="${sort == 'price-low-to-high'}">Price: Low → High</option>
                            <option th:value="price-high-to-low" th:selected="${sort == 'price-high-to-low'}">Price: High → Low</option>
                            <option th:value="rating" th:selected="${sort == 'rating'}">Top Rated</option>
                        </select>
                    </div>
                </div>

                <!-- Products Grid: 3 products per row on large screens -->
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div th:each="item : ${products}"
                         class="hover-card product-item bg-white rounded-2xl overflow-hidden border border-gray-100 transition-all duration-300 hover:-translate-y-2">
                        <div class="block group">
                            <a th:href="@{/products(id=${item.product.id})}">
                                <img th:src="${item.product.image != null ? item.product.image : '/images/default.jpg'}"
                                     alt="Product Image"
                                     class="w-full h-56 object-cover transition-transform duration-300 group-hover:scale-105">
                            </a>
                            <div class="p-4 text-center">
                                <h3 class="font-semibold text-lg text-gray-900 truncate product-title group-hover:text-[#F53E32]">
                                    <a th:href="@{/products(id=${item.product.id})}" th:text="${item.product.name}">Product Name</a>
                                </h3>
                                <p class="text-[#F53E32] font-bold mt-1 product-price">
                                    <span class="format-price" th:attr="data-price=${item.price}">0</span> coins
                                </p>
                                <p class="text-gray-500 text-sm"
                                   th:text="'Sold: ' + ${item.totalSold}">Sold: 0</p>
                                <a th:if="${item['shopId'] != null}" th:href="@{/shop(id=${item['shopId']})}"
                                   class="text-gray-600 text-sm hover:text-[#F53E32] product-shop"
                                   th:text="'Shop: ' + ${item.shopName}">Shop: Name</a>
                                <a th:unless="${item['shopId'] != null}"
                                   th:href="@{/shop/by-seller/{sellerId}(sellerId=${item.product.seller.id})}"
                                   class="text-gray-600 text-sm hover:text-[#F53E32] product-shop"
                                   th:text="'Shop: ' + ${item.shopName}">Shop: Name</a>
                                <p class="text-yellow-500 text-sm mt-1"
                                   th:text="'⭐ ' + ${#numbers.formatDecimal(item.averageRating,1,1,'POINT')} + ' / 5'">⭐ 0.0 / 5</p>
                            </div>
                        </div>
                    </div>

                    <!-- Hiển thị nếu không có sản phẩm -->
                    <div th:if="${#lists.isEmpty(products)}" class="col-span-full text-center text-gray-500 py-10">
                        No products found in this category.
                    </div>
                </div>

                <!-- Server-side Pagination -->
                <div th:if="${totalPages != null and totalPages > 1}" class="mt-8 flex flex-wrap items-center justify-center gap-2" aria-label="Pagination">

                    <!-- Previous Button -->
                    <th:block th:if="${categoryId != null}">
                        <a th:if="${currentPage > 1}"
                           th:href="@{/category/{id}(id=${categoryId}, page=${currentPage - 1}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                           class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-white hover:bg-red-50 transition font-medium">
                            Prev
                        </a>
                    </th:block>
                    <th:block th:unless="${categoryId != null}">
                        <a th:if="${currentPage > 1}"
                           th:href="@{/category(page=${currentPage - 1}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                           class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-white hover:bg-red-50 transition font-medium">
                            Prev
                        </a>
                    </th:block>
                    <button th:unless="${currentPage > 1}" disabled
                            class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-gray-100 text-gray-400 cursor-not-allowed font-medium">
                        Prev
                    </button>

                    <!-- Page Numbers -->
                    <th:block th:with="
                        startPage=${currentPage - 3 < 1 ? 1 : currentPage - 3},
                        endPage=${startPage + 6 > totalPages ? totalPages : startPage + 6},
                        adjustedStart=${endPage - startPage < 6 && totalPages > 6 ? (endPage - 6 > 0 ? endPage - 6 : 1) : startPage}">

                        <!-- First page link if not in visible range -->
                        <th:block th:if="${adjustedStart > 1}">
                            <th:block th:if="${categoryId != null}">
                                <a th:href="@{/category/{id}(id=${categoryId}, page=1, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                   class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                    1
                                </a>
                            </th:block>
                            <th:block th:unless="${categoryId != null}">
                                <a th:href="@{/category(page=1, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                   class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                    1
                                </a>
                            </th:block>
                            <span th:if="${adjustedStart > 2}" class="px-2 text-gray-400">...</span>
                        </th:block>

                        <!-- Page number buttons -->
                        <th:block th:each="pageNum : ${#numbers.sequence(adjustedStart, endPage)}">
                            <!-- Active page (current) -->
                            <button th:if="${pageNum == currentPage}"
                                    th:text="${pageNum}"
                                    class="w-10 h-10 grid place-items-center rounded-full text-sm transition bg-red-600 text-white shadow-md border-2 border-red-600 font-bold">
                            </button>

                            <!-- Other pages (clickable links) -->
                            <th:block th:unless="${pageNum == currentPage}">
                                <th:block th:if="${categoryId != null}">
                                    <a th:href="@{/category/{id}(id=${categoryId}, page=${pageNum}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                       th:text="${pageNum}"
                                       class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                    </a>
                                </th:block>
                                <th:block th:unless="${categoryId != null}">
                                    <a th:href="@{/category(page=${pageNum}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                       th:text="${pageNum}"
                                       class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                    </a>
                                </th:block>
                            </th:block>
                        </th:block>

                        <!-- Last page link if not in visible range -->
                        <th:block th:if="${endPage < totalPages}">
                            <span th:if="${endPage < totalPages - 1}" class="px-2 text-gray-400">...</span>
                            <th:block th:if="${categoryId != null}">
                                <a th:href="@{/category/{id}(id=${categoryId}, page=${totalPages}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                   th:text="${totalPages}"
                                   class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                </a>
                            </th:block>
                            <th:block th:unless="${categoryId != null}">
                                <a th:href="@{/category(page=${totalPages}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                                   th:text="${totalPages}"
                                   class="w-10 h-10 grid place-items-center rounded-full text-sm transition border border-gray-300 bg-white text-gray-700 hover:bg-red-50 font-medium">
                                </a>
                            </th:block>
                        </th:block>
                    </th:block>

                    <!-- Next Button -->
                    <th:block th:if="${categoryId != null}">
                        <a th:if="${currentPage < totalPages}"
                           th:href="@{/category/{id}(id=${categoryId}, page=${currentPage + 1}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                           class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-white hover:bg-red-50 transition font-medium">
                            Next
                        </a>
                    </th:block>
                    <th:block th:unless="${categoryId != null}">
                        <a th:if="${currentPage < totalPages}"
                           th:href="@{/category(page=${currentPage + 1}, maxPrice=${maxPrice != 500000 ? maxPrice : null}, minRating=${minRating > 0 ? minRating : null}, sort=${sort != 'newest' ? sort : null})}"
                           class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-white hover:bg-red-50 transition font-medium">
                            Next
                        </a>
                    </th:block>
                    <button th:unless="${currentPage < totalPages}" disabled
                            class="px-4 py-2 rounded-md border border-gray-300 text-sm bg-gray-100 text-gray-400 cursor-not-allowed font-medium">
                        Next
                    </button>
                </div>
            </section>
        </div>
    </div> <!-- end semi-transparent wrapper -->
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // Helper function to format numbers with dots
    function formatWithDots(n){
        const num = Math.round(Number(n) || 0);
        return String(num).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    document.addEventListener('DOMContentLoaded', function(){
        // Format prices on page load
        document.querySelectorAll('.format-price').forEach(el => {
            const v = el.getAttribute('data-price');
            if (v == null) return;
            el.textContent = formatWithDots(v);
        });
    });
</script>
</body>
</html>
