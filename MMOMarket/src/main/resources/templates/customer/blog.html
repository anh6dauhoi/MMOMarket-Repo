<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MMO Market - Blog</title>
    <!-- Favicon - Multiple sizes for crisp display -->
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="48x48" th:href="@{/images/logo.png}">
    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/logo.png}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/images/logo.png}">
    <link rel="shortcut icon" type="image/png" th:href="@{/images/logo.png}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" th:href="@{/customer/css/blog.css}">
    <!-- CSRF tokens for AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <style>
        body {
            background: url('/images/home1.jpg') no-repeat center center fixed;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }
        @media (max-width: 640px) {
            body { background-position: top center; }
        }
    </style>
</head>
<body class="font-sans">
<div th:replace="~{fragments/header :: header(active='blog')}"></div>

<!-- Semi-transparent white wrapper for all content -->
<div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
    <div class="bg-white bg-opacity-50 backdrop-blur-sm rounded-2xl p-6 sm:p-8 lg:p-10 shadow-lg">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-5xl font-bold text-gray-800" style="font-family:serif">Blog</h1>
            <!-- removed New Post button -->
        </header>

        <!-- Search Bar -->
        <form method="get" action="#" th:action="@{/blog}" class="relative mb-10">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
            <input id="blogSearch" name="q" type="text" placeholder="Search blog posts"
                   th:value="${query}"
                   class="w-full py-3 pl-12 pr-12 bg-gray-100 border border-gray-200 rounded-lg search-focus placeholder-gray-500"
                   aria-label="Search blog posts" autocomplete="off">
            <!-- Clear (X) button -->
            <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
                <button type="button" id="clearSearchBtn"
                        class="hidden text-gray-400 hover:text-gray-600 p-2"
                        aria-label="Clear search">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>
            <!-- keep current sort and page size -->
            <input type="hidden" name="sort" th:value="${sort}">
            <input type="hidden" name="size" value="10">
        </form>

        <!-- Dropdown for filtering posts -->
        <div class="relative inline-block text-left mb-6">
            <button id="filterDropdownButton" class="btn-primary font-semibold px-5 py-2 rounded-lg text-sm inline-flex items-center gap-2">
                <i class="fa-solid fa-filter"></i>
                <span th:text="${sort} == 'oldest' ? 'Oldest' :
                                (${sort} == 'most-liked' ? 'Most Liked' :
                                (${sort} == 'most-viewed' ? 'Most Viewed' :
                                (${sort} == 'most-commented' ? 'Most Commented' : 'Newest')))">Newest</span>
            </button>
            <div id="filterDropdownMenu" class="absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                <a th:href="@{/blog(sort='newest', q=${query}, size=${10})}"
                   class="block px-4 py-2 text-gray-800 hover:bg-gray-100"
                   th:classappend="${sort} == 'newest' ? ' bg-gray-100 font-semibold' : ''">Newest</a>
                <a th:href="@{/blog(sort='oldest', q=${query}, size=${10})}"
                   class="block px-4 py-2 text-gray-800 hover:bg-gray-100"
                   th:classappend="${sort} == 'oldest' ? ' bg-gray-100 font-semibold' : ''">Oldest</a>
                <div class="border-t my-1"></div>
                <a th:href="@{/blog(sort='most-liked', q=${query}, size=${10})}"
                   class="block px-4 py-2 text-gray-800 hover:bg-gray-100"
                   th:classappend="${sort} == 'most-liked' ? ' bg-gray-100 font-semibold' : ''">Most Liked</a>
                <a th:href="@{/blog(sort='most-viewed', q=${query}, size=${10})}"
                   class="block px-4 py-2 text-gray-800 hover:bg-gray-100"
                   th:classappend="${sort} == 'most-viewed' ? ' bg-gray-100 font-semibold' : ''">Most Viewed</a>
                <a th:href="@{/blog(sort='most-commented', q=${query}, size=${10})}"
                   class="block px-4 py-2 text-gray-800 hover:bg-gray-100"
                   th:classappend="${sort} == 'most-commented' ? ' bg-gray-100 font-semibold' : ''">Most Commented</a>
            </div>
        </div>

        <script>
            // Toggle dropdown visibility + close on outside click
            document.getElementById('filterDropdownButton').addEventListener('click', function (e) {
                const menu = document.getElementById('filterDropdownMenu');
                menu.classList.toggle('hidden');
            });
            document.addEventListener('click', function(e){
                const btn = document.getElementById('filterDropdownButton');
                const menu = document.getElementById('filterDropdownMenu');
                if (!btn || !menu) return;
                if (btn.contains(e.target) || menu.contains(e.target)) return;
                menu.classList.add('hidden');
            });

            // Clear search (X) button behavior
            document.addEventListener('DOMContentLoaded', function () {
                const input = document.getElementById('blogSearch');
                const btn = document.getElementById('clearSearchBtn');
                if (!input || !btn) return;

                const toggle = () => {
                    if (input.value && input.value.trim().length > 0) btn.classList.remove('hidden');
                    else btn.classList.add('hidden');
                };
                toggle();
                input.addEventListener('input', toggle);

                btn.addEventListener('click', () => {
                    input.value = '';
                    toggle();
                    input.focus();
                    // auto-submit to reset the list
                    if (input.form) input.form.submit();
                });
            });
        </script>

        <!-- Blog List -->
        <div id="blogGrid" class="flex flex-col space-y-6">
            <!-- improved empty state -->
            <div th:if="${#lists.isEmpty(posts)}" class="text-center text-gray-500 py-12 bg-white rounded-lg border">
                <div class="text-4xl mb-2">üìù</div>
                <div class="font-semibold mb-1">No posts found</div>
                <div class="text-sm">Try adjusting your search or filters.</div>
            </div>

            <div th:each="post : ${posts}" class="bg-white rounded-lg overflow-hidden card-hover flex flex-col md:flex-row">
                <div class="md:w-1/4 w-full h-48 md:h-32 overflow-hidden post-thumb">
                    <img th:src="${post.image != null ? post.image : '/images/placeholder-600x400.png'}"
                         th:alt="${post.title}" class="w-full h-full object-cover">
                </div>
                <div class="p-5 md:w-3/4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                        <!-- fixed: proper Thymeleaf URL with path variable -->
                        <a th:href="@{/blog/{id}(id=${post.id})}"
                           th:text="${post.title}" class="hover:underline text-gray-800"></a>
                    </h2>
                    <!-- changed: guard substring by checking length first -->
                    <p class="text-gray-600 text-sm mb-4"
                       th:text="${post.content != null ? (post.content.length() > 200 ? post.content.substring(0,200).concat('...') : post.content) : ''}"></p>
                    <div class="flex items-center text-gray-500 text-sm space-x-4">
                        <!-- clickable heart in list; id and onclick added -->
                        <span class="flex items-center">
                            <i th:attr="id=${'list-heart-' + post.id}"
                               class="fas fa-heart heart"
                               th:classappend="${likedBlogIds != null and likedBlogIds.contains(post.id)} ? ' liked' : ''"
                               th:onclick="|toggleBlogLike(${post.id})|"></i>
                            &nbsp;<span th:attr="id=${'list-like-count-' + post.id}"
                                        th:text="${likesMap != null && likesMap.containsKey(post.id) ? likesMap[post.id] : (post.likes != null ? post.likes : 0)}">0</span>
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-eye mr-1.5"></i>
                            <span th:text="${viewsMap != null && viewsMap.containsKey(post.id) ? viewsMap[post.id] : (post.views != null ? post.views : 0)}">0</span>
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-comment mr-1.5"></i>
                            <span th:text="${commentsMap != null && commentsMap.containsKey(post.id) ? commentsMap[post.id] : 0}">0</span>
                        </span>
                        <span class="text-gray-400">‚Ä¢</span>
                        <span class="text-gray-400 text-xs"
                              th:text="${post.createdAt != null ? #dates.format(post.createdAt, 'dd MMM yyyy') : 'New'}">date</span>
                    </div>
                </div>
            </div>
        </div> <!-- end #blogGrid -->

        <!-- Pagination (10 per page) -->
        <nav class="mt-8 flex justify-center" th:if="${totalPages >= 1}">
            <ul class="inline-flex items-center gap-1">
                <li>
                    <a th:if="${currentPage > 0}"
                       th:href="@{/blog(page=${currentPage - 1}, size=${10}, q=${query}, sort=${sort})}"
                       class="px-3 py-2 rounded border hover:bg-gray-100">Prev</a>
                    <span th:unless="${currentPage > 0}" class="px-3 py-2 rounded border text-gray-400 cursor-not-allowed">Prev</span>
                </li>
                <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:if="${i != currentPage}"
                       th:href="@{/blog(page=${i}, size=${10}, q=${query}, sort=${sort})}"
                       th:text="${i + 1}"
                       class="px-3 py-2 rounded border hover:bg-gray-100"></a>
                    <span th:if="${i == currentPage}"
                          th:text="${i + 1}"
                          class="px-3 py-2 rounded border bg-red-50 text-red-600 font-semibold"></span>
                </li>
                <li>
                    <a th:if="${currentPage + 1 < totalPages}"
                       th:href="@{/blog(page=${currentPage + 1}, size=${10}, q=${query}, sort=${sort})}"
                       class="px-3 py-2 rounded border hover:bg-gray-100">Next</a>
                    <span th:unless="${currentPage + 1 < totalPages}" class="px-3 py-2 rounded border text-gray-400 cursor-not-allowed">Next</span>
                </li>
            </ul>
        </nav>
    </div> <!-- end semi-transparent wrapper -->
</div> <!-- end container -->

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- removed: New Blog Modal and Toast -->

<script th:inline="javascript">
    // Initialize to the next page after the server-rendered page to avoid duplicating page 0.
    // Model attribute 'currentPage' is set in the controller (posts.getNumber()).
    // carry current query and sort into infinite scroll
    var currentPage = /*[[${currentPage} + 1]]*/ 1;
    const pageSize = 10;
    var isLoading = false;
    var currentQuery = /*[[${query}]]*/ '';
    var currentSort = /*[[${sort}]]*/ 'newest';
    // Disable infinite scroll by default when using pagination (set to true to re-enable)
    var enableInfinite = false;

    // Function to load more blogs
    function loadMoreBlogs() {
        if (!enableInfinite || isLoading) return;
        isLoading = true;

        // show skeletons while loading
        showSkeletons(3);

        const q = encodeURIComponent(currentQuery || '');
        const s = encodeURIComponent(currentSort || 'newest');

        fetch(`/blog/infinite?page=${currentPage}&size=${pageSize}&q=${q}&sort=${s}`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then((response) => response.json())
            .then((data) => {
                if (data && data.content && data.content.length > 0) {
                    appendBlogsToGrid(data.content);
                    currentPage++;
                }
            })
            .catch(err => console.error('Failed to load more blogs:', err))
            .finally(() => {
                removeSkeletons();
                isLoading = false;
            });
    }

    // Append blogs to the grid
    function appendBlogsToGrid(blogs) {
        const grid = document.getElementById('blogGrid');
        blogs.forEach(blog => {
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white rounded-lg overflow-hidden card-hover flex flex-col md:flex-row';
            wrapper.innerHTML = `
                <div class="md:w-1/4 w-full h-48 md:h-32 overflow-hidden post-thumb">
                    <img src="${blog.image || '/images/placeholder-600x400.png'}" alt="${blog.title}" class="w-full h-full object-cover">
                </div>
                <div class="p-5 md:w-3/4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                        <a href="/blog/${blog.id}" class="hover:underline text-gray-800">${blog.title}</a>
                    </h2>
                    <p class="text-gray-600 text-sm mb-4">${(blog.content || '').slice(0, 200)}${(blog.content && blog.content.length > 200) ? '...' : ''}</p>
                    <div class="flex items-center text-gray-500 text-sm space-x-4">
                        <span class="flex items-center">
                            <i class="fas fa-heart heart ${blog.liked ? 'liked' : ''}"></i>
                            &nbsp;<span>${blog.likes != null ? blog.likes : 0}</span>
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-eye mr-1.5"></i>
                            <span>${blog.views != null ? blog.views : 0}</span>
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-comment mr-1.5"></i>
                            <span>${blog.comments != null ? blog.comments : 0}</span>
                        </span>
                    </div>
                </div>
            `;
            grid.appendChild(wrapper);
        });
    }

    function showSkeletons(count) {
        const grid = document.getElementById('blogGrid');
        for (let i = 0; i < count; i++) {
            const sk = document.createElement('div');
            sk.className = 'bg-white rounded-lg border p-6 animate-pulse';
            sk.innerHTML = '<div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>' +
                '<div class="space-y-2">' +
                '  <div class="h-4 bg-gray-200 rounded"></div>' +
                '  <div class="h-4 bg-gray-200 rounded w-5/6"></div>' +
                '</div>';
            sk.setAttribute('data-skeleton', 'true');
            grid.appendChild(sk);
        }
    }

    function removeSkeletons() {
        document.querySelectorAll('[data-skeleton="true"]').forEach(el => el.remove());
    }

    // like blog from list
    function toggleBlogLike(blogId) {
        fetch('/blog/' + blogId + '/like', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => r.json())
            .then(data => {
                const heart = document.getElementById('list-heart-' + blogId);
                const countEl = document.getElementById('list-like-count-' + blogId);
                if (heart && data && typeof data.liked === 'boolean') {
                    heart.classList.toggle('liked', data.liked);
                }
                if (countEl && data && typeof data.count === 'number') {
                    countEl.textContent = data.count;
                }
            })
            .catch(console.error);
    }
</script>
</body>
</html>
