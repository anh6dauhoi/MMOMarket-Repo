<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>MMO Market - Product Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/tailwind-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-wrap { overflow-x: auto; }
        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
        .badge-sm { padding: 2px 6px; }
        .cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tn { font-variant-numeric: tabular-nums; }
    </style>
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
</head>
<body class="flex flex-col min-h-screen text-gray-800">
<div th:replace="~{fragments/header :: header}"></div>

<main class="flex-grow py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar -->
            <div th:replace="~{seller/sidebar :: sidebar}"></div>

            <!-- Main Content -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
                    <!-- Header: Title left, Add Product right -->
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 flex items-center">
                            <i class="fas fa-boxes-stacked mr-3 text-red-600"></i>
                            Product Management
                        </h1>
                        <button type="button" id="addProductBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white shadow">
                            <i class="fa-solid fa-plus"></i>
                            <span>Add Product</span>
                        </button>
                    </div>

                    <!-- Filters bar under title -->
                    <div class="mb-5 p-3 rounded-xl border border-red-100 bg-red-50/50">
                        <div class="flex flex-col gap-3">
                            <div class="w-full sm:w-96">
                                <label class="sr-only" for="pmSearch">Search products</label>
                                <div class="relative">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-red-400"></i>
                                    <input id="pmSearch" type="text" placeholder="Search products..." class="w-full pl-10 pr-3 py-2 rounded-xl border border-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white" oninput="filterProducts()"/>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="w-full sm:w-64">
                        <label for="statusFilter" class="sr-only">Status</label>
                        <select id="statusFilter" class="w-full px-3 py-2 rounded-xl border border-red-200 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500" onchange="applyStatusFilter()" th:value="${status}">
                            <option value="active" th:selected="${status}=='active'">Active</option>
                            <option value="hidden" th:selected="${status}=='hidden'">Hidden</option>
                            <option value="all" th:selected="${status}=='all'">All</option>
                        </select>
                    </div>

                    <!-- Flash area -->
                    <div id="alertBox" class="hidden mb-4 p-3 rounded border"></div>

                    <div class="table-wrap">
                        <table class="table-auto w-full bg-white border border-gray-200 rounded-lg text-sm">
                            <colgroup>
                                <col> <!-- Product takes remaining space -->
                                <col style="width:1%"> <!-- Category minimal -->
                                <col style="width:1%"> <!-- Variants minimal -->
                                <col style="width:1%"> <!-- Price minimal -->
                                <col style="width:1%"> <!-- Sold minimal -->
                                <col style="width:1%"> <!-- Status minimal -->
                                <col style="width:1%"> <!-- Actions minimal -->
                            </colgroup>
                            <thead>
                            <tr class="bg-gradient-to-r from-red-500 to-rose-600 text-white">
                                <th class="px-2 py-2 h-10 whitespace-nowrap text-left text-xs font-semibold align-middle">Product</th>
                                <th class="px-2 py-2 h-10 whitespace-nowrap text-left text-xs font-semibold align-middle">Category</th>
                                <th class="px-2 py-2 h-10 whitespace-nowrap text-center text-xs font-semibold align-middle">Variants</th>
                                <th class="px-6 py-2 h-10 whitespace-nowrap text-right text-xs font-semibold align-middle">
                                    <a th:with="isPriceAsc=${sortPrice}=='asc',
                                                isPriceDesc=${sortPrice}=='desc',
                                                nextSort=${isPriceAsc} ? 'desc' : 'asc',
                                                sortUrl=@{'/seller/product-management'(sortPrice=${nextSort}, status=${status})}"
                                       th:href="${sortUrl}"
                                       class="inline-flex items-center gap-1 hover:text-white cursor-pointer">
                                        <span>Price</span>
                                        <span class="inline-flex flex-col text-xs leading-none">
                                            <i class="fas fa-caret-up" th:classappend="${isPriceAsc} ? ' text-white' : ' text-white/80'"></i>
                                            <i class="fas fa-caret-down -mt-1" th:classappend="${isPriceDesc} ? ' text-white' : ' text-white/80'"></i>
                                        </span>
                                    </a>
                                </th>
                                <th class="pl-2 pr-3 py-2 h-10 whitespace-nowrap text-right text-xs font-semibold align-middle">Sold</th>
                                <th class="px-2 py-2 h-10 whitespace-nowrap text-center text-xs font-semibold align-middle">Status</th>
                                <th class="px-7 py-2 h-10 whitespace-nowrap text-right text-xs font-semibold align-middle">Actions</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="productTbody">
                            <tr th:each="p : ${products}" th:classappend="${p.isDelete} ? 'opacity-60' : ''" th:attr="data-id=${p.id}">
                                <td class="px-2 py-2 align-middle">
                                    <div class="flex items-center gap-2">
                                        <img th:src="${p.image != null ? p.image : '/images/default-avatar.svg'}" alt="thumb" class="w-10 h-10 object-cover rounded border"/>
                                        <div class="min-w-0" th:title="${p.name}">
                                            <div class="font-semibold text-gray-900 truncate" th:text="${p.name}">Product name</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-2 py-2 cell align-middle" th:title="${p.category != null ? p.category.name : '—'}">
                                    <span class="text-sm" th:text="${p.category != null ? p.category.name : '—'}">—</span>
                                </td>
                                <td class="px-2 py-2 text-center align-middle whitespace-nowrap">
                                    <span class="text-xs font-semibold inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-50 text-blue-700">
                                        <i class="fa-solid fa-layer-group"></i>
                                        <span th:text="${p.variantCount}">0</span>
                                    </span>
                                </td>
                                <td class="pl-2 pr-3 py-2 text-right align-middle whitespace-nowrap" th:title="${#numbers.formatInteger(p.lowestPrice, 0, 'COMMA')}">
                                    <span class="text-sm font-semibold text-emerald-600 tn" th:text="${#numbers.formatInteger(p.lowestPrice, 0, 'COMMA') }">0</span>
                                </td>
                                <td class="pl-2 pr-3 py-2 text-right align-middle whitespace-nowrap" th:title="${#numbers.formatInteger(p.totalSold, 0, 'COMMA')}">
                                    <span class="text-sm tn" th:text="${#numbers.formatInteger(p.totalSold, 0, 'COMMA')}">0</span>
                                </td>
                                <td class="px-2 py-2 text-center align-middle whitespace-nowrap">
                                    <span th:classappend="${!p.isDelete} ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'" class="badge badge-sm">
                                        <i th:classappend="${!p.isDelete} ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash'"></i>
                                        <span th:text="${!p.isDelete} ? 'Active' : 'Hidden'">Active</span>
                                    </span>
                                </td>
                                <td class="px-2 py-2 text-right whitespace-nowrap align-middle">
                                    <div class="inline-flex items-center gap-1.5">
                                        <!-- Link to seller product detail page (opens within seller area) -->
                                        <a class="p-1.5 rounded hover:bg-red-50 text-red-600 inline-flex items-center" th:href="@{'/seller/products/' + ${p.id} + '/detail'}" title="Details">
                                            <i class="fa-regular fa-eye"></i>
                                        </a>
                                        <button type="button" class="p-1.5 rounded hover:bg-red-50 text-red-600" th:attr="data-id=${p.id}" onclick="openEditModal(this)" title="Edit">
                                            <i class="fa-regular fa-pen-to-square"></i>
                                        </button>
                                        <button type="button" class="p-1.5 rounded hover:bg-gray-100 text-gray-700" th:attr="data-id=${p.id}" onclick="toggleHide(this)" title="Hide/Show">
                                            <i class="fa-solid fa-eye-slash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${products == null or #lists.isEmpty(products)}">
                                <td colspan="7" class="px-3 py-6 text-center text-gray-500">No products yet</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination (transaction-management style) -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-3 sm:space-y-0"
                         th:with="sortParam=${sortPrice != null and sortPrice != '' ? '&sortPrice=' + sortPrice : ''},
                                  statusParam=${status != null and status != '' ? '&status=' + status : ''},
                                  page0=${currentPage != null ? currentPage - 1 : 0},
                                  total=${totalPages != null and totalPages > 0 ? totalPages : 1}">

                        <div class="text-sm text-gray-700 text-center sm:text-left">
                            <span th:with="s=${startItem != null ? startItem : (totalItems > 0 ? 1 : 0)}, e=${endItem != null ? endItem : (totalItems > 0 ? (pageSize != null ? ( (currentPage != null ? ((currentPage -1) * pageSize + 1) : 1) + ( (totalItems < pageSize) ? (totalItems -1) : (pageSize -1) ) ) : totalItems) : 0)}">
                                <span th:text="${totalItems == 0 ? 'Showing 0 of 0 results' : 'Showing ' + s + ' to ' + e + ' of ' + totalItems + ' results'}">Showing 0 to 0 of 0 results</span>
                            </span>
                        </div>

                        <div class="flex space-x-1 flex-wrap justify-center">
                            <a class="px-2 sm:px-3 py-1 border rounded-md hover:bg-gray-100"
                               th:with="url='/seller/product-management?page=' + ${currentPage > 1 ? (currentPage - 1) : 1} + ${statusParam} + ${sortParam}"
                               th:href="${url}"
                               th:if="${currentPage > 1}">Previous</a>

                            <a class="px-2 sm:px-3 py-1 border rounded-md"
                               th:each="i : ${#numbers.sequence(0, total - 1)}"
                               th:with="url='/seller/product-management?page=' + (${i} + 1) + ${statusParam} + ${sortParam}"
                               th:href="${url}"
                               th:if="${i == 0 or i == page0 or i == page0 - 1 or i == page0 + 1 or i == total - 1}"
                               th:classappend="${i == page0} ? 'bg-green-500 text-white' : 'hover:bg-gray-100'"
                               th:text="${i + 1}">1</a>

                            <a class="px-2 sm:px-3 py-1 border rounded-md hover:bg-gray-100"
                               th:with="url='/seller/product-management?page=' + (${currentPage < total ? (currentPage + 1) : total}) + ${statusParam} + ${sortParam}"
                               th:href="${url}"
                               th:if="${currentPage < total}">Next</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden CSRF carrier form -->
    <form id="csrfForm" class="hidden">
        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
    </form>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Edit Product Modal -->
<div id="editModal" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[85vh] overflow-hidden flex flex-col">
        <div class="px-6 py-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">
                <i class="fa-regular fa-pen-to-square text-red-500 mr-2"></i>
                <span id="epTitleText">Add Product</span>
            </h3>
            <button class="text-2xl leading-none text-gray-400 hover:text-red-500" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="p-6 flex-1 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700" for="epName">Name</label>
                    <input id="epName" type="text" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="Product name"/>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700" for="epCategory">Category</label>
                    <select id="epCategory" class="mt-1 w-full border rounded-lg px-3 py-2">
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-semibold text-gray-700" for="epDesc">Description</label>
                    <textarea id="epDesc" rows="5" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="Product description..."></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-semibold text-gray-700" for="epImageFile">Upload image</label>
                    <input id="epImageFile" type="file" accept="image/png,image/jpeg,image/jpg,image/webp" class="mt-1 w-full border rounded-lg px-3 py-2"/>
                    <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG, WEBP. Max 10MB.</p>
                    <img id="epPreview" src="" alt="preview" class="w-full h-56 object-contain rounded border bg-gray-50 mt-3 hidden"/>
                </div>
                <!-- Hidden image URL field: store final image URL here -->
                <input id="epImageUrl" type="hidden" />
                <div class="md:col-span-2 flex items-center justify-end">
                    <!-- keep layout consistent (no separate upload button) -->
                </div>
            </div>
            <div id="epMsg" class="mt-3 text-sm"></div>
        </div>
        <div class="px-6 py-4 border-t flex items-center justify-end gap-2">
            <button type="button" class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200" onclick="closeEditModal()">Cancel</button>
            <button type="button" id="epSaveBtn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Save</button>
        </div>
    </div>
</div>

<!-- product-detail is a separate full page now at /seller/products/{id}/detail -->

<!-- Toast container -->
<div id="toastHost" class="fixed top-4 right-4 z-[100] w-80 max-w-[92vw] space-y-3 pointer-events-none"></div>

<script>
    // CSRF helpers
    function getCookie(name) {
        const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\/\\+^])/g, '\\$1') + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
    }
    function getCsrf() {
        let token = null, headerName = 'X-CSRF-TOKEN';
        const form = document.getElementById('csrfForm');
        if (form) {
            const i = form.querySelector('input[type="hidden"]');
            if (i && i.value) token = i.value;
        }
        if (!token) {
            const meta = document.querySelector('meta[name="_csrf"]');
            if (meta && meta.content) token = meta.content;
        }
        const metaHeader = document.querySelector('meta[name="_csrf_header"]');
        if (metaHeader && metaHeader.content) headerName = metaHeader.content;
        if (!token) token = getCookie('XSRF-TOKEN') || getCookie('xsrf-token');
        return { value: token, headerName };
    }
    function csrfHeaders() {
        const c = getCsrf();
        const h = {};
        if (c.value) {
            h[c.headerName] = c.value;
            h['X-CSRF-TOKEN'] = c.value;
            h['X-XSRF-TOKEN'] = c.value;
        }
        return h;
    }

    // Toast helper
    function showToast(message, type = 'info', opts = {}) {
        if (!message) return;
        const host = document.getElementById('toastHost');
        if (!host) return;
        const theme = {
            success: { bar:'bg-green-500', icon:'fa-solid fa-circle-check text-green-600', title:'Success' },
            error:   { bar:'bg-red-500',   icon:'fa-solid fa-triangle-exclamation text-red-600', title:'Error' },
            warning: { bar:'bg-amber-500', icon:'fa-solid fa-circle-exclamation text-amber-600', title:'Warning' },
            info:    { bar:'bg-blue-500',  icon:'fa-solid fa-circle-info text-blue-600', title:'Info' }
        }[type] || { bar:'bg-gray-500', icon:'fa-regular fa-bell text-gray-600', title:'Notice' };
        const wrap = document.createElement('div');
        wrap.className = 'pointer-events-auto flex items-start gap-3 bg-white shadow-xl rounded-xl border border-gray-100 relative overflow-hidden transform transition-all duration-300 translate-x-4 opacity-0';
        const bar = document.createElement('div'); bar.className = 'w-1 ' + theme.bar; wrap.appendChild(bar);
        const inner = document.createElement('div'); inner.className = 'p-3 pr-8';
        inner.innerHTML = `<div class="flex items-start gap-2">
            <i class="${theme.icon} mt-0.5"></i>
            <div class="min-w-0">
                <div class="text-sm font-semibold text-gray-900">${theme.title}</div>
                <div class="text-sm text-gray-700 break-words">${message}</div>
            </div>
        </div>`;
        wrap.appendChild(inner);
        const closeBtn = document.createElement('button'); closeBtn.className = 'absolute top-2 right-2 text-gray-400 hover:text-gray-600'; closeBtn.innerHTML = '&times;'; closeBtn.onclick = () => dismiss(); wrap.appendChild(closeBtn);
        host.appendChild(wrap);
        requestAnimationFrame(() => { wrap.classList.remove('translate-x-4','opacity-0'); wrap.classList.add('translate-x-0','opacity-100'); });
        const ttl = opts.ttl || (type === 'error' ? 5000 : 3200);
        let timer = setTimeout(() => dismiss(), ttl);
        wrap.addEventListener('mouseenter', () => { if (timer) { clearTimeout(timer); timer = null; } });
        wrap.addEventListener('mouseleave', () => { if (!timer) { timer = setTimeout(() => dismiss(), 1800); } });
        function dismiss(){ wrap.classList.add('opacity-0','translate-x-4'); setTimeout(()=>{ try{ host.removeChild(wrap);}catch(_){ } },200); }
    }

    // Backward compat helper -> toast
    function alertMsg(text, ok) { if (!text) return; showToast(text, ok ? 'success' : 'error'); }

    // Client-side filter by product name
    function filterProducts() {
        const q = (document.getElementById('pmSearch')?.value || '').toLowerCase().trim();
        const rows = document.querySelectorAll('#productTbody tr[data-id]');
        rows.forEach(r => {
            const nameEl = r.querySelector('td:nth-child(1) .font-semibold');
            const name = (nameEl?.textContent || '').toLowerCase();
            r.style.display = q && !name.includes(q) ? 'none' : '';
        });
    }

    let editingId = null;
    async function openEditModal(btn) {
        const id = btn?.getAttribute('data-id'); if (!id) return; editingId = id;
        try {
            const res = await fetch('/seller/products/' + encodeURIComponent(id) + '/json', { method: 'GET' });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            document.getElementById('epName').value = data.name || '';
            document.getElementById('epDesc').value = data.description || '';
            // set hidden image url and preview
            const imageHidden = document.getElementById('epImageUrl'); if (imageHidden) imageHidden.value = data.image || '';
            const prev = document.getElementById('epPreview'); if (prev) { if (data.image) { prev.src = data.image; prev.classList.remove('hidden'); } else { prev.src=''; prev.classList.add('hidden'); } }
            const catSel = document.getElementById('epCategory'); if (data.categoryId && catSel) { catSel.value = String(data.categoryId); }
            const file = document.getElementById('epImageFile'); if (file) { try { file.value=''; } catch(_){} }
            const title = document.getElementById('epTitleText'); if (title) title.textContent = 'Edit Product';
            const save = document.getElementById('epSaveBtn'); if (save) save.textContent = 'Save';
            document.getElementById('epMsg').textContent = '';
            document.getElementById('editModal').classList.remove('hidden');
        } catch (e) { showToast('Failed to load product data.', 'error'); }
    }
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        const prev = document.getElementById('epPreview'); if (prev) { prev.src=''; prev.classList.add('hidden'); }
        const imageHidden = document.getElementById('epImageUrl'); if (imageHidden) imageHidden.value = '';
        editingId = null;
    }

    function applyStatusFilter() {
        const sel = document.getElementById('statusFilter'); const status = sel ? sel.value : '';
        const params = new URLSearchParams(window.location.search); if (status) params.set('status', status); else params.delete('status');
        const qs = params.toString(); window.location.assign(window.location.pathname + (qs ? ('?' + qs) : ''));
    }

    // Add Product (create mode)
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        addBtn.addEventListener('click', function() {
            editingId = null;
            document.getElementById('epName').value = '';
            document.getElementById('epDesc').value = '';
            const imageHidden = document.getElementById('epImageUrl'); if (imageHidden) imageHidden.value = '';
            const catSel = document.getElementById('epCategory'); if (catSel) catSel.selectedIndex = 0;
            const prev = document.getElementById('epPreview'); if (prev) { prev.src=''; prev.classList.add('hidden'); }
            const file = document.getElementById('epImageFile'); if (file) { try { file.value=''; } catch(_){} }
            const title = document.getElementById('epTitleText'); if (title) title.textContent = 'Add Product';
            const save = document.getElementById('epSaveBtn'); if (save) save.textContent = 'Create';
            document.getElementById('epMsg').textContent = '';
            document.getElementById('editModal').classList.remove('hidden');
        });
    }

    // Inline field validation helpers
    function clearFieldErrors() { /* no inline fields visible; rely on toast only */ }
    function setFieldError(id, message) { if (message) showToast(message, 'error'); }
    function validateFormFields(values) {
        let ok = true; const name = (values.name||'').trim();
        if (!name) { setFieldError('errName','Name is required'); ok=false; }
        else if (name.length < 3) { setFieldError('errName','Name must be at least 3 characters'); ok=false; }
        else if (name.length > 255) { setFieldError('errName','Name must be at most 255 characters'); ok=false; }
        const catId = values.categoryId; if (!catId) { setFieldError('errCategory','Category is required'); ok=false; }
        const image = (values.image||'').trim();
        if (image) {
            if (image.length > 255) { setFieldError('errImage','Image URL must be at most 255 characters'); ok=false; }
            const lower = image.toLowerCase();
            const okPrefix = lower.startsWith('http://') || lower.startsWith('https://') || lower.startsWith('/');
            const okExt = /\.(png|jpe?g|webp)(\?.*)?$/.test(lower);
            if (!okPrefix || !okExt) { setFieldError('errImage','Image URL must be http(s) or site-relative and end with .png/.jpg/.jpeg/.webp'); ok=false; }
        }
        const desc = (values.description||''); if (desc.length > 5000) { setFieldError('errDesc','Description must be at most 5000 characters'); ok=false; }
        return ok;
    }

    // Busy state
    function setBusy(el, busy, textWhileBusy) {
        if (!el) return; el.disabled = !!busy;
        if (busy) { el.dataset._oldText = el.textContent; el.textContent = textWhileBusy || 'Processing...'; el.classList.add('opacity-70','cursor-not-allowed'); }
        else { if (el.dataset._oldText) el.textContent = el.dataset._oldText; el.classList.remove('opacity-70','cursor-not-allowed'); }
    }

    // Save (create/edit) — automatically upload selected image file (if any) before sending create/edit request
    const epSaveBtn = document.getElementById('epSaveBtn');
    epSaveBtn.addEventListener('click', async function () {
        const name = document.getElementById('epName').value.trim();
        const description = document.getElementById('epDesc').value.trim();
        const categoryId = document.getElementById('epCategory').value;
        // image URL is stored in hidden field epImageUrl; we'll override it if user selected a new file
        const imageHidden = document.getElementById('epImageUrl');
        const currentImageUrl = imageHidden ? (imageHidden.value || '').trim() : '';
        const payload = { name, description, image: currentImageUrl, categoryId };
        if (!validateFormFields(payload)) { showToast('Please fix the highlighted errors.', 'error'); return; }
        const headers = Object.assign({ 'Content-Type': 'application/json' }, csrfHeaders());
        setBusy(epSaveBtn, true, editingId ? 'Saving...' : 'Creating...');
        try {
            // If user has selected a file, upload it first and set payload.image to returned url
            const file = document.getElementById('epImageFile')?.files?.[0];
            if (file) {
                // Validate file client-side again
                if (!/^image\/(png|jpe?g|webp)$/i.test(file.type)) { showToast('Only PNG, JPG, JPEG, WEBP are allowed', 'error'); setBusy(epSaveBtn, false); return; }
                if (file.size > 10 * 1024 * 1024) { showToast('File too large (max 10MB)', 'error'); setBusy(epSaveBtn, false); return; }
                const data = new FormData(); data.append('file', file);
                // perform upload
                const upRes = await fetch('/seller/products/upload-image', { method: 'POST', headers: csrfHeaders(), body: data, credentials: 'same-origin' });
                let upPayload = null; try { upPayload = await upRes.json(); } catch(_) { try { upPayload = JSON.parse(await upRes.text()); } catch(_) { upPayload = null; } }
                if (!upRes.ok || !(upPayload && upPayload.url)) {
                    showToast((upPayload && (upPayload.message || upPayload.error || upPayload.url)) || 'Upload failed', 'error'); setBusy(epSaveBtn, false); return;
                }
                payload.image = upPayload.url;
                // update hidden field and preview
                if (imageHidden) imageHidden.value = upPayload.url;
                const prev = document.getElementById('epPreview'); if (prev) { prev.src = upPayload.url; prev.classList.remove('hidden'); }
            }

            const url = editingId ? ('/seller/products/' + encodeURIComponent(editingId) + '/edit') : '/seller/products';
            const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload), credentials: 'same-origin' });
            const text = await res.text();
            let data = null; try { data = JSON.parse(text); } catch(_){ }
            if (!res.ok) {
                const fe = data && data.fieldErrors ? data.fieldErrors : null;
                if (fe) {
                    if (fe.name) setFieldError('errName', fe.name);
                    if (fe.categoryId) setFieldError('errCategory', fe.categoryId);
                    if (fe.image) setFieldError('errImage', fe.image);
                    if (fe.description) setFieldError('errDesc', fe.description);
                    showToast(data.message || 'Validation failed', 'error');
                } else {
                    showToast((data && data.message) || text || 'Request failed', 'error');
                }
                return;
            }
            showToast((data && data.message) || (editingId ? 'Updated successfully' : 'Created successfully'), 'success');
            setTimeout(() => window.location.reload(), 600);
        } catch (e) { showToast('Network error', 'error'); }
        finally { setBusy(epSaveBtn, false); }
    });

    // Image preview on file select
    const epImageFile = document.getElementById('epImageFile');
    const epPreview = document.getElementById('epPreview');
    let epTempPreviewUrl = null;

    if (epImageFile) {
        epImageFile.addEventListener('change', function () {
            const file = epImageFile.files?.[0]; if (!file) return;
            if (!/^image\/(png|jpe?g|webp)$/i.test(file.type)) { showToast('Only PNG, JPG, JPEG, WEBP are allowed', 'error'); epImageFile.value=''; return; }
            if (file.size > 10 * 1024 * 1024) { showToast('File too large (max 10MB)', 'error'); epImageFile.value=''; return; }
            if (epTempPreviewUrl) { try { URL.revokeObjectURL(epTempPreviewUrl); } catch(_){} epTempPreviewUrl = null; }
            const url = URL.createObjectURL(file); epTempPreviewUrl = url; epPreview.src = url; epPreview.classList.remove('hidden');
            showToast('Image ready — it will be uploaded automatically when you click Create/Save.', 'info');
        });
    }

    // Toggle hide/show
    async function toggleHide(btn) {
        const id = btn?.getAttribute('data-id'); if (!id) return;
        try {
            const res = await fetch('/seller/products/' + encodeURIComponent(id) + '/toggle-hide', { method: 'POST', headers: csrfHeaders(), credentials: 'same-origin' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) { showToast('Unable to update product status', 'error'); return; }
            const row = document.querySelector('tr[data-id="' + id + '"]');
            if (row) {
                const badge = row.querySelector('td:nth-child(6) .badge');
                if (badge) {
                    if (data.hidden) {
                        badge.classList.remove('bg-green-100','text-green-700');
                        badge.classList.add('bg-gray-200','text-gray-700');
                        const span = badge.querySelector('span'); if (span) span.textContent = 'Hidden';
                        const icon = badge.querySelector('i'); if (icon) icon.className = 'fa-solid fa-eye-slash';
                        row.classList.add('opacity-60');
                    } else {
                        badge.classList.remove('bg-gray-200','text-gray-700');
                        badge.classList.add('bg-green-100','text-green-700');
                        const span = badge.querySelector('span'); if (span) span.textContent = 'Active';
                        const icon = badge.querySelector('i'); if (icon) icon.className = 'fa-solid fa-eye';
                        row.classList.remove('opacity-60');
                    }
                }
            }
            showToast('Product status updated', 'success');
        } catch (e) { showToast('Network error', 'error'); }
    }

    <!-- product detail modal and JS provided by fragment seller/product-detail :: productDetailModal -->
</script>
</body>
</html>
