<!-- Admin Dashboard content fragment -->
<div th:fragment="content" class="space-y-6">
    <!-- Header: Title + Filters -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-semibold text-gray-800">Admin Dashboard</h2>
            <p class="text-sm text-gray-500">Overview of the platform statistics and top performers.</p>
        </div>

        <form id="filterForm" th:action="@{/admin}" method="get" class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 bg-white p-2 rounded shadow-sm">
                <label class="text-xs text-gray-600" for="from">From</label>
                <input id="from" type="date" name="from" th:value="${from}" class="border rounded px-2 py-1 text-sm"/>
                <label class="text-xs text-gray-600" for="to">To</label>
                <input id="to" type="date" name="to" th:value="${to}" class="border rounded px-2 py-1 text-sm"/>
            </div>

            <div class="flex items-center space-x-2">
                <button type="button" data-range="week" class="quick-range px-3 py-1 bg-white rounded shadow-sm text-sm">Week</button>
                <button type="button" data-range="month" class="quick-range px-3 py-1 bg-white rounded shadow-sm text-sm">Month</button>
                <button type="button" data-range="year" class="quick-range px-3 py-1 bg-white rounded shadow-sm text-sm">Year</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Apply</button>
                <a th:href="@{/admin}" class="px-4 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">Reset</a>
            </div>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded shadow p-4">
            <div class="text-sm text-gray-500">Total Transactions</div>
            <div class="text-2xl font-bold text-gray-800" th:text="${totals != null ? totals.totalTransactions : 0}">0</div>
        </div>
        <div class="bg-white rounded shadow p-4">
            <div class="text-sm text-gray-500">Total Revenue</div>
            <div class="text-2xl font-bold text-gray-800">$<span th:text="${totals != null ? totals.totalRevenue : 0}">0</span></div>
        </div>
        <div class="bg-white rounded shadow p-4">
            <div class="text-sm text-gray-500">Total Users</div>
            <div class="text-2xl font-bold text-gray-800" th:text="${totals != null ? totals.totalUsers : 0}">0</div>
        </div>
        <div class="bg-white rounded shadow p-4">
            <div class="text-sm text-gray-500">Point Revenue</div>
            <div class="text-2xl font-bold text-gray-800">$<span th:text="${totals != null ? totals.pointRevenue : 0}">0</span></div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium text-gray-800">Revenue Over Time</h3>
                <span class="text-sm text-gray-500">Growth</span>
            </div>
            <canvas id="revenueChart" height="180"></canvas>
        </div>

        <div class="bg-white rounded shadow p-4">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Top Sellers (by revenue)</h3>
            <canvas id="topSellersChart" height="180"></canvas>
        </div>

        <div class="bg-white rounded shadow p-4">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Top Products (by sold)</h3>
            <canvas id="topProductsChart" height="180"></canvas>
        </div>
    </div>

    <!-- Top 5 Tables -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-800">Top 5 Sellers</h3>
                <span class="text-sm text-gray-500">By total revenue & rating</span>
            </div>
            <div class="overflow-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                    <tr>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Seller</th>
                        <th class="px-3 py-2">Revenue</th>
                        <th class="px-3 py-2">Avg Rating</th>
                        <th class="px-3 py-2">Transactions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s, stat : ${topSellers}">
                        <td class="px-3 py-2" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-2" th:text="${s.sellerName}">Seller A</td>
                        <td class="px-3 py-2">$<span th:text="${s.revenue}">0</span></td>
                        <td class="px-3 py-2" th:text="${s.avgRating}">0</td>
                        <td class="px-3 py-2" th:text="${s.transactionCount}">0</td>
                    </tr>
                    <tr th:if="${topSellers == null or #lists.isEmpty(topSellers)}">
                        <td class="px-3 py-4 text-center" colspan="5">No data available</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-800">Top 5 Products</h3>
                <span class="text-sm text-gray-500">By sold quantity</span>
            </div>
            <div class="overflow-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                    <tr>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Product</th>
                        <th class="px-3 py-2">Sold</th>
                        <th class="px-3 py-2">Revenue</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, stat : ${topProducts}">
                        <td class="px-3 py-2" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-2" th:text="${p.productName}">Product A</td>
                        <td class="px-3 py-2" th:text="${p.soldCount}">0</td>
                        <td class="px-3 py-2">$<span th:text="${p.revenue}">0</span></td>
                    </tr>
                    <tr th:if="${topProducts == null or #lists.isEmpty(topProducts)}">
                        <td class="px-3 py-4 text-center" colspan="4">No data available</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-800">Top 5 Point Purchases</h3>
                <span class="text-sm text-gray-500">By revenue</span>
            </div>
            <div class="overflow-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                    <tr>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Buyer</th>
                        <th class="px-3 py-2">Amount</th>
                        <th class="px-3 py-2">Date</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="pp, stat : ${topPointPurchases}">
                        <td class="px-3 py-2" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-2" th:text="${pp.buyerName}">Buyer A</td>
                        <td class="px-3 py-2">$<span th:text="${pp.amount}">0</span></td>
                        <td class="px-3 py-2" th:text="${pp.date}">2025-01-01</td>
                    </tr>
                    <tr th:if="${topPointPurchases == null or #lists.isEmpty(topPointPurchases)}">
                        <td class="px-3 py-4 text-center" colspan="4">No data available</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-800">Top 5 Buyers</h3>
                <span class="text-sm text-gray-500">By total purchased</span>
            </div>
            <div class="overflow-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                    <tr>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Buyer</th>
                        <th class="px-3 py-2">Total Spent</th>
                        <th class="px-3 py-2">Transactions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="b, stat : ${topBuyers}">
                        <td class="px-3 py-2" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-2" th:text="${b.buyerName}">Buyer A</td>
                        <td class="px-3 py-2">$<span th:text="${b.totalSpent}">0</span></td>
                        <td class="px-3 py-2" th:text="${b.transactionCount}">0</td>
                    </tr>
                    <tr th:if="${topBuyers == null or #lists.isEmpty(topBuyers)}">
                        <td class="px-3 py-4 text-center" colspan="4">No data available</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Optional growth summary / notes -->
    <div class="flex items-center justify-between bg-white rounded shadow p-4">
        <div>
            <h4 class="text-lg font-medium text-gray-800">Notes</h4>
            <p class="text-sm text-gray-500">Statistics are calculated from transactions and reviews within the selected date range. Top sellers include only sellers with active shops.</p>
        </div>
        <div class="text-right text-sm text-gray-500">
            <div>Data last refreshed: <span th:text="${totals != null ? totals.lastUpdated : 'N/A'}">N/A</span></div>
        </div>
    </div>

    <!-- Chart.js CDN and initialization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var revenueLabels = /*[[${labels}]]*/ [];
        var revenueSeries = /*[[${revenueSeries}]]*/ [];
        var topSellers = /*[[${topSellers}]]*/ [];
        var topProducts = /*[[${topProducts}]]*/ [];

        function formatNumber(v){
            if(v == null) return '0';
            return v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.addEventListener('DOMContentLoaded', function(){
            // Revenue Line Chart
            (function(){
                var ctx = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            label: 'Revenue',
                            data: revenueSeries,
                            borderColor: 'rgba(220,38,38,0.9)',
                            backgroundColor: 'rgba(220,38,38,0.12)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { callback: function(val){ return '$' + formatNumber(val); } } }
                        }
                    }
                });
            })();

            // Top Sellers Bar Chart (horizontal)
            (function(){
                var labels = topSellers.map(function(s){ return s.sellerName; });
                var data = topSellers.map(function(s){ return s.revenue; });
                var ctx = document.getElementById('topSellersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(220,38,38,0.8)'
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        indexAxis: 'y',
                        scales: {
                            x: { ticks: { callback: function(v){ return '$' + formatNumber(v); } } }
                        }
                    }
                });
            })();

            // Top Products Bar Chart (horizontal)
            (function(){
                var labels = topProducts.map(function(p){ return p.productName; });
                var data = topProducts.map(function(p){ return p.soldCount; });
                var ctx = document.getElementById('topProductsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sold',
                            data: data,
                            backgroundColor: 'rgba(59,130,246,0.8)'
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        indexAxis: 'y'
                    }
                });
            })();

            // Quick range buttons logic
            function formatDate(d){
                var y = d.getFullYear();
                var m = (d.getMonth()+1).toString().padStart(2,'0');
                var day = d.getDate().toString().padStart(2,'0');
                return y + '-' + m + '-' + day;
            }

            document.querySelectorAll('.quick-range').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var range = btn.getAttribute('data-range');
                    var to = new Date();
                    var from = new Date();
                    if(range === 'week'){
                        from.setDate(to.getDate() - 7);
                    } else if(range === 'month'){
                        from.setMonth(to.getMonth() - 1);
                    } else if(range === 'year'){
                        from.setFullYear(to.getFullYear() - 1);
                    }
                    var fromInput = document.querySelector('input[name=from]');
                    var toInput = document.querySelector('input[name=to]');
                    if(fromInput && toInput){
                        fromInput.value = formatDate(from);
                        toInput.value = formatDate(to);
                        document.getElementById('filterForm').submit();
                    }
                });
            });
        });
        /*]]>*/
    </script>
</div>
