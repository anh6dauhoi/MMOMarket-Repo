<div th:fragment="content">
    <div class="bg-white p-4 md:p-5 lg:p-6 rounded-lg shadow-lg w-full">
        <form method="post" th:action="@{/admin/system-config}" enctype="multipart/form-data" class="space-y-6">
            <input th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

            <!-- Header with title and Save button -->
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">System Configuration</h1>
                    <p class="text-sm text-gray-500 mt-0.5">Manage system parameters: commission, contact email, bank info, and policy documents.</p>
                </div>
                <div class="flex items-center gap-3">
                    <div th:if="${successMessage != null}">
                        <div class="inline-flex items-center px-4 py-2 rounded-md bg-green-50 text-green-700 border border-green-200 shadow-sm">
                            <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.364 7.364a1 1 0 01-1.414 0L3.293 9.435a1 1 0 111.414-1.414l3.05 3.05 6.657-6.657a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            <span th:text="${successMessage}">Updated successfully</span>
                        </div>
                    </div>
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 rounded-md bg-red-600 text-white font-medium shadow hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M17 16a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h3l2-2h4l2 2h3a1 1 0 011 1v9z"/><path d="M5 8h10v7H5z"/></svg>
                        Save changes
                    </button>
                </div>
            </div>

            <!-- Global error -->
            <div th:if="${errors != null and errors.containsKey('_global')}" class="rounded-md border border-red-200 bg-red-50 text-red-700 p-3 text-sm">
                <span th:text="${errors['_global']}">An error occurred.</span>
            </div>

            <!-- Commission -->
            <section class="rounded-lg border border-gray-200">
                <div class="px-4 py-3 bg-red-50 border-b border-gray-200 rounded-t-lg">
                    <h2 class="text-sm font-semibold text-red-700">Commission Settings</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="commission.default_percentage">Default commission rate (%)</label>
                        <div class="relative">
                            <input id="commission.default_percentage" name="commission.default_percentage" type="number" step="0.01" min="0" max="100"
                                   class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 pr-12"
                                   th:value="${configMap['commission.default_percentage'] != null ? configMap['commission.default_percentage'].configValue : ''}" placeholder="5.00"/>
                            <span class="absolute inset-y-0 right-3 flex items-center text-gray-400">%</span>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Applies to new sellers or those without a level.</p>
                        <p class="mt-1 text-xs text-red-600" th:if="${errors != null and errors.containsKey('commission.default_percentage')}" th:text="${errors['commission.default_percentage']}"></p>
                    </div>
                </div>
            </section>

            <!-- Contact Email -->
            <section class="rounded-lg border border-gray-200">
                <div class="px-4 py-3 bg-red-50 border-b border-gray-200 rounded-t-lg">
                    <h2 class="text-sm font-semibold text-red-700">Contact</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="system.email.contact">Contact email</label>
                        <input id="system.email.contact" name="system.email.contact" type="email"
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"
                               th:value="${configMap['system.email.contact'] != null ? configMap['system.email.contact'].configValue : ''}" placeholder="contact@mmomarket.xyz"/>
                        <p class="mt-1 text-xs text-gray-500">Email address for user support/contact.</p>
                        <p class="mt-1 text-xs text-red-600" th:if="${errors != null and errors.containsKey('system.email.contact')}" th:text="${errors['system.email.contact']}"></p>
                    </div>
                </div>
            </section>

            <!-- Bank Info -->
            <section class="rounded-lg border border-gray-200">
                <div class="px-4 py-3 bg-red-50 border-b border-gray-200 rounded-t-lg">
                    <h2 class="text-sm font-semibold text-red-700">Bank Information</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="system.bank.name">Bank name</label>
                        <select id="system.bank.name" name="system.bank.name"
                                class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled th:selected="${configMap['system.bank.name'] == null || #strings.isEmpty(configMap['system.bank.name'].configValue)}">-- Select bank --</option>
                            <option th:each="b : ${bankOptions}"
                                    th:value="${b.displayName}"
                                    th:selected="${configMap['system.bank.name'] != null && b.displayName == configMap['system.bank.name'].configValue}"
                                    th:text="${b.displayName}">MBBank</option>
                        </select>
                        <p class="mt-1 text-xs text-red-600" th:if="${errors != null and errors.containsKey('system.bank.name')}" th:text="${errors['system.bank.name']}"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="system.bank.account_number">Account number</label>
                        <input id="system.bank.account_number" name="system.bank.account_number" type="text"
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"
                               th:value="${configMap['system.bank.account_number'] != null ? configMap['system.bank.account_number'].configValue : ''}" placeholder="0813302283"/>
                        <p class="mt-1 text-xs text-red-600" th:if="${errors != null and errors.containsKey('system.bank.account_number')}" th:text="${errors['system.bank.account_number']}"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="system.bank.account_name">Account holder name</label>
                        <input id="system.bank.account_name" name="system.bank.account_name" type="text"
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"
                               th:value="${configMap['system.bank.account_name'] != null ? configMap['system.bank.account_name'].configValue : ''}" placeholder="Tran Tuan Anh"/>
                        <p class="mt-1 text-xs text-red-600" th:if="${errors != null and errors.containsKey('system.bank.account_name')}" th:text="${errors['system.bank.account_name']}"></p>
                    </div>
                </div>
                <div class="px-4 pb-4">
                    <div class="rounded-md bg-gray-50 border border-gray-200 p-3 text-sm text-gray-600">
                        <div class="flex items-center">
                            <svg class="h-4 w-4 text-gray-400 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10A8 8 0 11.001 10 8 8 0 0118 10zM9 9V5h2v6H6V9h3z" clip-rule="evenodd"/></svg>
                            <span>This information will be shown to users during deposits/withdrawals.</span>
                        </div>
                    </div>
                </div>
                <!-- New: SePay QR Preview -->
                <div class="px-4 pb-5">
                    <div class="rounded-lg border border-gray-200 p-4 bg-white">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-700">SePay QR Preview</h3>
                            <span class="text-xs text-gray-400">Live preview</span>
                        </div>
                        <div class="flex items-start gap-4">
                            <img id="sepay-qr-preview" th:src="${sepayQrPreview}" alt="SePay QR Preview" class="w-44 h-44 border rounded-md bg-white"/>
                            <div class="text-xs text-gray-500 leading-relaxed">
                                <p>This preview uses sample transfer content:
                                    <code class="font-mono bg-gray-100 px-1 py-0.5 rounded">MMOPREVIEW123456</code>.
                                </p>
                                <p class="mt-1">The actual top-up QR shown to users includes their unique deposit code.</p>
                                <p class="mt-2">Editing the Bank Name and Account Number will update this preview instantly.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Policies -->
            <section class="rounded-lg border border-gray-200">
                <div class="px-4 py-3 bg-red-50 border-b border-gray-200 rounded-t-lg">
                    <h2 class="text-sm font-semibold text-red-700">Policies</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="policy_complaint">Complaint resolution policy (PDF/DOC/DOCX)</label>
                        <div class="space-y-1">
                            <div th:if="${configMap['system_complaint'] != null and configMap['system_complaint'].configValue != null and !#strings.isEmpty(configMap['system_complaint'].configValue)}" class="text-sm">
                                <span class="text-gray-500 mr-2">Current file:</span>
                                <a th:href="${configMap['system_complaint'].configValue}" target="_blank" class="text-blue-600 hover:underline">View current file</a>
                            </div>
                            <input id="policy_complaint" name="policy_complaint" type="file" accept=".pdf,.doc,.docx"
                                   class="block w-full text-sm text-gray-700 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                            <p class="text-xs text-gray-500">Uploading a new file will replace the current document.</p>
                            <p class="text-xs text-red-600" th:if="${errors != null and errors.containsKey('system_complaint')}" th:text="${errors['system_complaint']}"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="policy_seller_agreement">Seller agreement (PDF/DOC/DOCX)</label>
                        <div class="space-y-1">
                            <div th:if="${configMap['system_contract'] != null and configMap['system_contract'].configValue != null and !#strings.isEmpty(configMap['system_contract'].configValue)}" class="text-sm">
                                <span class="text-gray-500 mr-2">Current file:</span>
                                <a th:href="${configMap['system_contract'].configValue}" target="_blank" class="text-blue-600 hover:underline">View current file</a>
                            </div>
                            <input id="policy_seller_agreement" name="policy_seller_agreement" type="file" accept=".pdf,.doc,.docx"
                                   class="block w-full text-sm text-gray-700 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                            <p class="text-xs text-gray-500">Uploading a new file will replace the current document.</p>
                            <p class="text-xs text-red-600" th:if="${errors != null and errors.containsKey('system_contract')}" th:text="${errors['system_contract']}"></p>
                        </div>
                    </div>
                </div>
            </section>
        </form>
    </div>
</div>

<!-- New: live update script for SePay QR preview -->
<script th:inline="javascript">
/*<![CDATA[*/
(function(){
  function updatePreview(){
    var accEl = document.getElementById('system.bank.account_number');
    var bankEl = document.getElementById('system.bank.name');
    var img = document.getElementById('sepay-qr-preview');
    if(!accEl || !bankEl || !img) return;
    var acc = accEl.value || '';
    var bank = bankEl.value || '';
    var des = 'MMOPREVIEW123456';
    var url = 'https://qr.sepay.vn/img?acc=' + encodeURIComponent(acc) + '&bank=' + encodeURIComponent(bank) + '&des=' + encodeURIComponent(des);
    img.src = url;
  }
  var accEl = document.getElementById('system.bank.account_number');
  var bankEl = document.getElementById('system.bank.name');
  if (accEl) accEl.addEventListener('input', updatePreview);
  if (bankEl) { bankEl.addEventListener('input', updatePreview); bankEl.addEventListener('change', updatePreview); }
})();
/*]]>*/
</script>
