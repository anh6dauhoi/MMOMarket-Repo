
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="content"
     th:with="page=${currentPage != null ? currentPage : 0},
              size=${10},
              total=${totalPages != null and totalPages > 0 ? totalPages : 1},
              shopCount=${shops != null ? #lists.size(shops) : 0}">
    <div class="bg-white p-4 md:p-6 lg:p-8 rounded-lg shadow-lg w-full">

        <!-- Toast Notification -->
        <div id="toast"
             class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300 z-50">
            <p id="toast-message"></p>
        </div>

        <!-- Title & Stats Row -->
        <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-6 space-y-4 md:space-y-0">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Shop Management</h1>
                <p class="text-sm text-gray-500">Manage seller shops and commission rates</p>
            </div>
        </div>

        <!-- Compact Search & Filter Controls -->
        <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-300 shadow-sm">
            <form method="get" action="/admin/shops">
                <div class="flex flex-wrap items-end gap-3">
                    <!-- Search Input -->
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs font-semibold text-red-800 mb-1.5">
                            <i class="fas fa-search text-red-600 mr-1"></i>Search
                        </label>
                        <input name="search"
                               class="w-full py-2 px-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white shadow-sm text-sm"
                               placeholder="Search by shop or seller name..."
                               type="text"
                               th:value="${currentSearch != null ? currentSearch : ''}">
                    </div>

                    <!-- Status Filter -->
                    <div class="w-40">
                        <label class="block text-xs font-semibold text-red-800 mb-1.5">
                            <i class="fas fa-toggle-on text-red-600 mr-1"></i>Status
                        </label>
                        <select name="status" class="w-full py-2 px-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-white shadow-sm text-sm">
                            <option value="All" th:selected="${currentStatus == null or currentStatus == '' or currentStatus == 'All'}">All Status</option>
                            <option value="Active" th:selected="${currentStatus == 'Active'}">Active</option>
                            <option value="Inactive" th:selected="${currentStatus == 'Inactive'}">Inactive</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div class="w-44">
                        <label class="block text-xs font-semibold text-red-800 mb-1.5">
                            <i class="fas fa-sort text-red-600 mr-1"></i>Sort By
                        </label>
                        <select name="sort" class="w-full py-2 px-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-white shadow-sm text-sm">
                            <option value="name_asc" th:selected="${currentSort == null or currentSort == 'name_asc'}">Name A-Z</option>
                            <option value="name_desc" th:selected="${currentSort == 'name_desc'}">Name Z-A</option>
                            <option value="level_desc" th:selected="${currentSort == 'level_desc'}">Level ↓</option>
                            <option value="level_asc" th:selected="${currentSort == 'level_asc'}">Level ↑</option>
                            <option value="rating_desc" th:selected="${currentSort == 'rating_desc'}">Rating ↓</option>
                            <option value="rating_asc" th:selected="${currentSort == 'rating_asc'}">Rating ↑</option>
                            <option value="commission_desc" th:selected="${currentSort == 'commission_desc'}">Commission ↓</option>
                            <option value="commission_asc" th:selected="${currentSort == 'commission_asc'}">Commission ↑</option>
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition duration-200 shadow-md text-sm whitespace-nowrap">
                            <i class="fas fa-filter mr-1.5"></i>Apply
                        </button>
                        <a th:href="@{/admin/shops}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition duration-200 text-sm whitespace-nowrap">
                            <i class="fas fa-redo mr-1.5"></i>Reset
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Desktop table -->
        <div class="hidden md:block overflow-x-auto rounded-lg border border-red-200 shadow-sm">
            <table class="min-w-full bg-white">
                <!-- Header: red theme matching transactions -->
                <thead class="bg-red-600">
                <tr>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">#</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Shop Info</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Seller Info</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Status</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Level</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Products</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Rating</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Commission</th>
                    <th class="py-3 px-4 text-left text-xs font-bold text-white uppercase tracking-wider border-b-2 border-red-700">Actions</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">

                <tr class="hover:bg-red-50 transition duration-150" th:each="shop,iter : ${shops}">
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${page * size + iter.index + 1}">1</td>
                    <td class="py-3 px-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-store text-blue-700"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900 text-sm" th:text="${shop.shopName}">Shop Name</div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-hashtag text-gray-400"></i>
                                    <span th:text="${shop.id}">ID</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div>
                            <div class="text-sm font-medium text-gray-900" th:text="${shop.sellerName}">Seller Name</div>
                            <div class="text-xs text-gray-500" th:text="${shop.sellerEmail}">email@example.com</div>
                        </div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <span th:if="${shop.isDelete == false}"
                              class="px-2.5 py-1 inline-flex items-center text-xs leading-5 font-bold rounded-full bg-green-100 text-green-800 border border-green-300">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                        <span th:if="${shop.isDelete == true}"
                              class="px-2.5 py-1 inline-flex items-center text-xs leading-5 font-bold rounded-full bg-red-100 text-red-800 border border-red-300">
                            <i class="fas fa-times-circle mr-1"></i>Inactive
                        </span>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <span class="px-2.5 py-1 inline-flex items-center text-xs leading-5 font-bold rounded-full bg-blue-100 text-blue-800 border border-blue-300"
                              th:text="${shop.shopLevel != null ? shop.shopLevel : 0}">
                            0
                        </span>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">
                            <i class="fas fa-box text-purple-500 mr-1"></i>
                            <span th:text="${shop.productCount}">0</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <i class="fas fa-star text-yellow-400 mr-1"></i>
                            <span class="text-sm font-medium text-gray-900" th:text="${#numbers.formatDecimal(shop.rating, 1, 1)}">0.0</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">
                            <i class="fas fa-percent text-green-500 mr-1"></i>
                            <span th:text="${shop.commission}">5.00</span>%
                        </div>
                    </td>
                    <td class="py-3 px-4 whitespace-nowrap">
                        <!-- Debug: Display status and isDelete values -->
                        <span class="hidden" th:attr="data-debug-status=${shop.status}, data-debug-isdelete=${shop.isDelete}"></span>

                        <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                            <button class="inline-flex items-center px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs font-semibold rounded-lg transition duration-200 shadow-sm"
                                    onclick="openCommissionModal(this)"
                                    th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-rate=${shop.commission}">
                                <i class="fas fa-cog mr-1.5"></i>Config
                            </button>
                            <button class="inline-flex items-center px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded-lg transition duration-200 shadow-sm"
                                    onclick="openShopDetail(this)"
                                    th:attr="data-id=${shop.id}">
                                <i class="fas fa-eye mr-1.5"></i>Detail
                            </button>
                            <!-- Flag button: Check BOTH status=Active AND isDelete=false -->
                            <!-- Note: isDelete is boolean in Java, will be true/false in template -->
                            <button th:if="${shop.status != null and #strings.equalsIgnoreCase(#strings.trim(shop.status), 'Active') and !shop.isDelete}"
                                    class="inline-flex items-center px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold rounded-lg transition duration-200 shadow-sm"
                                    onclick="openFlagShopModal(this)"
                                    th:attr="data-id=${shop.id}, data-name=${shop.shopName}">
                                <i class="fas fa-flag mr-1.5"></i>Flag
                            </button>
                            <button th:if="${shop.isDelete == false}"
                                    class="inline-flex items-center px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold rounded-lg transition duration-200 shadow-sm"
                                    onclick="toggleShopStatus(this)"
                                    th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-status=${shop.status}, data-isdelete=${shop.isDelete}">
                                <i class="fas fa-ban mr-1.5"></i>Inactive
                            </button>
                            <button th:if="${shop.isDelete == true}"
                                    class="inline-flex items-center px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded-lg transition duration-200 shadow-sm"
                                    onclick="toggleShopStatus(this)"
                                    th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-status=${shop.status}, data-isdelete=${shop.isDelete}">
                                <i class="fas fa-check mr-1.5"></i>Active
                            </button>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(shops)}">
                    <td class="text-center py-16 text-gray-400" colspan="9">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p class="text-lg font-medium">No shops found</p>
                        <p class="text-sm">Try adjusting your filters or search criteria</p>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <!-- Mobile cards -->
        <div class="md:hidden space-y-4">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 hover:shadow-md transition duration-150" th:each="shop,iter : ${shops}">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center">
                        <span class="font-bold text-gray-500 mr-2" th:text="${page * size + iter.index + 1}">1</span>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-store text-blue-700 text-xs"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 text-sm" th:text="${shop.shopName}">Shop Name</h3>
                                <p class="text-xs text-gray-500" th:text="${shop.sellerName}">Seller Name</p>
                            </div>
                        </div>
                    </div>
                    <span th:if="${shop.isDelete == false}"
                          class="px-2 py-1 inline-flex text-xs leading-none font-semibold rounded-full bg-green-100 text-green-800 border border-green-300">
                        <i class="fas fa-check-circle mr-0.5"></i>Active
                    </span>
                    <span th:if="${shop.isDelete == true}"
                          class="px-2 py-1 inline-flex text-xs leading-none font-semibold rounded-full bg-red-100 text-red-800 border border-red-300">
                        <i class="fas fa-times-circle mr-0.5"></i>Inactive
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                    <div>
                        <p class="text-gray-500 text-xs">Level:</p>
                        <span class="px-2 py-1 inline-flex text-xs font-semibold rounded-full bg-blue-100 text-blue-800 border border-blue-300">
                            <span th:text="${shop.shopLevel != null ? shop.shopLevel : 0}">0</span>
                        </span>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Products:</p>
                        <p class="font-bold text-sm">
                            <i class="fas fa-box text-purple-500 mr-1"></i>
                            <span th:text="${shop.productCount}">0</span>
                        </p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Rating:</p>
                        <div class="flex items-center">
                            <i class="fas fa-star text-yellow-400 mr-1"></i>
                            <span class="font-medium text-sm" th:text="${#numbers.formatDecimal(shop.rating, 1, 1)}">0.0</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Commission:</p>
                        <p class="font-bold text-sm">
                            <i class="fas fa-percent text-green-500 mr-1"></i>
                            <span th:text="${shop.commission}">5.00</span>%
                        </p>
                    </div>
                </div>

                <!-- Debug: Display status and isDelete values -->
                <span class="hidden" th:attr="data-debug-status-mobile=${shop.status}, data-debug-isdelete-mobile=${shop.isDelete}"></span>

                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button class="py-2 bg-purple-50 text-purple-500 hover:bg-purple-100 rounded font-medium text-sm"
                            onclick="openCommissionModal(this)"
                            th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-rate=${shop.commission}">
                        <i class="fas fa-cog mr-1"></i>Config
                    </button>
                    <button class="py-2 bg-blue-50 text-blue-500 hover:bg-blue-100 rounded font-medium text-sm"
                            onclick="openShopDetail(this)"
                            th:attr="data-id=${shop.id}">
                        <i class="fas fa-eye mr-1"></i>Detail
                    </button>
                    <!-- Flag button: Check BOTH status=Active AND isDelete=false -->
                    <!-- Note: isDelete is boolean, use !shop.isDelete to check false -->
                    <button th:if="${shop.status != null and #strings.equalsIgnoreCase(#strings.trim(shop.status), 'Active') and !shop.isDelete}"
                            class="py-2 bg-yellow-50 text-yellow-600 hover:bg-yellow-100 rounded font-medium text-sm"
                            onclick="openFlagShopModal(this)"
                            th:attr="data-id=${shop.id}, data-name=${shop.shopName}">
                        <i class="fas fa-flag mr-1"></i>Flag
                    </button>
                    <button th:if="${shop.isDelete == false}"
                            class="py-2 bg-red-50 text-red-500 hover:bg-red-100 rounded font-medium text-sm"
                            onclick="toggleShopStatus(this)"
                            th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-status=${shop.status}, data-isdelete=${shop.isDelete}">
                        <i class="fas fa-ban mr-1"></i>Inactive
                    </button>
                    <button th:if="${shop.isDelete == true}"
                            class="py-2 bg-green-50 text-green-500 hover:bg-green-100 rounded font-medium text-sm"
                            onclick="toggleShopStatus(this)"
                            th:attr="data-id=${shop.id}, data-name=${shop.shopName}, data-status=${shop.status}, data-isdelete=${shop.isDelete}">
                        <i class="fas fa-check mr-1"></i>Active
                    </button>
                </div>
            </div>

            <div class="text-center py-16 text-gray-400" th:if="${#lists.isEmpty(shops)}">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p class="text-lg font-medium">No shops found</p>
                <p class="text-sm">Try adjusting your filters or search criteria</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-3 sm:space-y-0">
            <div class="text-sm text-gray-600">
                Showing <span class="font-semibold text-gray-900" th:text="${shopCount > 0 ? (page * size + 1) : 0}">0</span>
                to <span class="font-semibold text-gray-900" th:text="${page * size + shopCount}">0</span>
                of <span class="font-semibold text-gray-900" th:text="${total * size}">0</span> results
            </div>
            <div class="flex space-x-1 flex-wrap justify-center">
                <a class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-red-50 text-sm font-medium transition duration-150"
                   th:with="url='/admin/shops?page=' + ${page - 1}
                           + (${currentSearch != null and !currentSearch.isEmpty()} ? '&search=' + ${currentSearch} : '')
                           + (${currentStatus != null and currentStatus != 'All'} ? '&status=' + ${currentStatus} : '')
                           + (${currentSort != null} ? '&sort=' + ${currentSort} : '')"
                   th:href="${url}" th:if="${page > 0}">
                    <i class="fas fa-chevron-left"></i>
                </a>

                <a class="px-3 py-2 border rounded-lg text-sm font-medium transition duration-150"
                   th:classappend="${i == page} ? 'bg-red-600 text-white border-red-600' : 'border-gray-300 hover:bg-red-50'"
                   th:each="i : ${#numbers.sequence(0, total - 1)}"
                   th:with="url='/admin/shops?page=' + ${i}
                           + (${currentSearch != null and !currentSearch.isEmpty()} ? '&search=' + ${currentSearch} : '')
                           + (${currentStatus != null and currentStatus != 'All'} ? '&status=' + ${currentStatus} : '')
                           + (${currentSort != null} ? '&sort=' + ${currentSort} : '')"
                   th:href="${url}"
                   th:if="${i == 0 or i == page or i == page - 1 or i == page + 1 or i == total - 1}"
                   th:text="${i + 1}">1</a>

                <a class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-red-50 text-sm font-medium transition duration-150"
                   th:with="url='/admin/shops?page=' + ${page + 1}
                           + (${currentSearch != null and !currentSearch.isEmpty()} ? '&search=' + ${currentSearch} : '')
                           + (${currentStatus != null and currentStatus != 'All'} ? '&status=' + ${currentStatus} : '')
                           + (${currentSort != null} ? '&sort=' + ${currentSort} : '')"
                   th:href="${url}" th:if="${page < total - 1}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Commission Config Modal -->
    <div id="commissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300 ease-out scale-95 opacity-0">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-200 bg-red-600 rounded-t-2xl">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 rounded-full flex items-center justify-center bg-white shadow-md">
                        <i class="fas fa-cog text-red-600 text-base"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">Configure Commission Rate</h3>
                </div>
                <button class="text-white hover:text-red-100 transition duration-150"
                        onclick="closeCommissionModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-5 py-4">
                <form id="commissionForm" onsubmit="submitCommission(event)">
                    <input type="hidden" id="shopId">

                    <div class="space-y-4">
                        <div>
                            <label for="shopName" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-store text-red-600 mr-1"></i>Shop Name
                            </label>
                            <input type="text" id="shopName" readonly
                                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-50 shadow-sm">
                        </div>

                        <div>
                            <label for="commissionRate" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-percent text-red-600 mr-1"></i>Commission Rate (%) *
                            </label>
                            <input type="number" id="commissionRate" step="0.01" min="0" max="100" required
                                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent shadow-sm">
                            <p class="mt-1 text-xs text-gray-500">Enter a value between 0 and 100</p>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex space-x-3 mt-6">
                        <button type="submit"
                                class="flex-1 px-6 py-2.5 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-semibold rounded-lg shadow-md transition-all duration-200">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button type="button" onclick="closeCommissionModal()"
                                class="flex-1 px-6 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Shop Detail Modal -->
    <div id="shopDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full transform transition-all duration-300 ease-out scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-200 bg-red-600 rounded-t-2xl sticky top-0 z-10">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 rounded-full flex items-center justify-center bg-white shadow-md">
                        <i class="fas fa-store text-red-600 text-base"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">Shop Details</h3>
                </div>
                <button class="text-white hover:text-red-100 transition duration-150"
                        onclick="closeShopDetail()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-5 py-4">
                <div class="space-y-6">
                    <!-- Shop Info -->
                    <div class="border-b pb-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-store-alt text-red-600 mr-2"></i>Shop Information
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Shop Name</p>
                                <p id="detail-shopName" class="text-base font-medium text-gray-900">-</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Status</p>
                                <div id="detail-status">
                                    <span class="px-2 py-1 text-xs rounded-full">-</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Shop Level</p>
                                <p id="detail-shopLevel-text" class="text-base text-gray-900">-</p>
                                <input type="number" id="detail-shopLevel-input"
                                       class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 shadow-sm"
                                       min="0" max="255" step="1">
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Points</p>
                                <p id="detail-points-text" class="text-base text-gray-900">-</p>
                                <input type="number" id="detail-points-input"
                                       class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 shadow-sm"
                                       min="0" step="1">
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Product Count</p>
                                <p id="detail-productCount" class="text-base text-gray-900">-</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Rating</p>
                                <div id="detail-rating" class="flex items-center">
                                    <i class="fas fa-star text-yellow-400 mr-1"></i>
                                    <span class="text-base text-gray-900">-</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Commission Rate</p>
                                <p id="detail-commission" class="text-base text-gray-900">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seller Info -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-user-tie text-red-600 mr-2"></i>Seller Information
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Seller ID</p>
                                <p id="detail-sellerId" class="text-base text-gray-900">-</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Seller Name</p>
                                <p id="detail-sellerName" class="text-base font-medium text-gray-900">-</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm font-medium text-gray-500 mb-1">Email</p>
                                <p id="detail-sellerEmail" class="text-base text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex space-x-3 mt-6 pt-4 border-t">
                    <button id="editShopDetailBtn" onclick="enableEditMode()"
                            class="flex-1 px-6 py-2.5 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-semibold rounded-lg shadow-md transition-all duration-200">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button id="saveShopDetailBtn" onclick="saveShopDetail()"
                            class="hidden flex-1 px-6 py-2.5 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-semibold rounded-lg shadow-md transition-all duration-200">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                    <button id="cancelEditBtn" onclick="cancelEditMode()"
                            class="hidden flex-1 px-6 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="closeShopDetailBtn" onclick="closeShopDetail()"
                            class="flex-1 px-6 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        // Debug: Log all shop statuses on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Shop Status Debug Info ===');
            document.querySelectorAll('[data-debug-status]').forEach(function(el, index) {
                const status = el.getAttribute('data-debug-status');
                const isDelete = el.getAttribute('data-debug-isdelete');
                const row = el.closest('tr');
                const shopName = row ? row.querySelector('[data-name]')?.getAttribute('data-name') : 'Unknown';
                console.log(`Shop ${index + 1}: "${shopName}"`);
                console.log(`  → Status: "${status}" (type: ${typeof status}, trimmed: "${status?.trim()}")`);
                console.log(`  → isDelete: ${isDelete} (type: ${typeof isDelete})`);

                // Check conditions
                const statusOk = status && status.trim().toLowerCase() === 'active';
                const isDeleteOk = isDelete === 'false'; // boolean false renders as string "false"
                console.log(`  → Status is Active: ${statusOk}`);
                console.log(`  → isDelete is false: ${isDeleteOk}`);
                console.log(`  → Should show Flag: ${statusOk && isDeleteOk}`);

                // Check if Flag button exists in this row
                const flagBtn = row ? row.querySelector('button[onclick*="openFlagShopModal"]') : null;
                console.log(`  → Flag button visible: ${flagBtn !== null}`);
                if (statusOk && isDeleteOk && !flagBtn) {
                    console.warn(`  ⚠️ WARNING: Conditions met but Flag button NOT visible!`);
                }
            });
            console.log('=============================');
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
            toast.classList.remove('hidden');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('opacity-100');
            }, 3000);
        }

        function openCommissionModal(button) {
            const modal = document.getElementById('commissionModal');
            const modalContent = modal.querySelector('.bg-white');
            const shopId = button.dataset.id;
            const shopName = button.dataset.name;
            const currentRate = button.dataset.rate;

            document.getElementById('shopId').value = shopId;
            document.getElementById('shopName').value = shopName;
            document.getElementById('commissionRate').value = currentRate;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeCommissionModal() {
            const modal = document.getElementById('commissionModal');
            const modalContent = modal.querySelector('.bg-white');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('commissionForm').reset();
            }, 200);
        }

        async function submitCommission(event) {
            event.preventDefault();

            const shopId = document.getElementById('shopId').value;
            const commissionRate = Number.parseFloat(document.getElementById('commissionRate').value);

            if (Number.isNaN(commissionRate) || commissionRate < 0 || commissionRate > 100) {
                showToast('Commission rate must be between 0 and 100', true);
                return;
            }

            try {
                const response = await fetch(`/admin/shops/${shopId}/commission`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ commission: commissionRate })
                });

                if (response.ok) {
                    showToast('Commission rate updated successfully');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    showToast('Error: ' + errorText, true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to update commission rate', true);
            }
        }

        async function openShopDetail(button) {
            const modal = document.getElementById('shopDetailModal');
            const modalContent = modal.querySelector('.bg-white');
            const shopId = button.dataset.id;

            try {
                const response = await fetch(`/admin/shops/${shopId}/detail`);
                if (response.ok) {
                    const shop = await response.json();

                    // Store shop ID for later use
                    modal.dataset.shopId = shop.id;

                    document.getElementById('detail-shopName').textContent = shop.shopName || '-';
                    document.getElementById('detail-shopLevel-text').textContent = shop.shopLevel !== null ? shop.shopLevel : '0';
                    document.getElementById('detail-shopLevel-input').value = shop.shopLevel !== null ? shop.shopLevel : 0;
                    document.getElementById('detail-points-text').textContent = shop.points !== null ? shop.points.toLocaleString() : '0';
                    document.getElementById('detail-points-input').value = shop.points !== null ? shop.points : 0;
                    document.getElementById('detail-productCount').textContent = shop.productCount || '0';
                    document.getElementById('detail-rating').querySelector('span').textContent = shop.rating ? shop.rating.toFixed(1) : '0.0';
                    document.getElementById('detail-commission').textContent = shop.commission ? shop.commission + '%' : '-';
                    document.getElementById('detail-sellerId').textContent = shop.sellerId || '-';
                    document.getElementById('detail-sellerName').textContent = shop.sellerName || '-';
                    document.getElementById('detail-sellerEmail').textContent = shop.sellerEmail || '-';

                    // Display status based on isDelete field
                    const statusElement = document.getElementById('detail-status');
                    if (shop.isDelete === false) {
                        statusElement.innerHTML = '<span class="px-2.5 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-300"><i class="fas fa-check-circle mr-1"></i>Active</span>';
                    } else {
                        statusElement.innerHTML = '<span class="px-2.5 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-300"><i class="fas fa-times-circle mr-1"></i>Inactive</span>';
                    }

                    // Reset to view mode
                    disableEditMode();

                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }, 10);
                } else {
                    showToast('Failed to load shop details', true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to load shop details', true);
            }
        }

        function closeShopDetail() {
            const modal = document.getElementById('shopDetailModal');
            const modalContent = modal.querySelector('.bg-white');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                disableEditMode();
            }, 200);
        }

        function enableEditMode() {
            // Hide text, show inputs
            document.getElementById('detail-shopLevel-text').classList.add('hidden');
            document.getElementById('detail-shopLevel-input').classList.remove('hidden');
            document.getElementById('detail-points-text').classList.add('hidden');
            document.getElementById('detail-points-input').classList.remove('hidden');

            // Toggle buttons
            document.getElementById('editShopDetailBtn').classList.add('hidden');
            document.getElementById('closeShopDetailBtn').classList.add('hidden');
            document.getElementById('saveShopDetailBtn').classList.remove('hidden');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }

        function disableEditMode() {
            // Show text, hide inputs
            document.getElementById('detail-shopLevel-text').classList.remove('hidden');
            document.getElementById('detail-shopLevel-input').classList.add('hidden');
            document.getElementById('detail-points-text').classList.remove('hidden');
            document.getElementById('detail-points-input').classList.add('hidden');

            // Toggle buttons
            document.getElementById('editShopDetailBtn').classList.remove('hidden');
            document.getElementById('closeShopDetailBtn').classList.remove('hidden');
            document.getElementById('saveShopDetailBtn').classList.add('hidden');
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function cancelEditMode() {
            // Reload original values
            const shopLevel = document.getElementById('detail-shopLevel-text').textContent;
            const points = document.getElementById('detail-points-text').textContent.replace(/,/g, '');
            document.getElementById('detail-shopLevel-input').value = shopLevel;
            document.getElementById('detail-points-input').value = points;

            disableEditMode();
        }

        async function saveShopDetail() {
            const shopId = document.getElementById('shopDetailModal').dataset.shopId;
            const shopLevel = parseInt(document.getElementById('detail-shopLevel-input').value);
            const points = parseInt(document.getElementById('detail-points-input').value);

            // Validation
            if (isNaN(shopLevel) || shopLevel < 0 || shopLevel > 255) {
                showToast('Shop level must be between 0 and 255', true);
                return;
            }

            if (isNaN(points) || points < 0) {
                showToast('Points must be greater than or equal to 0', true);
                return;
            }

            try {
                const response = await fetch(`/admin/shops/${shopId}/level-points`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        shopLevel: shopLevel,
                        points: points
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Update displayed values
                    document.getElementById('detail-shopLevel-text').textContent = result.shopLevel;
                    document.getElementById('detail-points-text').textContent = result.points.toLocaleString();

                    disableEditMode();
                    showToast('Shop level and points updated successfully');

                    // Reload page after 1.5 seconds to reflect changes in the table
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const errorText = await response.text();
                    showToast('Error: ' + errorText, true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to update shop level and points', true);
            }
        }

        async function toggleShopStatus(button) {
            const shopId = button.dataset.id;
            const shopName = button.dataset.name;
            const isDelete = button.dataset.isdelete === 'true';
            const newStatus = isDelete ? 'Active' : 'Inactive';
            const action = isDelete ? 'activate' : 'deactivate';

            if (!confirm(`Are you sure you want to ${action} shop "${shopName}"? This will set the shop status to ${newStatus}.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/shops/${shopId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    showToast(`Shop ${action}d successfully`);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    showToast('Error: ' + errorText, true);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(`Failed to ${action} shop`, true);
            }
        }

        // Close modals when clicking outside
        document.addEventListener('DOMContentLoaded', function () {
            const commissionModal = document.getElementById('commissionModal');
            const shopDetailModal = document.getElementById('shopDetailModal');

            if (commissionModal) {
                commissionModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeCommissionModal();
                    }
                });
            }

            if (shopDetailModal) {
                shopDetailModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeShopDetail();
                    }
                });
            }
        });

        // Flag Shop Modal Functions
        function openFlagShopModal(button) {
            const shopId = button.getAttribute('data-id');
            const shopName = button.getAttribute('data-name');

            document.getElementById('flagShopId').value = shopId;
            document.getElementById('flagShopName').textContent = shopName;

            const modal = document.getElementById('flagShopModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeFlagShopModal() {
            const modal = document.getElementById('flagShopModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('flagShopForm').reset();
        }

        // Wait for DOM to be fully loaded before attaching event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const flagForm = document.getElementById('flagShopForm');
            if (!flagForm) {
                console.error('Flag shop form not found in DOM');
                return;
            }

            flagForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const shopId = document.getElementById('flagShopId').value;
                const reason = document.getElementById('flagReason').value;
                const flagLevel = document.getElementById('flagLevel').value;
                const relatedComplaintId = document.getElementById('relatedComplaintId').value;

                // Validation
                if (!reason || reason.trim() === '') {
                    showToast('Please enter a reason', true);
                    return;
                }
                if (!flagLevel || flagLevel === '') {
                    showToast('Please select a flag level', true);
                    return;
                }

                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                console.log('Submitting flag for shop:', shopId);
                console.log('Flag level:', flagLevel);
                console.log('Reason:', reason);
                console.log('CSRF Token:', csrfToken);
                console.log('CSRF Header:', csrfHeader);

                const requestBody = {
                    shopId: parseInt(shopId),
                    reason: reason,
                    flagLevel: flagLevel,
                    relatedComplaintId: relatedComplaintId ? parseInt(relatedComplaintId) : null
                };

                console.log('Request body:', requestBody);

                fetch(`/admin/shops/${shopId}/flag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(requestBody),
                    credentials: 'same-origin'
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // Not JSON, try to get text
                        return response.text().then(text => {
                            console.error('Non-JSON response:', text);
                            throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
                        });
                    }
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.error) {
                        showToast(data.error, true);
                    } else {
                        showToast('Shop flagged successfully', false);
                        closeFlagShopModal();
                        setTimeout(() => window.location.reload(), 1500);
                    }
                })
                .catch(error => {
                    console.error('Error flagging shop:', error);
                    showToast('Failed to flag shop: ' + error.message, true);
                });
            });

            // Close modal when clicking outside
            const flagModal = document.getElementById('flagShopModal');
            if (flagModal) {
                flagModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeFlagShopModal();
                    }
                });
            }
        });
        /*]]>*/
    </script>

    <!-- Flag Shop Modal -->
    <div id="flagShopModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Flag Shop</h3>
                        <p class="text-sm text-gray-500 mt-1">Shop: <span id="flagShopName" class="font-semibold"></span></p>
                    </div>
                    <button onclick="closeFlagShopModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="flagShopForm">
                    <input type="hidden" id="flagShopId">

                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>Flag Level <span class="text-red-500">*</span>
                        </label>
                        <select id="flagLevel" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="">Select level...</option>
                            <option value="WARNING">Warning - Minor violation</option>
                            <option value="SEVERE">Severe - Moderate violation</option>
                            <option value="BANNED">Banned - Major violation / Fraud</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            <strong>Warning:</strong> Slow response, unprofessional language<br>
                            <strong>Severe:</strong> Misleading descriptions, review manipulation<br>
                            <strong>Banned:</strong> Fraud, selling prohibited items
                        </p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-align-left text-gray-500 mr-1"></i>Reason <span class="text-red-500">*</span>
                        </label>
                        <textarea id="flagReason" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                  placeholder="Describe the violation in detail..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-link text-gray-500 mr-1"></i>Related Complaint ID (optional)
                        </label>
                        <input type="number" id="relatedComplaintId"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Enter complaint ID if applicable">
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-2"></i>
                            <div class="text-xs text-yellow-800">
                                <strong>Penalties:</strong><br>
                                • 3 flags in 30 days: -1 level<br>
                                • 5 flags in 90 days: -2 levels<br>
                                • 7 total flags or 1 fraud: Permanent ban<br>
                                • Flags auto-removed after 180 days
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeFlagShopModal()"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition duration-200">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition duration-200">
                            <i class="fas fa-flag mr-2"></i>Flag Shop
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

</html>
