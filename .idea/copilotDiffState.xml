<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/MMOMarket/src/main/java/com/mmo/controller/SellerController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MMOMarket/src/main/java/com/mmo/controller/SellerController.java" />
              <option name="originalContent" value="package com.mmo.controller;&#10;&#10;import com.mmo.dto.CreateWithdrawalRequest;&#10;import com.mmo.dto.SellerRegistrationForm;&#10;import com.mmo.dto.SellerWithdrawalResponse;&#10;import com.mmo.entity.SellerBankInfo;&#10;import com.mmo.entity.ShopInfo;&#10;import com.mmo.entity.User;&#10;import com.mmo.entity.Withdrawal;&#10;import com.mmo.repository.UserRepository;&#10;import com.mmo.service.EmailService;&#10;import com.mmo.service.NotificationService;&#10;import com.mmo.service.SellerBankInfoService;&#10;import com.mmo.service.SystemConfigurationService;&#10;import com.mmo.util.EmailTemplate;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.PersistenceContext;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;import jakarta.servlet.http.HttpSession;&#10;import jakarta.validation.Valid;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.beans.factory.annotation.Qualifier;&#10;import org.springframework.http.HttpStatus;&#10;import org.springframework.http.MediaType;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#10;import org.springframework.security.core.userdetails.UserDetails;&#10;import org.springframework.security.oauth2.core.oidc.user.OidcUser;&#10;import org.springframework.security.oauth2.core.user.OAuth2User;&#10;import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;&#10;import org.springframework.stereotype.Controller;&#10;import org.springframework.transaction.annotation.Transactional;&#10;import org.springframework.ui.Model;&#10;import org.springframework.validation.BindingResult;&#10;import org.springframework.web.bind.annotation.*;&#10;import org.springframework.web.multipart.MultipartFile;&#10;import org.springframework.web.servlet.mvc.support.RedirectAttributes;&#10;&#10;import java.math.BigDecimal;&#10;import java.text.SimpleDateFormat;&#10;import java.util.*;&#10;import java.util.concurrent.Executor;&#10;import java.util.Calendar;&#10;&#10;@Controller&#10;@RequestMapping(&quot;/seller&quot;)&#10;public class SellerController {&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private SellerBankInfoService sellerBankInfoService;&#10;&#10;    @Autowired&#10;    private EmailService emailService;&#10;    @Autowired&#10;    private NotificationService notificationService;&#10;&#10;    // New: queue publisher for withdrawal creation&#10;    @Autowired&#10;    private com.mmo.mq.WithdrawalQueuePublisher withdrawalQueuePublisher;&#10;&#10;    // New: queue publisher for seller registration&#10;    @Autowired&#10;    private com.mmo.mq.SellerRegistrationPublisher sellerRegistrationPublisher;&#10;&#10;    // New: queue publisher for buy-points&#10;    @Autowired&#10;    private com.mmo.mq.BuyPointsPublisher buyPointsPublisher;&#10;&#10;    @PersistenceContext&#10;    private EntityManager entityManager;&#10;&#10;    // Inject repositories used for delete-shop logic&#10;    @Autowired private com.mmo.repository.ProductRepository productRepository;&#10;    @Autowired private com.mmo.repository.ProductVariantRepository productVariantRepository;&#10;    @Autowired private com.mmo.repository.ProductVariantAccountRepository productVariantAccountRepository;&#10;    @Autowired private com.mmo.repository.ReviewRepository reviewRepository;&#10;    @Autowired private com.mmo.repository.TransactionRepository transactionRepository;&#10;    @Autowired private com.mmo.repository.ShopInfoRepository shopInfoRepository;&#10;&#10;    // OTP dependencies&#10;    @Autowired&#10;    private com.mmo.service.AuthService authService;&#10;    @Autowired&#10;    private com.mmo.repository.EmailVerificationRepository emailVerificationRepository;&#10;&#10;    @Autowired&#10;    @Qualifier(&quot;emailExecutor&quot;)&#10;    private Executor emailExecutor;&#10;&#10;    // Inject system configuration service&#10;    @Autowired&#10;    private SystemConfigurationService systemConfigurationService;&#10;&#10;    private static final long REGISTRATION_FEE = 200_000L;&#10;&#10;    @GetMapping(&quot;/register&quot;)&#10;    public String showRegistrationForm(Model model) {&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;&#10;        if (email == null) {&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;&#10;        // Load seller agreement URL from system configuration (fallback to static PDF)&#10;        String agreementUrl = null;&#10;        try {&#10;            if (systemConfigurationService != null) {&#10;                agreementUrl = systemConfigurationService.getStringValue(&#10;                        com.mmo.constant.SystemConfigKeys.POLICY_SELLER_AGREEMENT_URL,&#10;                        null&#10;                );&#10;            }&#10;        } catch (Exception ignored) {}&#10;        if (agreementUrl == null || agreementUrl.isBlank()) {&#10;            agreementUrl = &quot;/contracts/seller-contract.pdf&quot;; // default static file&#10;        }&#10;        model.addAttribute(&quot;sellerAgreementUrl&quot;, agreementUrl);&#10;&#10;        // Prefer shopStatus over legacy SellerRegistration flow&#10;        String shopStatus = user.getShopStatus();&#10;        model.addAttribute(&quot;shopStatus&quot;, shopStatus);&#10;        boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#10;        if (active) {&#10;            // Load ShopInfo and present as a synthetic 'registration' for view compatibility&#10;            ShopInfo shop = entityManager.createQuery(&quot;SELECT s FROM ShopInfo s WHERE s.user = :u AND s.isDelete = false&quot;, ShopInfo.class)&#10;                    .setParameter(&quot;u&quot;, user)&#10;                    .getResultStream().findFirst().orElse(null);&#10;            Map&lt;String, Object&gt; registration = new HashMap&lt;&gt;();&#10;            registration.put(&quot;id&quot;, 0L); // sentinel id so template renders status fragment&#10;            registration.put(&quot;status&quot;, &quot;Active&quot;);&#10;            registration.put(&quot;shopName&quot;, shop != null ? shop.getShopName() : (user.getFullName() != null ? user.getFullName() + &quot;'s Shop&quot; : &quot;My Shop&quot;));&#10;            registration.put(&quot;description&quot;, shop != null ? shop.getDescription() : &quot;&quot;);&#10;            model.addAttribute(&quot;registration&quot;, registration);&#10;            return &quot;customer/account-setting&quot;;&#10;        }&#10;&#10;        // Inactive: show registration form&#10;        if (!model.containsAttribute(&quot;sellerRegistration&quot;)) {&#10;            model.addAttribute(&quot;sellerRegistration&quot;, new SellerRegistrationForm());&#10;        }&#10;        return &quot;customer/account-setting&quot;;&#10;    }&#10;&#10;    @PostMapping(&quot;/register&quot;)&#10;    public String registerSeller(@Valid @ModelAttribute(&quot;sellerRegistration&quot;) SellerRegistrationForm sellerRegistration,&#10;                                 BindingResult bindingResult,&#10;                                 @RequestParam(value = &quot;agree&quot;, required = false) Boolean agree,&#10;                                 RedirectAttributes redirectAttributes) {&#10;        // Validate basic input&#10;        if (agree == null || !agree) {&#10;            redirectAttributes.addFlashAttribute(&quot;agreeError&quot;, &quot;You must agree to the Terms and Policy to continue.&quot;);&#10;        }&#10;        if (bindingResult.hasErrors() || (agree == null || !agree)) {&#10;            redirectAttributes.addFlashAttribute(&quot;org.springframework.validation.BindingResult.sellerRegistration&quot;, bindingResult);&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        // Resolve current user&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;        if (email == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please log in to continue.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;&#10;        // Optional soft check to provide faster feedback; final guard happens in the queue consumer&#10;        Long currentCoins = user.getCoins() == null ? 0L : user.getCoins();&#10;        if (currentCoins &lt; REGISTRATION_FEE &amp;&amp; (user.getShopStatus() == null || !user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;))) {&#10;            notificationService.createNotificationForUser(&#10;                    user.getId(),&#10;                    &quot;Seller registration failed&quot;,&#10;                    &quot;Insufficient balance. A fee of 200,000 coins is required to activate your seller account.&quot;&#10;            );&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Insufficient balance. 200,000 coins are required for seller registration.&quot;);&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        // Enqueue registration request for idempotent, atomic processing&#10;        String dedupeKey = UUID.randomUUID().toString();&#10;        com.mmo.mq.dto.SellerRegistrationMessage msg = new com.mmo.mq.dto.SellerRegistrationMessage(&#10;                user.getId(),&#10;                sellerRegistration.getShopName(),&#10;                sellerRegistration.getDescription(),&#10;                dedupeKey&#10;        );&#10;        try {&#10;            sellerRegistrationPublisher.publish(msg);&#10;        } catch (Exception ex) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to submit registration. Please try again later.&quot;);&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        // Inform the user; actual activation will be applied shortly by the consumer&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Your registration request has been submitted. Your shop will be activated shortly if requirements are met.&quot;);&#10;        return &quot;redirect:/seller/register&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/shop-info&quot;)&#10;    public String showShopInfo(Model model, RedirectAttributes redirectAttributes) {&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;        if (email == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#10;        if (!activeShop) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        ShopInfo shop = entityManager.createQuery(&quot;SELECT s FROM ShopInfo s WHERE s.user = :u AND s.isDelete = false&quot;, ShopInfo.class)&#10;                .setParameter(&quot;u&quot;, user)&#10;                .getResultStream().findFirst().orElse(null);&#10;&#10;        if (shop == null) {&#10;            // Fallback: create a lightweight view model when ShopInfo missing&#10;            ShopInfo fallback = new ShopInfo();&#10;            fallback.setShopName(user.getFullName() != null ? user.getFullName() + &quot;'s Shop&quot; : &quot;My Shop&quot;);&#10;            fallback.setDescription(&quot;&quot;);&#10;            model.addAttribute(&quot;shop&quot;, fallback);&#10;        } else {&#10;            model.addAttribute(&quot;shop&quot;, shop);&#10;        }&#10;        model.addAttribute(&quot;sellerEmail&quot;, user.getEmail());&#10;        model.addAttribute(&quot;shopStatus&quot;, user.getShopStatus());&#10;        return &quot;seller/shop-info&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/contract&quot;)&#10;    public ResponseEntity&lt;org.springframework.core.io.Resource&gt; downloadContract(@RequestParam(name = &quot;signed&quot;, defaultValue = &quot;false&quot;) boolean signed) {&#10;        // Legacy endpoint retained; not used in new auto-activation flow&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = (authentication != null) ? authentication.getName() : null;&#10;        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof OidcUser oidc) {&#10;            email = oidc.getEmail();&#10;        } else if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof OAuth2User ou) {&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;            if (mailAttr != null) email = mailAttr.toString();&#10;        }&#10;        if (email == null) return ResponseEntity.status(401).build();&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) return ResponseEntity.status(401).build();&#10;        // No contract in new flow&#10;        return ResponseEntity.status(HttpStatus.NOT_FOUND).build();&#10;    }&#10;&#10;    @PostMapping(value = &quot;/contract&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)&#10;    public String uploadSignedContract(@RequestParam(&quot;signed&quot;) MultipartFile file,&#10;                                       RedirectAttributes redirectAttributes) {&#10;        // Legacy endpoint retained; not used in new auto-activation flow&#10;        redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Contract upload is not required. Your shop is already active.&quot;);&#10;        return &quot;redirect:/seller/register&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/my-shop&quot;)&#10;    public String showMyShop(Model model, RedirectAttributes redirectAttributes) {&#10;        // Get current logged-in user&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;&#10;        if (email == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;&#10;        // Check if shop is active&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#10;        if (!activeShop) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        // Calculate statistics&#10;        Long sellerId = user.getId();&#10;&#10;        // Total revenue&#10;        Long totalRevenue = transactionRepository.getTotalRevenueBySellerId(sellerId);&#10;        if (totalRevenue == null) totalRevenue = 0L;&#10;&#10;        // Total orders&#10;        Long totalOrders = transactionRepository.getTotalOrdersBySellerId(sellerId);&#10;        if (totalOrders == null) totalOrders = 0L;&#10;&#10;        // Total products&#10;        Long totalProducts = productRepository.countBySellerId(sellerId);&#10;        if (totalProducts == null) totalProducts = 0L;&#10;&#10;        // Calculate last month's statistics for comparison&#10;        Calendar cal = Calendar.getInstance();&#10;        cal.add(Calendar.MONTH, -1);&#10;        Date lastMonth = cal.getTime();&#10;&#10;        Long lastMonthRevenue = transactionRepository.getRevenueBySellerIdAndDate(sellerId, lastMonth);&#10;        if (lastMonthRevenue == null) lastMonthRevenue = 0L;&#10;&#10;        Long lastMonthOrders = transactionRepository.getOrdersBySellerIdAndDate(sellerId, lastMonth);&#10;        if (lastMonthOrders == null) lastMonthOrders = 0L;&#10;&#10;        // Calculate percentage changes&#10;        double revenueChange = 0.0;&#10;        double ordersChange = 0.0;&#10;&#10;        if (totalRevenue &gt; 0 &amp;&amp; lastMonthRevenue &gt; 0) {&#10;            revenueChange = ((double)(totalRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;&#10;        }&#10;&#10;        if (totalOrders &gt; 0 &amp;&amp; lastMonthOrders &gt; 0) {&#10;            ordersChange = ((double)(totalOrders - lastMonthOrders) / lastMonthOrders) * 100;&#10;        }&#10;&#10;        // Get recent transactions (limit to 10)&#10;        List&lt;com.mmo.entity.Transaction&gt; recentTransactions = transactionRepository.findRecentTransactionsBySeller(sellerId);&#10;        if (recentTransactions.size() &gt; 10) {&#10;            recentTransactions = recentTransactions.subList(0, 10);&#10;        }&#10;&#10;        // Get top selling products (limit to 5)&#10;        List&lt;com.mmo.entity.Product&gt; topProducts = productRepository.findTopSellingProductsBySeller(&#10;            sellerId,&#10;            org.springframework.data.domain.PageRequest.of(0, 5)&#10;        );&#10;&#10;        // Calculate sales count and percentage for each product&#10;        List&lt;com.mmo.dto.TopProductDto&gt; topProductDtos = new ArrayList&lt;&gt;();&#10;        long totalSales = topProducts.stream()&#10;            .mapToLong(p -&gt; productRepository.countSalesForProduct(p.getId()))&#10;            .sum();&#10;&#10;        for (com.mmo.entity.Product product : topProducts) {&#10;            Long salesCount = productRepository.countSalesForProduct(product.getId());&#10;            if (salesCount == null) salesCount = 0L;&#10;&#10;            double percentage = 0.0;&#10;            if (totalSales &gt; 0) {&#10;                percentage = ((double) salesCount / totalSales) * 100;&#10;            }&#10;&#10;            com.mmo.dto.TopProductDto dto = new com.mmo.dto.TopProductDto(&#10;                product.getId(),&#10;                product.getName(),&#10;                product.getImage(),&#10;                salesCount,&#10;                percentage&#10;            );&#10;            topProductDtos.add(dto);&#10;        }&#10;&#10;        // Add statistics to model&#10;        model.addAttribute(&quot;totalRevenue&quot;, totalRevenue);&#10;        model.addAttribute(&quot;totalOrders&quot;, totalOrders);&#10;        model.addAttribute(&quot;totalProducts&quot;, totalProducts);&#10;        model.addAttribute(&quot;revenueChange&quot;, String.format(&quot;%.1f&quot;, Math.abs(revenueChange)));&#10;        model.addAttribute(&quot;revenueChangePositive&quot;, revenueChange &gt;= 0);&#10;        model.addAttribute(&quot;ordersChange&quot;, String.format(&quot;%.1f&quot;, Math.abs(ordersChange)));&#10;        model.addAttribute(&quot;ordersChangePositive&quot;, ordersChange &gt;= 0);&#10;        model.addAttribute(&quot;recentTransactions&quot;, recentTransactions);&#10;        model.addAttribute(&quot;topProducts&quot;, topProductDtos);&#10;&#10;        return &quot;seller/my-shop&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/withdraw-money&quot;)&#10;    public String showWithdrawMoneyPage(Model model, RedirectAttributes redirectAttributes) {&#10;        // Require logged-in and Active shop&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;        if (email == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#10;        if (!activeShop) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#10;            return &quot;redirect:/seller/register&quot;;&#10;        }&#10;&#10;        // Load coins&#10;        Long coins = user.getCoins() == null ? 0L : user.getCoins();&#10;        model.addAttribute(&quot;coins&quot;, coins);&#10;&#10;        // Load all bank infos for the user&#10;        model.addAttribute(&quot;bankInfos&quot;, sellerBankInfoService.findAllByUser(user));&#10;        // Supported banks list&#10;        model.addAttribute(&quot;supportedBanks&quot;, defaultBanks());&#10;        // Load existing bank info (robust to different mappings)&#10;        SellerBankInfo bankInfo = findBankInfoForOwner(user);&#10;        Map&lt;String, Object&gt; bank = new HashMap&lt;&gt;();&#10;        if (bankInfo != null) {&#10;            bank.put(&quot;id&quot;, tryGetId(bankInfo));&#10;            bank.put(&quot;bankName&quot;, tryGetString(bankInfo, &quot;getBankName&quot;));&#10;            bank.put(&quot;accountNumber&quot;, tryGetString(bankInfo, &quot;getAccountNumber&quot;));&#10;            bank.put(&quot;accountHolder&quot;, firstNonBlank(&#10;                    tryGetString(bankInfo, &quot;getAccountHolder&quot;),&#10;                    tryGetString(bankInfo, &quot;getAccountName&quot;),&#10;                    tryGetString(bankInfo, &quot;getHolderName&quot;),&#10;                    tryGetString(bankInfo, &quot;getBeneficiaryName&quot;),&#10;                    tryGetString(bankInfo, &quot;getOwnerName&quot;)&#10;            ));&#10;            bank.put(&quot;branch&quot;, tryGetString(bankInfo, &quot;getBranch&quot;));&#10;        }&#10;        model.addAttribute(&quot;bank&quot;, bank);&#10;        var withdrawals = entityManager.createQuery(&#10;                        &quot;SELECT w FROM Withdrawal w WHERE w.seller = :user ORDER BY w.createdAt DESC&quot;, Withdrawal.class)&#10;                .setParameter(&quot;user&quot;, user)&#10;                .getResultList();&#10;        model.addAttribute(&quot;withdrawals&quot;, withdrawals);&#10;        return &quot;seller/withdraw-money&quot;;&#10;    }&#10;&#10;    // NEW: Send OTP for withdrawal (asynchronous email via EmailService)&#10;    @PostMapping(path = &quot;/withdrawals/send-otp&quot;)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; sendWithdrawalOtp(Authentication authentication) {&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        String email = authentication.getName();&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;            if (mailAttr != null) email = mailAttr.toString();&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#10;        }&#10;        // Cooldown: avoid spamming OTP sends (min 60 seconds between sends)&#10;        try {&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#10;                if (seconds &lt; 60) {&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#10;                }&#10;            }&#10;        } catch (Exception ignored) {}&#10;&#10;        // Offload OTP creation + persistence + email to executor; return immediately&#10;        try {&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000)); // 5 minutes expiry&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] OTP Xác minh rút tiền&quot;;&#10;                    String html = EmailTemplate.withdrawalOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#10;    }&#10;&#10;    // NEW: Seller creates a withdrawal request&#10;    @PostMapping(path = &quot;/withdrawals&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#10;    @ResponseBody&#10;    @Transactional&#10;    public ResponseEntity&lt;?&gt; createWithdrawal(@RequestBody CreateWithdrawalRequest req,&#10;                                              Authentication authentication,&#10;                                              HttpSession session,&#10;                                              HttpServletRequest request) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;            User seller = userRepository.findByEmail(email).orElse(null);&#10;            if (seller == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;&#10;            boolean sellerRole = seller.getRole() != null &amp;&amp; seller.getRole().equalsIgnoreCase(&quot;SELLER&quot;);&#10;            boolean activeShop = seller.getShopStatus() != null &amp;&amp; seller.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#10;            if (!sellerRole &amp;&amp; !activeShop) {&#10;                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(&quot;Forbidden&quot;);&#10;            }&#10;&#10;            if (req == null || req.getAmount() == null || req.getAmount() &lt;= 0) {&#10;                return ResponseEntity.badRequest().body(&quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#10;            }&#10;            if (req.getAmount() &lt; 50_000L) {&#10;                return ResponseEntity.badRequest().body(&quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#10;            }&#10;            if (req.getBankInfoId() == null) {&#10;                return ResponseEntity.badRequest().body(&quot;MSG17: Bank information not found.&quot;);&#10;            }&#10;            if (req.getOtp() == null || !req.getOtp().matches(&quot;\\d{6}&quot;)) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#10;            }&#10;&#10;            // Pre-validate OTP to enforce attempts policy before enqueue&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(seller, req.getOtp());&#10;            if (optVerification.isEmpty()) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#10;            }&#10;            var verification = optVerification.get();&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#10;            }&#10;&#10;            // Success so far: clear attempts for this action&#10;            clearSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#10;&#10;            // Enqueue creation message; worker will validate OTP, balance, and persist&#10;            String dedupeKey = seller.getId() + &quot;:&quot; + req.getBankInfoId() + &quot;:&quot; + req.getAmount() + &quot;:&quot; + req.getOtp();&#10;            com.mmo.mq.dto.WithdrawalCreateMessage msg = new com.mmo.mq.dto.WithdrawalCreateMessage(&#10;                    seller.getId(),&#10;                    req.getBankInfoId(),&#10;                    req.getAmount(),&#10;                    req.getBankName(),&#10;                    req.getAccountNumber(),&#10;                    req.getAccountHolder(),&#10;                    req.getBranch(),&#10;                    req.getOtp(),&#10;                    dedupeKey&#10;            );&#10;            withdrawalQueuePublisher.publishCreate(msg);&#10;&#10;            // Do not persist or deduct coins here&#10;            return ResponseEntity.accepted().body(&quot;Withdrawal request has been queued and will appear shortly.&quot;);&#10;        } catch (Exception ex) {&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#10;        }&#10;    }&#10;&#10;    // NEW: Seller creates a withdrawal request (form submission)&#10;    @PostMapping(path = &quot;/withdrawals&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)&#10;    @Transactional&#10;    public String createWithdrawalForm(CreateWithdrawalRequest req,&#10;                                       Authentication authentication,&#10;                                       RedirectAttributes redirectAttributes,&#10;                                       HttpSession session,&#10;                                       HttpServletRequest request) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;            User seller = userRepository.findByEmail(email).orElse(null);&#10;            if (seller == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            boolean sellerRole = seller.getRole() != null &amp;&amp; seller.getRole().equalsIgnoreCase(&quot;SELLER&quot;);&#10;            boolean activeShop = seller.getShopStatus() != null &amp;&amp; seller.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#10;            if (!sellerRole &amp;&amp; !activeShop) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Forbidden&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;&#10;            if (req == null || req.getOtp() == null || !req.getOtp().matches(&quot;\\d{6}&quot;)) {&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#10;                if (attempts &gt;= 5) {&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#10;                    return &quot;redirect:/authen/login&quot;;&#10;                } else if (attempts &gt;= 3) {&#10;                    sendWithdrawalOtpForUser(seller);&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please enter the 6-digit OTP. A new OTP has been sent to your email.&quot;);&#10;                } else {&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please enter the 6-digit OTP sent to your email.&quot;);&#10;                }&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            if (req.getAmount() == null || req.getAmount() &lt; 50_000L) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            if (req.getBankInfoId() == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;MSG17: Bank information not found.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;&#10;            // Pre-validate OTP&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(seller, req.getOtp());&#10;            if (optVerification.isEmpty()) {&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#10;                if (attempts &gt;= 5) {&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#10;                    return &quot;redirect:/authen/login&quot;;&#10;                } else if (attempts &gt;= 3) {&#10;                    sendWithdrawalOtpForUser(seller);&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Incorrect OTP. A new OTP has been sent to your email.&quot;);&#10;                } else {&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Incorrect or used OTP.&quot;);&#10;                }&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            var verification = optVerification.get();&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#10;                if (attempts &gt;= 5) {&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#10;                    return &quot;redirect:/authen/login&quot;;&#10;                } else if (attempts &gt;= 3) {&#10;                    sendWithdrawalOtpForUser(seller);&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;OTP expired. A new OTP has been sent to your email.&quot;);&#10;                } else {&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;OTP has expired. Please request a new OTP.&quot;);&#10;                }&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;&#10;            // Success: clear attempts&#10;            clearSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#10;&#10;            String dedupeKey = seller.getId() + &quot;:&quot; + req.getBankInfoId() + &quot;:&quot; + req.getAmount() + &quot;:&quot; + req.getOtp();&#10;            com.mmo.mq.dto.WithdrawalCreateMessage msg = new com.mmo.mq.dto.WithdrawalCreateMessage(&#10;                    seller.getId(),&#10;                    req.getBankInfoId(),&#10;                    req.getAmount(),&#10;                    req.getBankName(),&#10;                    req.getAccountNumber(),&#10;                    req.getAccountHolder(),&#10;                    req.getBranch(),&#10;                    req.getOtp(),&#10;                    dedupeKey&#10;            );&#10;            withdrawalQueuePublisher.publishCreate(msg);&#10;&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Your withdrawal request has been queued and will appear shortly.&quot;);&#10;        } catch (Exception ex) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Internal error: &quot; + ex.getMessage());&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#10;        }&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/withdrawals/{id}&quot;)&#10;    public String viewWithdrawalDetail(@PathVariable Long id, Model model, Authentication authentication) {&#10;        // Lấy user hiện tại&#10;        String email = authentication.getName();&#10;        User user = userRepository.findByEmailAndIsDelete(email, false);&#10;        if (user == null) {&#10;            return &quot;redirect:/authen/login&quot;;&#10;        }&#10;        // Lấy withdrawal theo id&#10;        Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#10;        if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#10;            // Không tìm thấy hoặc không thuộc về user hiện tại&#10;            return &quot;redirect:/seller/withdraw-money?error=notfound&quot;;&#10;        }&#10;        model.addAttribute(&quot;withdrawal&quot;, withdrawal);&#10;        return &quot;seller/withdrawal-detail&quot;;&#10;    }&#10;&#10;    @GetMapping(&quot;/withdrawals/{id}/json&quot;)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; getWithdrawalDetailJson(@PathVariable Long id, Authentication authentication) {&#10;        String email = authentication.getName();&#10;        User user = userRepository.findByEmailAndIsDelete(email, false);&#10;        if (user == null) return ResponseEntity.status(401).body(&quot;Unauthorized&quot;);&#10;        Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#10;        if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#10;            return ResponseEntity.status(404).body(&quot;Not found&quot;);&#10;        }&#10;        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();&#10;        data.put(&quot;id&quot;, withdrawal.getId());&#10;        data.put(&quot;amount&quot;, withdrawal.getAmount());&#10;        data.put(&quot;status&quot;, withdrawal.getStatus());&#10;        data.put(&quot;bankName&quot;, withdrawal.getBankName());&#10;        data.put(&quot;accountNumber&quot;, withdrawal.getAccountNumber());&#10;        data.put(&quot;branch&quot;, withdrawal.getBranch());&#10;        data.put(&quot;createdAt&quot;, withdrawal.getCreatedAt());&#10;        return ResponseEntity.ok(data);&#10;    }&#10;&#10;    // Helpers to tolerate different SellerBankInfo mappings without adding new dependencies&#10;    private Long tryResolveOwnerId(SellerBankInfo bankInfo) {&#10;        try {&#10;            Object owner = bankInfo.getClass().getMethod(&quot;getSeller&quot;).invoke(bankInfo);&#10;            if (owner != null) {&#10;                Object id = owner.getClass().getMethod(&quot;getId&quot;).invoke(owner);&#10;                return id instanceof Long ? (Long) id : null;&#10;            }&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            Object owner = bankInfo.getClass().getMethod(&quot;getUser&quot;).invoke(bankInfo);&#10;            if (owner != null) {&#10;                Object id = owner.getClass().getMethod(&quot;getId&quot;).invoke(owner);&#10;                return id instanceof Long ? (Long) id : null;&#10;            }&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            Object id = bankInfo.getClass().getMethod(&quot;getUserId&quot;).invoke(bankInfo);&#10;            return id instanceof Long ? (Long) id : null;&#10;        } catch (Exception ignored) {&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private void tryCopyBankDisplayFields(SellerBankInfo bankInfo, Withdrawal wd) {&#10;        try {&#10;            Object bankName = bankInfo.getClass().getMethod(&quot;getBankName&quot;).invoke(bankInfo);&#10;            if (bankName instanceof String s) wd.setBankName(s);&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            Object acc = bankInfo.getClass().getMethod(&quot;getAccountNumber&quot;).invoke(bankInfo);&#10;            if (acc instanceof String s) wd.setAccountNumber(s);&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            Object br = bankInfo.getClass().getMethod(&quot;getBranch&quot;).invoke(bankInfo);&#10;            if (br instanceof String s) wd.setBranch(s);&#10;        } catch (Exception ignored) {&#10;        }&#10;        // Try to copy account holder / beneficiary name using several possible getter names&#10;        try {&#10;            String[] possibleGetters = new String[]{&quot;getAccountHolder&quot;, &quot;getAccountName&quot;, &quot;getHolderName&quot;, &quot;getBeneficiaryName&quot;, &quot;getOwnerName&quot;};&#10;            for (String g : possibleGetters) {&#10;                try {&#10;                    Object name = bankInfo.getClass().getMethod(g).invoke(bankInfo);&#10;                    if (name instanceof String s &amp;&amp; s != null &amp;&amp; !s.isBlank()) {&#10;                        wd.setAccountName(s);&#10;                        break;&#10;                    }&#10;                } catch (Exception ignored) {&#10;                }&#10;            }&#10;        } catch (Exception ignored) {&#10;        }&#10;    }&#10;&#10;    // Helper: find SellerBankInfo by owner using tolerant queries&#10;    private SellerBankInfo findBankInfoForOwner(User owner) {&#10;        Long uid = owner.getId();&#10;        String[] possibleFields = {&quot;seller.id&quot;, &quot;user.id&quot;, &quot;userId&quot;};&#10;&#10;        for (String field : possibleFields) {&#10;            try {&#10;                String hql = &quot;select b from SellerBankInfo b where b.&quot; + field + &quot; = :uid&quot;;&#10;                return entityManager.createQuery(hql, SellerBankInfo.class)&#10;                        .setParameter(&quot;uid&quot;, uid)&#10;                        .setMaxResults(1)&#10;                        .getSingleResult();&#10;            } catch (Exception ignored) {&#10;                // This query failed, try the next one&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // Helper: set owner relation via reflection&#10;    private void setOwner(SellerBankInfo bankInfo, User owner) {&#10;        try {&#10;            bankInfo.getClass().getMethod(&quot;setSeller&quot;, User.class).invoke(bankInfo, owner);&#10;            return;&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            bankInfo.getClass().getMethod(&quot;setUser&quot;, User.class).invoke(bankInfo, owner);&#10;            return;&#10;        } catch (Exception ignored) {&#10;        }&#10;        try {&#10;            bankInfo.getClass().getMethod(&quot;setUserId&quot;, Long.class).invoke(bankInfo, owner.getId());&#10;        } catch (Exception ignored) {&#10;        }&#10;    }&#10;&#10;    private Long tryGetId(SellerBankInfo bankInfo) {&#10;        try {&#10;            Object id = bankInfo.getClass().getMethod(&quot;getId&quot;).invoke(bankInfo);&#10;            if (id instanceof Long l) return l;&#10;        } catch (Exception ignored) {&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private boolean trySetString(Object target, String setterName, String value) {&#10;        try {&#10;            target.getClass().getMethod(setterName, String.class).invoke(target, value);&#10;            return true;&#10;        } catch (Exception ignored) {&#10;        }&#10;        return false;&#10;    }&#10;&#10;    private String tryGetString(Object target, String getterName) {&#10;        try {&#10;            Object v = target.getClass().getMethod(getterName).invoke(target);&#10;            return v != null ? v.toString() : null;&#10;        } catch (Exception ignored) {&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private String firstNonBlank(String... vals) {&#10;        if (vals == null) return null;&#10;        for (String s : vals) {&#10;            if (s != null &amp;&amp; !s.isBlank()) return s;&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // Danh sách tất cả bank info của user&#10;    @GetMapping(&quot;/bank-infos&quot;)&#10;    public String listBankInfos(Model model, RedirectAttributes redirectAttributes) {&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;        String email = null;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;            Object principal = authentication.getPrincipal();&#10;            if (principal instanceof UserDetails) {&#10;                email = ((UserDetails) principal).getUsername();&#10;            } else if (principal instanceof OidcUser) {&#10;                email = ((OidcUser) principal).getEmail();&#10;            } else if (principal instanceof OAuth2User) {&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            } else {&#10;                email = authentication.getName();&#10;            }&#10;        }&#10;        if (email == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;            return &quot;redirect:/login&quot;;&#10;        }&#10;        // Lấy tất cả bank info của user&#10;        var bankInfos = entityManager.createQuery(&#10;                        &quot;SELECT b FROM SellerBankInfo b WHERE b.user = :user AND b.isDelete = false&quot;, SellerBankInfo.class)&#10;                .setParameter(&quot;user&quot;, user)&#10;                .getResultList();&#10;        model.addAttribute(&quot;bankInfos&quot;, bankInfos);&#10;        return &quot;seller/bank-infos&quot;;&#10;    }&#10;&#10;    // Xem chi tiết 1 bank info&#10;    @GetMapping(&quot;/bank-info/{id}&quot;)&#10;    public String viewBankInfo(@PathVariable(&quot;id&quot;) Long id, Model model, RedirectAttributes redirectAttributes) {&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#10;            return &quot;redirect:/seller/bank-infos&quot;;&#10;        }&#10;        model.addAttribute(&quot;bankInfo&quot;, bankInfo);&#10;        return &quot;seller/bank-info-detail&quot;;&#10;    }&#10;&#10;    // Sửa bank info&#10;    @PostMapping(&quot;/bank-info/{id}/edit&quot;)&#10;    @Transactional&#10;    public String editBankInfo(@PathVariable(&quot;id&quot;) Long id,&#10;                               @RequestParam(&quot;bankName&quot;) String bankName,&#10;                               @RequestParam(&quot;accountNumber&quot;) String accountNumber,&#10;                               @RequestParam(value = &quot;accountHolder&quot;, required = false) String accountHolder,&#10;                               @RequestParam(value = &quot;branch&quot;, required = false) String branch,&#10;                               RedirectAttributes redirectAttributes) {&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#10;        }&#10;        bankInfo.setBankName(bankName);&#10;        bankInfo.setAccountNumber(accountNumber);&#10;        bankInfo.setAccountHolder(accountHolder);&#10;        bankInfo.setBranch(branch);&#10;        entityManager.merge(bankInfo);&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info updated successfully.&quot;);&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#10;    }&#10;&#10;    // Xóa bank info (soft delete)&#10;    @PostMapping(&quot;/bank-info/{id}/delete&quot;)&#10;    @Transactional&#10;    public String deleteBankInfo(@PathVariable(&quot;id&quot;) Long id, RedirectAttributes redirectAttributes) {&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#10;        }&#10;        bankInfo.setDelete(true);&#10;        entityManager.merge(bankInfo);&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info deleted successfully.&quot;);&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#10;    }&#10;&#10;    // Thêm mới bank info&#10;    @PostMapping(&quot;/bank-info/add&quot;)&#10;    @Transactional&#10;    public String addBankInfo(@RequestParam(&quot;bankName&quot;) String bankName,&#10;                              @RequestParam(&quot;accountNumber&quot;) String accountNumber,&#10;                              @RequestParam(value = &quot;accountHolder&quot;, required = false) String accountHolder,&#10;                              @RequestParam(value = &quot;branch&quot;, required = false) String branch,&#10;                              RedirectAttributes redirectAttributes) {&#10;        try {&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;            String email = null;&#10;            if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#10;                Object principal = authentication.getPrincipal();&#10;                if (principal instanceof UserDetails) {&#10;                    email = ((UserDetails) principal).getUsername();&#10;                } else if (principal instanceof OidcUser) {&#10;                    email = ((OidcUser) principal).getEmail();&#10;                } else if (principal instanceof OAuth2User) {&#10;                    Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#10;                    if (mailAttr != null) email = mailAttr.toString();&#10;                } else {&#10;                    email = authentication.getName();&#10;                }&#10;            }&#10;            if (email == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#10;                return &quot;redirect:/login&quot;;&#10;            }&#10;            User user = userRepository.findByEmail(email).orElse(null);&#10;            if (user == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#10;                return &quot;redirect:/login&quot;;&#10;            }&#10;            SellerBankInfo bankInfo = new SellerBankInfo();&#10;            bankInfo.setUser(user);&#10;            bankInfo.setBankName(bankName);&#10;            bankInfo.setAccountNumber(accountNumber);&#10;            bankInfo.setAccountHolder(accountHolder);&#10;            bankInfo.setBranch(branch);&#10;            bankInfo.setDelete(false);&#10;            entityManager.persist(bankInfo);&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info added successfully.&quot;);&#10;        } catch (Exception ex) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to add bank info: &quot; + ex.getMessage());&#10;        }&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#10;    }&#10;&#10;    // Helper DTO for supported bank options (matches template usage: b.displayName)&#10;    private static class BankOption {&#10;        private final String displayName;&#10;        BankOption(String displayName) { this.displayName = displayName; }&#10;        public String getDisplayName() { return displayName; }&#10;    }&#10;    private List&lt;BankOption&gt; defaultBanks() {&#10;        return Arrays.asList(&#10;                new BankOption(&quot;Vietcombank&quot;),&#10;                new BankOption(&quot;Techcombank&quot;),&#10;                new BankOption(&quot;VietinBank&quot;),&#10;                new BankOption(&quot;BIDV&quot;),&#10;                new BankOption(&quot;Agribank&quot;),&#10;                new BankOption(&quot;MB Bank&quot;),&#10;                new BankOption(&quot;ACB&quot;),&#10;                new BankOption(&quot;Sacombank&quot;),&#10;                new BankOption(&quot;TPBank&quot;),&#10;                new BankOption(&quot;VPBank&quot;)&#10;        );&#10;    }&#10;&#10;    @PostMapping(&quot;/withdrawals/{id}/update-bank&quot;)&#10;    @Transactional&#10;    public String updateWithdrawalBankInfo(@PathVariable Long id,&#10;                                           @RequestParam String bankName,&#10;                                           @RequestParam String accountNumber,&#10;                                           @RequestParam(name = &quot;accountHolder&quot;) String accountHolder,&#10;                                           @RequestParam(name = &quot;branch&quot;, required = false) String branch,&#10;                                           Authentication authentication,&#10;                                           RedirectAttributes redirectAttributes) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.oidc.user.OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.user.OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;            User user = userRepository.findByEmailAndIsDelete(email, false);&#10;            if (user == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#10;            if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Withdrawal not found.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            // Only allow when Pending and within 24 hours since createdAt&#10;            Date createdAt = withdrawal.getCreatedAt();&#10;            if (createdAt == null) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;This withdrawal cannot be edited at this time.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            long diffMs = System.currentTimeMillis() - createdAt.getTime();&#10;            boolean within24h = diffMs &lt;= 24L * 60L * 60L * 1000L;&#10;//            boolean within24h = diffMs &lt;= 2L * 60L * 1000L;&#10;            String status = withdrawal.getStatus();&#10;            boolean isPending = status != null &amp;&amp; status.equalsIgnoreCase(&quot;Pending&quot;);&#10;            if (!isPending || !within24h) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;You can only update bank info within 24h for pending withdrawals.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            // Normalize and validate non-blank fields&#10;            String bn = bankName == null ? null : bankName.trim();&#10;            String an = accountNumber == null ? null : accountNumber.trim();&#10;            String ah = accountHolder == null ? null : accountHolder.trim();&#10;            String br = branch == null ? null : branch.trim();&#10;            if (bn == null || bn.isEmpty() || an == null || an.isEmpty() || ah == null || ah.isEmpty()) {&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank Name, Account Number, and Account Holder cannot be empty.&quot;);&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#10;            }&#10;            // Update allowed fields only&#10;            withdrawal.setBankName(bn);&#10;            withdrawal.setAccountNumber(an);&#10;            withdrawal.setAccountName(ah);&#10;            if (br != null) {&#10;                withdrawal.setBranch(br);&#10;            }&#10;            entityManager.merge(withdrawal);&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info updated successfully.&quot;);&#10;        } catch (Exception ex) {&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to update bank info: &quot; + ex.getMessage());&#10;        }&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#10;    }&#10;&#10;    // NEW: Seller creates a withdrawal request (JSON payload)&#10;    @PostMapping(path = &quot;/withdrawals/{id}/update-bank&quot;, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)&#10;    @ResponseBody&#10;    @Transactional&#10;    public ResponseEntity&lt;?&gt; updateWithdrawalBankInfoJson(@PathVariable Long id,&#10;                                                          @RequestBody Map&lt;String, Object&gt; body,&#10;                                                          Authentication authentication,&#10;                                                          HttpSession session,&#10;                                                          HttpServletRequest request) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.oidc.user.OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.user.OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;            User user = userRepository.findByEmailAndIsDelete(email, false);&#10;            if (user == null) return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;&#10;            Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#10;            if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#10;                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Withdrawal not found&quot;);&#10;            }&#10;            Date createdAt = withdrawal.getCreatedAt();&#10;            if (createdAt == null) return ResponseEntity.badRequest().body(&quot;This withdrawal cannot be edited at this time.&quot;);&#10;            long diffMs = System.currentTimeMillis() - createdAt.getTime();&#10;            boolean within24h = diffMs &lt;= 24L * 60L * 60L * 1000L;&#10;            String status = withdrawal.getStatus();&#10;            boolean isPending = status != null &amp;&amp; status.equalsIgnoreCase(&quot;Pending&quot;);&#10;            if (!isPending || !within24h) {&#10;                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(&quot;You can only update bank info within 24h for pending withdrawals.&quot;);&#10;            }&#10;&#10;            String bankName = body.get(&quot;bankName&quot;) != null ? body.get(&quot;bankName&quot;).toString() : null;&#10;            String accountNumber = body.get(&quot;accountNumber&quot;) != null ? body.get(&quot;accountNumber&quot;).toString() : null;&#10;            String accountHolder = body.get(&quot;accountHolder&quot;) != null ? body.get(&quot;accountHolder&quot;).toString() : null;&#10;            String branch = body.get(&quot;branch&quot;) != null ? body.get(&quot;branch&quot;).toString() : null;&#10;            String otp = body.get(&quot;otp&quot;) != null ? body.get(&quot;otp&quot;).toString() : null;&#10;            if (bankName == null || bankName.isBlank() || accountNumber == null || accountNumber.isBlank() || accountHolder == null || accountHolder.isBlank()) {&#10;                return ResponseEntity.badRequest().body(&quot;bankName, accountNumber, and accountHolder are required&quot;);&#10;            }&#10;            // Require and verify OTP (6 digits)&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#10;            }&#10;            // Lookup latest unused OTP for this user/code&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#10;            if (optVerification.isEmpty()) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#10;            }&#10;            var verification = optVerification.get();&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#10;            }&#10;&#10;            // Build old/new info for email&#10;            String oldInfo = String.format(&quot;%s - %s (%s)%s&quot;,&#10;                    safeString(withdrawal.getBankName()),&#10;                    safeString(withdrawal.getAccountNumber()),&#10;                    safeString(withdrawal.getAccountName()),&#10;                    withdrawal.getBranch() != null &amp;&amp; !withdrawal.getBranch().isBlank() ? (&quot; - &quot; + withdrawal.getBranch()) : &quot;&quot;);&#10;            String newInfo = String.format(&quot;%s - %s (%s)%s&quot;,&#10;                    bankName.trim(),&#10;                    accountNumber.trim(),&#10;                    accountHolder.trim(),&#10;                    branch != null &amp;&amp; !branch.isBlank() ? (&quot; - &quot; + branch.trim()) : &quot;&quot;);&#10;&#10;            // Update allowed fields only&#10;            withdrawal.setBankName(bankName.trim());&#10;            withdrawal.setAccountNumber(accountNumber.trim());&#10;            withdrawal.setAccountName(accountHolder.trim());&#10;            if (branch != null) {&#10;                withdrawal.setBranch(branch.trim());&#10;            }&#10;            entityManager.merge(withdrawal);&#10;&#10;            // Mark OTP as used&#10;            verification.setUsed(true);&#10;            emailVerificationRepository.save(verification);&#10;&#10;            // Clear attempts on success&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;withdraw_update&quot;);&#10;&#10;            // Send async email notify&#10;            try {&#10;                String userName = user.getFullName() != null ? user.getFullName() : (user.getEmail() != null ? user.getEmail() : &quot;User&quot;);&#10;                String updatedAt = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;).format(new Date());&#10;                String html = EmailTemplate.withdrawalBankInfoUpdatedEmail(userName, oldInfo, newInfo, updatedAt);&#10;                String subject = &quot;[MMOMarket] Cập nhật thông tin ngân hàng rút tiền&quot;;&#10;                if (user.getEmail() != null &amp;&amp; !user.getEmail().isBlank()) {&#10;                    emailService.sendEmailAsync(user.getEmail(), subject, html);&#10;                }&#10;            } catch (Exception ignored) {}&#10;&#10;            Map&lt;String, Object&gt; res = new HashMap&lt;&gt;();&#10;            res.put(&quot;message&quot;, &quot;Bank info updated successfully&quot;);&#10;            res.put(&quot;id&quot;, withdrawal.getId());&#10;            res.put(&quot;bankName&quot;, withdrawal.getBankName());&#10;            res.put(&quot;accountNumber&quot;, withdrawal.getAccountNumber());&#10;            res.put(&quot;accountHolder&quot;, withdrawal.getAccountName());&#10;            res.put(&quot;branch&quot;, withdrawal.getBranch());&#10;            return ResponseEntity.ok(res);&#10;        } catch (Exception ex) {&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#10;        }&#10;    }&#10;&#10;    // NEW: Send OTP for shop deletion verification&#10;    @PostMapping(path = &quot;/delete-shop/send-otp&quot;)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; sendDeleteShopOtp(Authentication authentication) {&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        String email = authentication.getName();&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;            if (mailAttr != null) email = mailAttr.toString();&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#10;        }&#10;&#10;        // Check if shop is active&#10;        String shopStatus = user.getShopStatus();&#10;        boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#10;        if (!active) {&#10;            return ResponseEntity.badRequest().body(&quot;Your shop is not in Active status.&quot;);&#10;        }&#10;&#10;        // Cooldown: avoid spamming OTP sends (min 60 seconds between sends)&#10;        try {&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#10;                if (seconds &lt; 60) {&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#10;                }&#10;            }&#10;        } catch (Exception ignored) {}&#10;&#10;        // Offload OTP creation + persistence + email to executor; return immediately&#10;        try {&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000)); // 5 minutes expiry&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] Confirm Shop Cancellation (OTP)&quot;;&#10;                    String html = EmailTemplate.deleteShopOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#10;    }&#10;&#10;    // NEW: Check delete-shop conditions before showing OTP modal&#10;    @GetMapping(path = &quot;/delete-shop/check&quot;)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; checkDeleteShopConditions(Authentication authentication) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#10;            }&#10;&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#10;            if (user == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#10;            }&#10;&#10;            // Check if shop is active&#10;            String shopStatus = user.getShopStatus();&#10;            boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#10;            if (!active) {&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Your shop is not in Active status.&quot;));&#10;            }&#10;&#10;            // Business rule a.2: Coins must be 0&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#10;            if (coins != 0L) {&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You must withdraw all your Coins balance to 0 before deleting your shop.&quot;));&#10;            }&#10;&#10;            // Business rule a.1: No listed products&#10;            Long remainingProducts = entityManager.createQuery(&#10;                    &quot;SELECT COUNT(p) FROM Product p WHERE p.seller.id = :sellerId AND p.isDelete = false&quot;, Long.class)&#10;                .setParameter(&quot;sellerId&quot;, user.getId())&#10;                .getSingleResult();&#10;            if (remainingProducts != null &amp;&amp; remainingProducts &gt; 0) {&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You must remove all listed products before deleting your shop.&quot;));&#10;            }&#10;&#10;            // Business rule a.3: Not temporarily locked or unresolved policy violation&#10;            if (shopStatus.equalsIgnoreCase(&quot;Suspended&quot;) || shopStatus.equalsIgnoreCase(&quot;Banned&quot;) || shopStatus.equalsIgnoreCase(&quot;Locked&quot;)) {&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Your account is temporarily locked or has policy violations. Cannot delete shop.&quot;));&#10;            }&#10;&#10;            // All conditions met&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, true, &quot;message&quot;, &quot;All conditions met. You can proceed.&quot;));&#10;        } catch (Exception ex) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Internal error: &quot; + ex.getMessage()));&#10;        }&#10;    }&#10;&#10;    // NEW: Delete shop with OTP verification (JSON endpoint)&#10;    @PostMapping(path = &quot;/delete-shop&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#10;    @ResponseBody&#10;    @Transactional&#10;    public ResponseEntity&lt;?&gt; deleteShopWithOtp(@RequestBody Map&lt;String, String&gt; payload,&#10;                                               Authentication authentication,&#10;                                               HttpSession session,&#10;                                               HttpServletRequest request) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#10;            if (user == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;&#10;            // Must have an active shop to delete&#10;            String shopStatus = user.getShopStatus();&#10;            boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#10;            if (!active) {&#10;                return ResponseEntity.badRequest().body(&quot;Your shop is not in Active status.&quot;);&#10;            }&#10;&#10;            // Validate OTP&#10;            String otp = payload != null ? payload.get(&quot;otp&quot;) : null;&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_REQUIRED&quot;);&#10;            }&#10;&#10;            // Verify OTP&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#10;            if (optVerification.isEmpty()) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_INVALID&quot;);&#10;            }&#10;            var verification = optVerification.get();&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_EXPIRED&quot;);&#10;            }&#10;&#10;            // Mark OTP as used&#10;            verification.setUsed(true);&#10;            emailVerificationRepository.save(verification);&#10;&#10;            // Clear OTP attempts&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;delete_shop&quot;);&#10;&#10;            // Business rule a.2: Coins must be 0&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#10;            if (coins != 0L) {&#10;                return ResponseEntity.badRequest().body(&quot;You must withdraw all your Coins balance to 0 before deleting your shop.&quot;);&#10;            }&#10;&#10;            // Business rule a.1: No listed products — ensure no non-deleted products remain&#10;            Long remainingProducts = entityManager.createQuery(&#10;                    &quot;SELECT COUNT(p) FROM Product p WHERE p.seller.id = :sellerId AND p.isDelete = false&quot;, Long.class)&#10;                .setParameter(&quot;sellerId&quot;, user.getId())&#10;                .getSingleResult();&#10;            if (remainingProducts != null &amp;&amp; remainingProducts &gt; 0) {&#10;                return ResponseEntity.badRequest().body(&quot;You must remove all listed products before deleting your shop.&quot;);&#10;            }&#10;&#10;            // Business rule a.3: Not temporarily locked or unresolved policy violation&#10;            if (shopStatus != null &amp;&amp; (shopStatus.equalsIgnoreCase(&quot;Suspended&quot;) || shopStatus.equalsIgnoreCase(&quot;Banned&quot;) || shopStatus.equalsIgnoreCase(&quot;Locked&quot;))) {&#10;                return ResponseEntity.badRequest().body(&quot;Your account is temporarily locked or has policy violations. Cannot delete shop.&quot;);&#10;            }&#10;&#10;            // All conditions satisfied -&gt; perform soft delete cascade (immediate and irreversible)&#10;            Long uid = user.getId();&#10;            Long sellerId = user.getId();&#10;&#10;            // Soft delete delivered accounts/inventory first to avoid FK constraints&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE ProductVariantAccount a SET a.isDelete = true, a.deletedBy = :uid &quot; +&#10;                            &quot;WHERE a.isDelete = false AND a.variant.id IN (SELECT v.id FROM ProductVariant v WHERE v.product.seller.id = :sellerId)&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete reviews of seller's products&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE Review r SET r.isDelete = true, r.deletedBy = :uid WHERE r.isDelete = false AND r.product.seller.id = :sellerId&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete transactions of this seller&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE Transaction t SET t.isDelete = true, t.deletedBy = :uid WHERE t.isDelete = false AND t.seller.id = :sellerId&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete product variants&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE ProductVariant v SET v.isDelete = true, v.deletedBy = :uid WHERE v.isDelete = false AND v.product.seller.id = :sellerId&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete products&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE Product p SET p.isDelete = true, p.deletedBy = :uid WHERE p.isDelete = false AND p.seller.id = :sellerId&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete seller bank info&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE SellerBankInfo s SET s.isDelete = true, s.deletedBy = :uid WHERE s.isDelete = false AND s.user.id = :sellerId&quot;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Soft delete ShopInfo - Note: ShopInfo.deletedBy is a User entity, not Long&#10;            entityManager.createQuery(&#10;                    &quot;UPDATE ShopInfo s SET s.isDelete = true, s.deletedBy = :userEntity WHERE s.isDelete = false AND s.user.id = :sellerId&quot;&#10;            ).setParameter(&quot;userEntity&quot;, user).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#10;&#10;            // Set shopStatus back to Inactive&#10;            try {&#10;                user.setShopStatus(&quot;Inactive&quot;);&#10;                userRepository.save(user);&#10;            } catch (Exception ignored) {}&#10;&#10;            // Create notification for user&#10;            try {&#10;                notificationService.createNotificationForUser(&#10;                    user.getId(),&#10;                    &quot;Shop Registration Cancelled&quot;,&#10;                    &quot;Your shop has been successfully cancelled. You can register a new shop again at any time.&quot;&#10;                );&#10;            } catch (Exception e) {&#10;                // Log error but don't fail the operation&#10;                System.err.println(&quot;Failed to create notification: &quot; + e.getMessage());&#10;            }&#10;&#10;            return ResponseEntity.ok(&quot;Shop has been successfully cancelled.&quot;);&#10;        } catch (Exception ex) {&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#10;        }&#10;    }&#10;&#10;    // NEW: Buy Points - send OTP&#10;    @PostMapping(path = &quot;/buy-points/send-otp&quot;)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; sendBuyPointsOtp(Authentication authentication) {&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        String email = authentication.getName();&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;            if (mailAttr != null) email = mailAttr.toString();&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;        }&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#10;        }&#10;        // Cooldown&#10;        try {&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#10;                if (seconds &lt; 60) {&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#10;                }&#10;            }&#10;        } catch (Exception ignored) {}&#10;&#10;        try {&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] Confirm Points Purchase (OTP)&quot;;&#10;                    String html = EmailTemplate.buyPointsOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#10;    }&#10;&#10;    // NEW: Buy Points - quote how many points/cost to reach a target level&#10;    @GetMapping(path = &quot;/buy-points/quote&quot;, produces = MediaType.APPLICATION_JSON_VALUE)&#10;    @ResponseBody&#10;    public ResponseEntity&lt;?&gt; quoteBuyPoints(@RequestParam(name = &quot;targetLevel&quot;, required = false) Integer targetLevel,&#10;                                            Authentication authentication) {&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#10;        }&#10;        String email = authentication.getName();&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;            if (mailAttr != null) email = mailAttr.toString();&#10;        }&#10;        User user = userRepository.findByEmail(email).orElse(null);&#10;        if (user == null) {&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#10;        }&#10;        ShopInfo shop = shopInfoRepository.findByUserIdAndIsDeleteFalse(user.getId()).orElseGet(() -&gt; shopInfoRepository.findByUser_Id(user.getId()).orElse(null));&#10;        if (shop == null) {&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Shop not found.&quot;));&#10;        }&#10;        long currentPoints = shop.getPoints() == null ? 0L : shop.getPoints();&#10;        short currentLevel = shop.getShopLevel() == null ? 0 : shop.getShopLevel();&#10;        int desired = (targetLevel == null || targetLevel &lt; currentLevel + 1) ? (currentLevel + 1) : Math.min(targetLevel, 7);&#10;        long threshold = levelThreshold(desired);&#10;        if (desired &lt;= currentLevel) {&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You already meet or exceed the selected level.&quot;, &quot;currentLevel&quot;, currentLevel));&#10;        }&#10;        long neededPoints = Math.max(0L, threshold - currentPoints);&#10;        long costCoins = neededPoints; // 1 coin per point&#10;        long coins = user.getCoins() == null ? 0L : user.getCoins();&#10;        boolean enough = coins &gt;= costCoins;&#10;        long shortfall = enough ? 0L : (costCoins - coins);&#10;        return ResponseEntity.ok(Map.of(&#10;                &quot;ok&quot;, true,&#10;                &quot;currentLevel&quot;, currentLevel,&#10;                &quot;currentPoints&quot;, currentPoints,&#10;                &quot;targetLevel&quot;, desired,&#10;                &quot;targetThreshold&quot;, threshold,&#10;                &quot;neededPoints&quot;, neededPoints,&#10;                &quot;costCoins&quot;, costCoins,&#10;                &quot;coins&quot;, coins,&#10;                &quot;enough&quot;, enough,&#10;                &quot;shortfall&quot;, shortfall&#10;        ));&#10;    }&#10;&#10;    private long levelThreshold(int level) {&#10;        return switch (level) {&#10;            case 1 -&gt; 1_000_000L;&#10;            case 2 -&gt; 3_000_000L;&#10;            case 3 -&gt; 5_000_000L;&#10;            case 4 -&gt; 10_000_000L;&#10;            case 5 -&gt; 20_000_000L;&#10;            case 6 -&gt; 40_000_000L;&#10;            case 7 -&gt; 50_000_000L;&#10;            default -&gt; 0L;&#10;        };&#10;    }&#10;&#10;    // NEW: Buy Points - submit purchase request with OTP&#10;    @PostMapping(path = &quot;/buy-points&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#10;    @ResponseBody&#10;    @Transactional&#10;    public ResponseEntity&lt;?&gt; buyPoints(@RequestBody Map&lt;String, Object&gt; body,&#10;                                       Authentication authentication,&#10;                                       HttpSession session,&#10;                                       HttpServletRequest request) {&#10;        try {&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;            String email = authentication.getName();&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#10;                if (mailAttr != null) email = mailAttr.toString();&#10;            }&#10;            User user = userRepository.findByEmail(email).orElse(null);&#10;            if (user == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#10;            }&#10;            ShopInfo shop = shopInfoRepository.findByUserIdAndIsDeleteFalse(user.getId()).orElseGet(() -&gt; shopInfoRepository.findByUser_Id(user.getId()).orElse(null));&#10;            if (shop == null) return ResponseEntity.badRequest().body(&quot;Shop not found.&quot;);&#10;&#10;            String otp = body.get(&quot;otp&quot;) != null ? body.get(&quot;otp&quot;).toString() : null;&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#10;            }&#10;            // Pre-validate OTP&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#10;            if (optVerification.isEmpty()) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#10;            }&#10;            var verification = optVerification.get();&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#10;            }&#10;&#10;            // Parse pointsToBuy or targetLevel&#10;            Long pointsToBuy = null;&#10;            if (body.get(&quot;pointsToBuy&quot;) instanceof Number n) {&#10;                pointsToBuy = n.longValue();&#10;            } else if (body.get(&quot;targetLevel&quot;) instanceof Number lv) {&#10;                int desired = Math.min(7, Math.max(shop.getShopLevel() == null ? 0 : (shop.getShopLevel() + 1), lv.intValue()));&#10;                long threshold = levelThreshold(desired);&#10;                long currentPoints = shop.getPoints() == null ? 0L : shop.getPoints();&#10;                long need = Math.max(0L, threshold - currentPoints);&#10;                pointsToBuy = need;&#10;            }&#10;            if (pointsToBuy == null || pointsToBuy &lt;= 0) {&#10;                return ResponseEntity.badRequest().body(&quot;Invalid pointsToBuy.&quot;);&#10;            }&#10;&#10;            // Pre-check sufficient coins to avoid unnecessary OTP/queue&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#10;            if (coins &lt; pointsToBuy) {&#10;                long shortfall = pointsToBuy - coins;&#10;                return ResponseEntity.badRequest().body(&quot;Insufficient coins. Please top up at least &quot; + String.format(&quot;%,d&quot;, shortfall) + &quot; coins.&quot;);&#10;            }&#10;&#10;            // Success so far: clear attempts&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;buy_points&quot;);&#10;&#10;            String dedupeKey = user.getId() + &quot;:&quot; + pointsToBuy + &quot;:&quot; + otp;&#10;            com.mmo.mq.dto.BuyPointsMessage msg = new com.mmo.mq.dto.BuyPointsMessage(&#10;                    user.getId(),&#10;                    pointsToBuy,&#10;                    pointsToBuy, // cost 1:1&#10;                    otp,&#10;                    dedupeKey&#10;            );&#10;            buyPointsPublisher.publish(msg);&#10;            return ResponseEntity.accepted().body(&quot;Your points purchase request has been queued. It will be applied shortly.&quot;);&#10;        } catch (Exception ex) {&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#10;        }&#10;    }&#10;&#10;    private void sendWithdrawalOtpForUser(User user) {&#10;        try {&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] OTP Xác minh rút tiền&quot;;&#10;                    String html = EmailTemplate.withdrawalOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;    }&#10;    private void sendDeleteShopOtpForUser(User user) {&#10;        try {&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] Confirm Shop Cancellation (OTP)&quot;;&#10;                    String html = EmailTemplate.deleteShopOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;    }&#10;    private void sendBuyPointsOtpForUser(User user) {&#10;        try {&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#10;            User target = user;&#10;            emailExecutor.execute(() -&gt; {&#10;                try {&#10;                    String code = authService.generateVerificationCode();&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#10;                    verification.setUser(target);&#10;                    verification.setVerificationCode(code);&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#10;                    verification.setUsed(false);&#10;                    emailVerificationRepository.save(verification);&#10;                    String subject = &quot;[MMOMarket] Confirm Points Purchase (OTP)&quot;;&#10;                    String html = EmailTemplate.buyPointsOtpEmail(code);&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#10;                } catch (Exception ignored) { }&#10;            });&#10;        } catch (Exception ignored) { }&#10;    }&#10;    private ResponseEntity&lt;String&gt; handleOtpFailForWithdraw(HttpSession session, HttpServletRequest request, Authentication authentication, User user, Long uid, String action, String baseMessage) {&#10;        int attempts = incSellerOtpAttempts(session, uid, action);&#10;        if (attempts &gt;= 5) {&#10;            try {&#10;                new SecurityContextLogoutHandler().logout(request, null, authentication);&#10;            } catch (Exception ignored) { }&#10;            try { session.invalidate(); } catch (Exception ignored) { }&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#10;        } else if (attempts &gt;= 3) {&#10;            try {&#10;                if (action != null &amp;&amp; action.startsWith(&quot;withdraw&quot;)) {&#10;                    sendWithdrawalOtpForUser(user);&#10;                } else if (action != null &amp;&amp; action.startsWith(&quot;delete_shop&quot;)) {&#10;                    sendDeleteShopOtpForUser(user);&#10;                } else if (action != null &amp;&amp; action.startsWith(&quot;buy_points&quot;)) {&#10;                    sendBuyPointsOtpForUser(user);&#10;                } else {&#10;                    sendWithdrawalOtpForUser(user);&#10;                }&#10;            } catch (Exception ignored) {}&#10;            return ResponseEntity.badRequest().body(baseMessage + &quot; A new OTP has been sent to your email. Please use the latest OTP.&quot;);&#10;        } else {&#10;            return ResponseEntity.badRequest().body(baseMessage);&#10;        }&#10;    }&#10;&#10;    // Helpers for OTP attempt tracking per action&#10;    private String sellerOtpAttemptsKey(Long uid, String action) {&#10;        return &quot;sellerOtpAttempts:&quot; + uid + &quot;:&quot; + action;&#10;    }&#10;    private int incSellerOtpAttempts(HttpSession session, Long uid, String action) {&#10;        String key = sellerOtpAttemptsKey(uid, action);&#10;        Integer cur = (Integer) session.getAttribute(key);&#10;        int next = (cur == null ? 0 : cur) + 1;&#10;        session.setAttribute(key, next);&#10;        return next;&#10;    }&#10;    private void clearSellerOtpAttempts(HttpSession session, Long uid, String action) {&#10;        session.removeAttribute(sellerOtpAttemptsKey(uid, action));&#10;    }&#10;    private static String safeString(Object s) {&#10;        return s == null ? &quot;&quot; : s.toString();&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.mmo.controller;&#13;&#10;&#13;&#10;import com.mmo.dto.CreateWithdrawalRequest;&#13;&#10;import com.mmo.dto.SellerRegistrationForm;&#13;&#10;import com.mmo.dto.SellerWithdrawalResponse;&#13;&#10;import com.mmo.entity.SellerBankInfo;&#13;&#10;import com.mmo.entity.ShopInfo;&#13;&#10;import com.mmo.entity.User;&#13;&#10;import com.mmo.entity.Withdrawal;&#13;&#10;import com.mmo.repository.UserRepository;&#13;&#10;import com.mmo.service.EmailService;&#13;&#10;import com.mmo.service.NotificationService;&#13;&#10;import com.mmo.service.SellerBankInfoService;&#13;&#10;import com.mmo.service.SystemConfigurationService;&#13;&#10;import com.mmo.util.EmailTemplate;&#13;&#10;import jakarta.persistence.EntityManager;&#13;&#10;import jakarta.persistence.PersistenceContext;&#13;&#10;import jakarta.servlet.http.HttpServletRequest;&#13;&#10;import jakarta.servlet.http.HttpSession;&#13;&#10;import jakarta.validation.Valid;&#13;&#10;import org.springframework.beans.factory.annotation.Autowired;&#13;&#10;import org.springframework.beans.factory.annotation.Qualifier;&#13;&#10;import org.springframework.http.HttpStatus;&#13;&#10;import org.springframework.http.MediaType;&#13;&#10;import org.springframework.http.ResponseEntity;&#13;&#10;import org.springframework.security.core.Authentication;&#13;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#13;&#10;import org.springframework.security.core.userdetails.UserDetails;&#13;&#10;import org.springframework.security.oauth2.core.oidc.user.OidcUser;&#13;&#10;import org.springframework.security.oauth2.core.user.OAuth2User;&#13;&#10;import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;&#13;&#10;import org.springframework.stereotype.Controller;&#13;&#10;import org.springframework.transaction.annotation.Transactional;&#13;&#10;import org.springframework.ui.Model;&#13;&#10;import org.springframework.validation.BindingResult;&#13;&#10;import org.springframework.web.bind.annotation.*;&#13;&#10;import org.springframework.web.multipart.MultipartFile;&#13;&#10;import org.springframework.web.servlet.mvc.support.RedirectAttributes;&#13;&#10;&#13;&#10;import java.math.BigDecimal;&#13;&#10;import java.text.SimpleDateFormat;&#13;&#10;import java.util.*;&#13;&#10;import java.util.concurrent.Executor;&#13;&#10;import java.util.Calendar;&#13;&#10;&#13;&#10;@Controller&#13;&#10;@RequestMapping(&quot;/seller&quot;)&#13;&#10;public class SellerController {&#13;&#10;    @Autowired&#13;&#10;    private UserRepository userRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private SellerBankInfoService sellerBankInfoService;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private EmailService emailService;&#13;&#10;    @Autowired&#13;&#10;    private NotificationService notificationService;&#13;&#10;&#13;&#10;    // New: queue publisher for withdrawal creation&#13;&#10;    @Autowired&#13;&#10;    private com.mmo.mq.WithdrawalQueuePublisher withdrawalQueuePublisher;&#13;&#10;&#13;&#10;    // New: queue publisher for seller registration&#13;&#10;    @Autowired&#13;&#10;    private com.mmo.mq.SellerRegistrationPublisher sellerRegistrationPublisher;&#13;&#10;&#13;&#10;    // New: queue publisher for buy-points&#13;&#10;    @Autowired&#13;&#10;    private com.mmo.mq.BuyPointsPublisher buyPointsPublisher;&#13;&#10;&#13;&#10;    @PersistenceContext&#13;&#10;    private EntityManager entityManager;&#13;&#10;&#13;&#10;    // Inject repositories used for delete-shop logic&#13;&#10;    @Autowired private com.mmo.repository.ProductRepository productRepository;&#13;&#10;    @Autowired private com.mmo.repository.ProductVariantRepository productVariantRepository;&#13;&#10;    @Autowired private com.mmo.repository.ProductVariantAccountRepository productVariantAccountRepository;&#13;&#10;    @Autowired private com.mmo.repository.ReviewRepository reviewRepository;&#13;&#10;    @Autowired private com.mmo.repository.TransactionRepository transactionRepository;&#13;&#10;    @Autowired private com.mmo.repository.ShopInfoRepository shopInfoRepository;&#13;&#10;&#13;&#10;    // OTP dependencies&#13;&#10;    @Autowired&#13;&#10;    private com.mmo.service.AuthService authService;&#13;&#10;    @Autowired&#13;&#10;    private com.mmo.repository.EmailVerificationRepository emailVerificationRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    @Qualifier(&quot;emailExecutor&quot;)&#13;&#10;    private Executor emailExecutor;&#13;&#10;&#13;&#10;    // Inject system configuration service&#13;&#10;    @Autowired&#13;&#10;    private SystemConfigurationService systemConfigurationService;&#13;&#10;&#13;&#10;    private static final long REGISTRATION_FEE = 200_000L;&#13;&#10;&#13;&#10;    @GetMapping(&quot;/register&quot;)&#13;&#10;    public String showRegistrationForm(Model model) {&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;&#13;&#10;        if (email == null) {&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Load seller agreement URL from system configuration (fallback to static PDF)&#13;&#10;        String agreementUrl = null;&#13;&#10;        try {&#13;&#10;            if (systemConfigurationService != null) {&#13;&#10;                agreementUrl = systemConfigurationService.getStringValue(&#13;&#10;                        com.mmo.constant.SystemConfigKeys.POLICY_SELLER_AGREEMENT_URL,&#13;&#10;                        null&#13;&#10;                );&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {}&#13;&#10;        if (agreementUrl == null || agreementUrl.isBlank()) {&#13;&#10;            agreementUrl = &quot;/contracts/seller-contract.pdf&quot;; // default static file&#13;&#10;        }&#13;&#10;        model.addAttribute(&quot;sellerAgreementUrl&quot;, agreementUrl);&#13;&#10;&#13;&#10;        // Prefer shopStatus over legacy SellerRegistration flow&#13;&#10;        String shopStatus = user.getShopStatus();&#13;&#10;        model.addAttribute(&quot;shopStatus&quot;, shopStatus);&#13;&#10;        boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;        if (active) {&#13;&#10;            // Load ShopInfo and present as a synthetic 'registration' for view compatibility&#13;&#10;            ShopInfo shop = entityManager.createQuery(&quot;SELECT s FROM ShopInfo s WHERE s.user = :u AND s.isDelete = false&quot;, ShopInfo.class)&#13;&#10;                    .setParameter(&quot;u&quot;, user)&#13;&#10;                    .getResultStream().findFirst().orElse(null);&#13;&#10;            Map&lt;String, Object&gt; registration = new HashMap&lt;&gt;();&#13;&#10;            registration.put(&quot;id&quot;, 0L); // sentinel id so template renders status fragment&#13;&#10;            registration.put(&quot;status&quot;, &quot;Active&quot;);&#13;&#10;            registration.put(&quot;shopName&quot;, shop != null ? shop.getShopName() : (user.getFullName() != null ? user.getFullName() + &quot;'s Shop&quot; : &quot;My Shop&quot;));&#13;&#10;            registration.put(&quot;description&quot;, shop != null ? shop.getDescription() : &quot;&quot;);&#13;&#10;            model.addAttribute(&quot;registration&quot;, registration);&#13;&#10;            return &quot;customer/account-setting&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Inactive: show registration form&#13;&#10;        if (!model.containsAttribute(&quot;sellerRegistration&quot;)) {&#13;&#10;            model.addAttribute(&quot;sellerRegistration&quot;, new SellerRegistrationForm());&#13;&#10;        }&#13;&#10;        return &quot;customer/account-setting&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @PostMapping(&quot;/register&quot;)&#13;&#10;    public String registerSeller(@Valid @ModelAttribute(&quot;sellerRegistration&quot;) SellerRegistrationForm sellerRegistration,&#13;&#10;                                 BindingResult bindingResult,&#13;&#10;                                 @RequestParam(value = &quot;agree&quot;, required = false) Boolean agree,&#13;&#10;                                 RedirectAttributes redirectAttributes) {&#13;&#10;        // Validate basic input&#13;&#10;        if (agree == null || !agree) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;agreeError&quot;, &quot;You must agree to the Terms and Policy to continue.&quot;);&#13;&#10;        }&#13;&#10;        if (bindingResult.hasErrors() || (agree == null || !agree)) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;org.springframework.validation.BindingResult.sellerRegistration&quot;, bindingResult);&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Resolve current user&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;        if (email == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please log in to continue.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Optional soft check to provide faster feedback; final guard happens in the queue consumer&#13;&#10;        Long currentCoins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;        if (currentCoins &lt; REGISTRATION_FEE &amp;&amp; (user.getShopStatus() == null || !user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;))) {&#13;&#10;            notificationService.createNotificationForUser(&#13;&#10;                    user.getId(),&#13;&#10;                    &quot;Seller registration failed&quot;,&#13;&#10;                    &quot;Insufficient balance. A fee of 200,000 coins is required to activate your seller account.&quot;&#13;&#10;            );&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Insufficient balance. 200,000 coins are required for seller registration.&quot;);&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Enqueue registration request for idempotent, atomic processing&#13;&#10;        String dedupeKey = UUID.randomUUID().toString();&#13;&#10;        com.mmo.mq.dto.SellerRegistrationMessage msg = new com.mmo.mq.dto.SellerRegistrationMessage(&#13;&#10;                user.getId(),&#13;&#10;                sellerRegistration.getShopName(),&#13;&#10;                sellerRegistration.getDescription(),&#13;&#10;                dedupeKey&#13;&#10;        );&#13;&#10;        try {&#13;&#10;            sellerRegistrationPublisher.publish(msg);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to submit registration. Please try again later.&quot;);&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;sellerRegistration&quot;, sellerRegistration);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Inform the user; actual activation will be applied shortly by the consumer&#13;&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Your registration request has been submitted. Your shop will be activated shortly if requirements are met.&quot;);&#13;&#10;        return &quot;redirect:/seller/register&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/shop-info&quot;)&#13;&#10;    public String showShopInfo(Model model, RedirectAttributes redirectAttributes) {&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;        if (email == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;        if (!activeShop) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        ShopInfo shop = entityManager.createQuery(&quot;SELECT s FROM ShopInfo s WHERE s.user = :u AND s.isDelete = false&quot;, ShopInfo.class)&#13;&#10;                .setParameter(&quot;u&quot;, user)&#13;&#10;                .getResultStream().findFirst().orElse(null);&#13;&#10;&#13;&#10;        if (shop == null) {&#13;&#10;            // Fallback: create a lightweight view model when ShopInfo missing&#13;&#10;            ShopInfo fallback = new ShopInfo();&#13;&#10;            fallback.setShopName(user.getFullName() != null ? user.getFullName() + &quot;'s Shop&quot; : &quot;My Shop&quot;);&#13;&#10;            fallback.setDescription(&quot;&quot;);&#13;&#10;            model.addAttribute(&quot;shop&quot;, fallback);&#13;&#10;        } else {&#13;&#10;            model.addAttribute(&quot;shop&quot;, shop);&#13;&#10;        }&#13;&#10;        model.addAttribute(&quot;sellerEmail&quot;, user.getEmail());&#13;&#10;        model.addAttribute(&quot;shopStatus&quot;, user.getShopStatus());&#13;&#10;        return &quot;seller/shop-info&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/contract&quot;)&#13;&#10;    public ResponseEntity&lt;org.springframework.core.io.Resource&gt; downloadContract(@RequestParam(name = &quot;signed&quot;, defaultValue = &quot;false&quot;) boolean signed) {&#13;&#10;        // Legacy endpoint retained; not used in new auto-activation flow&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = (authentication != null) ? authentication.getName() : null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof OidcUser oidc) {&#13;&#10;            email = oidc.getEmail();&#13;&#10;        } else if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;            if (mailAttr != null) email = mailAttr.toString();&#13;&#10;        }&#13;&#10;        if (email == null) return ResponseEntity.status(401).build();&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) return ResponseEntity.status(401).build();&#13;&#10;        // No contract in new flow&#13;&#10;        return ResponseEntity.status(HttpStatus.NOT_FOUND).build();&#13;&#10;    }&#13;&#10;&#13;&#10;    @PostMapping(value = &quot;/contract&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)&#13;&#10;    public String uploadSignedContract(@RequestParam(&quot;signed&quot;) MultipartFile file,&#13;&#10;                                       RedirectAttributes redirectAttributes) {&#13;&#10;        // Legacy endpoint retained; not used in new auto-activation flow&#13;&#10;        redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Contract upload is not required. Your shop is already active.&quot;);&#13;&#10;        return &quot;redirect:/seller/register&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/my-shop&quot;)&#13;&#10;    public String showMyShop(Model model, RedirectAttributes redirectAttributes) {&#13;&#10;        // Get current logged-in user&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;&#13;&#10;        if (email == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Check if shop is active&#13;&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;        if (!activeShop) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Calculate statistics&#13;&#10;        Long sellerId = user.getId();&#13;&#10;&#13;&#10;        // Total revenue&#13;&#10;        Long totalRevenue = transactionRepository.getTotalRevenueBySellerId(sellerId);&#13;&#10;        if (totalRevenue == null) totalRevenue = 0L;&#13;&#10;&#13;&#10;        // Total orders&#13;&#10;        Long totalOrders = transactionRepository.getTotalOrdersBySellerId(sellerId);&#13;&#10;        if (totalOrders == null) totalOrders = 0L;&#13;&#10;&#13;&#10;        // Total products&#13;&#10;        Long totalProducts = productRepository.countBySellerId(sellerId);&#13;&#10;        if (totalProducts == null) totalProducts = 0L;&#13;&#10;&#13;&#10;        // Calculate last month's statistics for comparison&#13;&#10;        Calendar cal = Calendar.getInstance();&#13;&#10;        cal.add(Calendar.MONTH, -1);&#13;&#10;        Date lastMonth = cal.getTime();&#13;&#10;&#13;&#10;        Long lastMonthRevenue = transactionRepository.getRevenueBySellerIdAndDate(sellerId, lastMonth);&#13;&#10;        if (lastMonthRevenue == null) lastMonthRevenue = 0L;&#13;&#10;&#13;&#10;        Long lastMonthOrders = transactionRepository.getOrdersBySellerIdAndDate(sellerId, lastMonth);&#13;&#10;        if (lastMonthOrders == null) lastMonthOrders = 0L;&#13;&#10;&#13;&#10;        // Calculate percentage changes&#13;&#10;        double revenueChange = 0.0;&#13;&#10;        double ordersChange = 0.0;&#13;&#10;&#13;&#10;        if (totalRevenue &gt; 0 &amp;&amp; lastMonthRevenue &gt; 0) {&#13;&#10;            revenueChange = ((double)(totalRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;&#13;&#10;        }&#13;&#10;&#13;&#10;        if (totalOrders &gt; 0 &amp;&amp; lastMonthOrders &gt; 0) {&#13;&#10;            ordersChange = ((double)(totalOrders - lastMonthOrders) / lastMonthOrders) * 100;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Get recent transactions (limit to 10)&#13;&#10;        List&lt;com.mmo.entity.Transaction&gt; recentTransactions = transactionRepository.findRecentTransactionsBySeller(sellerId);&#13;&#10;        if (recentTransactions.size() &gt; 10) {&#13;&#10;            recentTransactions = recentTransactions.subList(0, 10);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Get top selling products (limit to 5)&#13;&#10;        List&lt;com.mmo.entity.Product&gt; topProducts = productRepository.findTopSellingProductsBySeller(&#13;&#10;            sellerId,&#13;&#10;            org.springframework.data.domain.PageRequest.of(0, 5)&#13;&#10;        );&#13;&#10;&#13;&#10;        // Calculate sales count and percentage for each product&#13;&#10;        List&lt;com.mmo.dto.TopProductDto&gt; topProductDtos = new ArrayList&lt;&gt;();&#13;&#10;        long totalSales = topProducts.stream()&#13;&#10;            .mapToLong(p -&gt; productRepository.countSalesForProduct(p.getId()))&#13;&#10;            .sum();&#13;&#10;&#13;&#10;        for (com.mmo.entity.Product product : topProducts) {&#13;&#10;            Long salesCount = productRepository.countSalesForProduct(product.getId());&#13;&#10;            if (salesCount == null) salesCount = 0L;&#13;&#10;&#13;&#10;            double percentage = 0.0;&#13;&#10;            if (totalSales &gt; 0) {&#13;&#10;                percentage = ((double) salesCount / totalSales) * 100;&#13;&#10;            }&#13;&#10;&#13;&#10;            com.mmo.dto.TopProductDto dto = new com.mmo.dto.TopProductDto(&#13;&#10;                product.getId(),&#13;&#10;                product.getName(),&#13;&#10;                product.getImage(),&#13;&#10;                salesCount,&#13;&#10;                percentage&#13;&#10;            );&#13;&#10;            topProductDtos.add(dto);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Add statistics to model&#13;&#10;        model.addAttribute(&quot;totalRevenue&quot;, totalRevenue);&#13;&#10;        model.addAttribute(&quot;totalOrders&quot;, totalOrders);&#13;&#10;        model.addAttribute(&quot;totalProducts&quot;, totalProducts);&#13;&#10;        model.addAttribute(&quot;revenueChange&quot;, String.format(&quot;%.1f&quot;, Math.abs(revenueChange)));&#13;&#10;        model.addAttribute(&quot;revenueChangePositive&quot;, revenueChange &gt;= 0);&#13;&#10;        model.addAttribute(&quot;ordersChange&quot;, String.format(&quot;%.1f&quot;, Math.abs(ordersChange)));&#13;&#10;        model.addAttribute(&quot;ordersChangePositive&quot;, ordersChange &gt;= 0);&#13;&#10;        model.addAttribute(&quot;recentTransactions&quot;, recentTransactions);&#13;&#10;        model.addAttribute(&quot;topProducts&quot;, topProductDtos);&#13;&#10;&#13;&#10;        return &quot;seller/my-shop&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/withdraw-money&quot;)&#13;&#10;    public String showWithdrawMoneyPage(Model model, RedirectAttributes redirectAttributes) {&#13;&#10;        // Require logged-in and Active shop&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;        if (email == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        boolean activeShop = user.getShopStatus() != null &amp;&amp; user.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;        if (!activeShop) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Your shop is not Active. Please complete registration.&quot;);&#13;&#10;            return &quot;redirect:/seller/register&quot;;&#13;&#10;        }&#13;&#10;&#13;&#10;        // Load coins&#13;&#10;        Long coins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;        model.addAttribute(&quot;coins&quot;, coins);&#13;&#10;&#13;&#10;        // Load all bank infos for the user&#13;&#10;        model.addAttribute(&quot;bankInfos&quot;, sellerBankInfoService.findAllByUser(user));&#13;&#10;        // Supported banks list&#13;&#10;        model.addAttribute(&quot;supportedBanks&quot;, defaultBanks());&#13;&#10;        // Load existing bank info (robust to different mappings)&#13;&#10;        SellerBankInfo bankInfo = findBankInfoForOwner(user);&#13;&#10;        Map&lt;String, Object&gt; bank = new HashMap&lt;&gt;();&#13;&#10;        if (bankInfo != null) {&#13;&#10;            bank.put(&quot;id&quot;, tryGetId(bankInfo));&#13;&#10;            bank.put(&quot;bankName&quot;, tryGetString(bankInfo, &quot;getBankName&quot;));&#13;&#10;            bank.put(&quot;accountNumber&quot;, tryGetString(bankInfo, &quot;getAccountNumber&quot;));&#13;&#10;            bank.put(&quot;accountHolder&quot;, firstNonBlank(&#13;&#10;                    tryGetString(bankInfo, &quot;getAccountHolder&quot;),&#13;&#10;                    tryGetString(bankInfo, &quot;getAccountName&quot;),&#13;&#10;                    tryGetString(bankInfo, &quot;getHolderName&quot;),&#13;&#10;                    tryGetString(bankInfo, &quot;getBeneficiaryName&quot;),&#13;&#10;                    tryGetString(bankInfo, &quot;getOwnerName&quot;)&#13;&#10;            ));&#13;&#10;            bank.put(&quot;branch&quot;, tryGetString(bankInfo, &quot;getBranch&quot;));&#13;&#10;        }&#13;&#10;        model.addAttribute(&quot;bank&quot;, bank);&#13;&#10;        var withdrawals = entityManager.createQuery(&#13;&#10;                        &quot;SELECT w FROM Withdrawal w WHERE w.seller = :user ORDER BY w.createdAt DESC&quot;, Withdrawal.class)&#13;&#10;                .setParameter(&quot;user&quot;, user)&#13;&#10;                .getResultList();&#13;&#10;        model.addAttribute(&quot;withdrawals&quot;, withdrawals);&#13;&#10;        return &quot;seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Send OTP for withdrawal (asynchronous email via EmailService)&#13;&#10;    @PostMapping(path = &quot;/withdrawals/send-otp&quot;)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; sendWithdrawalOtp(Authentication authentication) {&#13;&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        String email = authentication.getName();&#13;&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;            if (mailAttr != null) email = mailAttr.toString();&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#13;&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#13;&#10;        }&#13;&#10;        // Cooldown: avoid spamming OTP sends (min 60 seconds between sends)&#13;&#10;        try {&#13;&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#13;&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#13;&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#13;&#10;                if (seconds &lt; 60) {&#13;&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#13;&#10;                }&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {}&#13;&#10;&#13;&#10;        // Offload OTP creation + persistence + email to executor; return immediately&#13;&#10;        try {&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000)); // 5 minutes expiry&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] OTP Xác minh rút tiền&quot;;&#13;&#10;                    String html = EmailTemplate.withdrawalOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;&#13;&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Seller creates a withdrawal request&#13;&#10;    @PostMapping(path = &quot;/withdrawals&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#13;&#10;    @ResponseBody&#13;&#10;    @Transactional&#13;&#10;    public ResponseEntity&lt;?&gt; createWithdrawal(@RequestBody CreateWithdrawalRequest req,&#13;&#10;                                              Authentication authentication,&#13;&#10;                                              HttpSession session,&#13;&#10;                                              HttpServletRequest request) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;            User seller = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (seller == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            boolean sellerRole = seller.getRole() != null &amp;&amp; seller.getRole().equalsIgnoreCase(&quot;SELLER&quot;);&#13;&#10;            boolean activeShop = seller.getShopStatus() != null &amp;&amp; seller.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;            if (!sellerRole &amp;&amp; !activeShop) {&#13;&#10;                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(&quot;Forbidden&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            if (req == null || req.getAmount() == null || req.getAmount() &lt;= 0) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#13;&#10;            }&#13;&#10;            if (req.getAmount() &lt; 50_000L) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#13;&#10;            }&#13;&#10;            if (req.getBankInfoId() == null) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;MSG17: Bank information not found.&quot;);&#13;&#10;            }&#13;&#10;            if (req.getOtp() == null || !req.getOtp().matches(&quot;\\d{6}&quot;)) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Pre-validate OTP to enforce attempts policy before enqueue&#13;&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(seller, req.getOtp());&#13;&#10;            if (optVerification.isEmpty()) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#13;&#10;            }&#13;&#10;            var verification = optVerification.get();&#13;&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, seller, seller.getId(), &quot;withdraw_create&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Success so far: clear attempts for this action&#13;&#10;            clearSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#13;&#10;&#13;&#10;            // Enqueue creation message; worker will validate OTP, balance, and persist&#13;&#10;            String dedupeKey = seller.getId() + &quot;:&quot; + req.getBankInfoId() + &quot;:&quot; + req.getAmount() + &quot;:&quot; + req.getOtp();&#13;&#10;            com.mmo.mq.dto.WithdrawalCreateMessage msg = new com.mmo.mq.dto.WithdrawalCreateMessage(&#13;&#10;                    seller.getId(),&#13;&#10;                    req.getBankInfoId(),&#13;&#10;                    req.getAmount(),&#13;&#10;                    req.getBankName(),&#13;&#10;                    req.getAccountNumber(),&#13;&#10;                    req.getAccountHolder(),&#13;&#10;                    req.getBranch(),&#13;&#10;                    req.getOtp(),&#13;&#10;                    dedupeKey&#13;&#10;            );&#13;&#10;            withdrawalQueuePublisher.publishCreate(msg);&#13;&#10;&#13;&#10;            // Do not persist or deduct coins here&#13;&#10;            return ResponseEntity.accepted().body(&quot;Withdrawal request has been queued and will appear shortly.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Seller creates a withdrawal request (form submission)&#13;&#10;    @PostMapping(path = &quot;/withdrawals&quot;, consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)&#13;&#10;    @Transactional&#13;&#10;    public String createWithdrawalForm(CreateWithdrawalRequest req,&#13;&#10;                                       Authentication authentication,&#13;&#10;                                       RedirectAttributes redirectAttributes,&#13;&#10;                                       HttpSession session,&#13;&#10;                                       HttpServletRequest request) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;            User seller = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (seller == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            boolean sellerRole = seller.getRole() != null &amp;&amp; seller.getRole().equalsIgnoreCase(&quot;SELLER&quot;);&#13;&#10;            boolean activeShop = seller.getShopStatus() != null &amp;&amp; seller.getShopStatus().equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;            if (!sellerRole &amp;&amp; !activeShop) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Forbidden&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;&#13;&#10;            if (req == null || req.getOtp() == null || !req.getOtp().matches(&quot;\\d{6}&quot;)) {&#13;&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#13;&#10;                if (attempts &gt;= 5) {&#13;&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#13;&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#13;&#10;                    return &quot;redirect:/authen/login&quot;;&#13;&#10;                } else if (attempts &gt;= 3) {&#13;&#10;                    sendWithdrawalOtpForUser(seller);&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please enter the 6-digit OTP. A new OTP has been sent to your email.&quot;);&#13;&#10;                } else {&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please enter the 6-digit OTP sent to your email.&quot;);&#13;&#10;                }&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            if (req.getAmount() == null || req.getAmount() &lt; 50_000L) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;MSG16: Minimum withdrawal amount is 50000.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            if (req.getBankInfoId() == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;MSG17: Bank information not found.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;&#13;&#10;            // Pre-validate OTP&#13;&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(seller, req.getOtp());&#13;&#10;            if (optVerification.isEmpty()) {&#13;&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#13;&#10;                if (attempts &gt;= 5) {&#13;&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#13;&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#13;&#10;                    return &quot;redirect:/authen/login&quot;;&#13;&#10;                } else if (attempts &gt;= 3) {&#13;&#10;                    sendWithdrawalOtpForUser(seller);&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Incorrect OTP. A new OTP has been sent to your email.&quot;);&#13;&#10;                } else {&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Incorrect or used OTP.&quot;);&#13;&#10;                }&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            var verification = optVerification.get();&#13;&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#13;&#10;                int attempts = incSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#13;&#10;                if (attempts &gt;= 5) {&#13;&#10;                    try { new SecurityContextLogoutHandler().logout(request, null, authentication); } catch (Exception ignored) {}&#13;&#10;                    try { session.invalidate(); } catch (Exception ignored) {}&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#13;&#10;                    return &quot;redirect:/authen/login&quot;;&#13;&#10;                } else if (attempts &gt;= 3) {&#13;&#10;                    sendWithdrawalOtpForUser(seller);&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;OTP expired. A new OTP has been sent to your email.&quot;);&#13;&#10;                } else {&#13;&#10;                    redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;OTP has expired. Please request a new OTP.&quot;);&#13;&#10;                }&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;&#13;&#10;            // Success: clear attempts&#13;&#10;            clearSellerOtpAttempts(session, seller.getId(), &quot;withdraw_create&quot;);&#13;&#10;&#13;&#10;            String dedupeKey = seller.getId() + &quot;:&quot; + req.getBankInfoId() + &quot;:&quot; + req.getAmount() + &quot;:&quot; + req.getOtp();&#13;&#10;            com.mmo.mq.dto.WithdrawalCreateMessage msg = new com.mmo.mq.dto.WithdrawalCreateMessage(&#13;&#10;                    seller.getId(),&#13;&#10;                    req.getBankInfoId(),&#13;&#10;                    req.getAmount(),&#13;&#10;                    req.getBankName(),&#13;&#10;                    req.getAccountNumber(),&#13;&#10;                    req.getAccountHolder(),&#13;&#10;                    req.getBranch(),&#13;&#10;                    req.getOtp(),&#13;&#10;                    dedupeKey&#13;&#10;            );&#13;&#10;            withdrawalQueuePublisher.publishCreate(msg);&#13;&#10;&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Your withdrawal request has been queued and will appear shortly.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Internal error: &quot; + ex.getMessage());&#13;&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;        }&#13;&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/withdrawals/{id}&quot;)&#13;&#10;    public String viewWithdrawalDetail(@PathVariable Long id, Model model, Authentication authentication) {&#13;&#10;        // Lấy user hiện tại&#13;&#10;        String email = authentication.getName();&#13;&#10;        User user = userRepository.findByEmailAndIsDelete(email, false);&#13;&#10;        if (user == null) {&#13;&#10;            return &quot;redirect:/authen/login&quot;;&#13;&#10;        }&#13;&#10;        // Lấy withdrawal theo id&#13;&#10;        Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#13;&#10;        if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#13;&#10;            // Không tìm thấy hoặc không thuộc về user hiện tại&#13;&#10;            return &quot;redirect:/seller/withdraw-money?error=notfound&quot;;&#13;&#10;        }&#13;&#10;        model.addAttribute(&quot;withdrawal&quot;, withdrawal);&#13;&#10;        return &quot;seller/withdrawal-detail&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    @GetMapping(&quot;/withdrawals/{id}/json&quot;)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; getWithdrawalDetailJson(@PathVariable Long id, Authentication authentication) {&#13;&#10;        String email = authentication.getName();&#13;&#10;        User user = userRepository.findByEmailAndIsDelete(email, false);&#13;&#10;        if (user == null) return ResponseEntity.status(401).body(&quot;Unauthorized&quot;);&#13;&#10;        Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#13;&#10;        if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#13;&#10;            return ResponseEntity.status(404).body(&quot;Not found&quot;);&#13;&#10;        }&#13;&#10;        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();&#13;&#10;        data.put(&quot;id&quot;, withdrawal.getId());&#13;&#10;        data.put(&quot;amount&quot;, withdrawal.getAmount());&#13;&#10;        data.put(&quot;status&quot;, withdrawal.getStatus());&#13;&#10;        data.put(&quot;bankName&quot;, withdrawal.getBankName());&#13;&#10;        data.put(&quot;accountNumber&quot;, withdrawal.getAccountNumber());&#13;&#10;        data.put(&quot;branch&quot;, withdrawal.getBranch());&#13;&#10;        data.put(&quot;createdAt&quot;, withdrawal.getCreatedAt());&#13;&#10;        return ResponseEntity.ok(data);&#13;&#10;    }&#13;&#10;&#13;&#10;    // Helpers to tolerate different SellerBankInfo mappings without adding new dependencies&#13;&#10;    private Long tryResolveOwnerId(SellerBankInfo bankInfo) {&#13;&#10;        try {&#13;&#10;            Object owner = bankInfo.getClass().getMethod(&quot;getSeller&quot;).invoke(bankInfo);&#13;&#10;            if (owner != null) {&#13;&#10;                Object id = owner.getClass().getMethod(&quot;getId&quot;).invoke(owner);&#13;&#10;                return id instanceof Long ? (Long) id : null;&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            Object owner = bankInfo.getClass().getMethod(&quot;getUser&quot;).invoke(bankInfo);&#13;&#10;            if (owner != null) {&#13;&#10;                Object id = owner.getClass().getMethod(&quot;getId&quot;).invoke(owner);&#13;&#10;                return id instanceof Long ? (Long) id : null;&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            Object id = bankInfo.getClass().getMethod(&quot;getUserId&quot;).invoke(bankInfo);&#13;&#10;            return id instanceof Long ? (Long) id : null;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    private void tryCopyBankDisplayFields(SellerBankInfo bankInfo, Withdrawal wd) {&#13;&#10;        try {&#13;&#10;            Object bankName = bankInfo.getClass().getMethod(&quot;getBankName&quot;).invoke(bankInfo);&#13;&#10;            if (bankName instanceof String s) wd.setBankName(s);&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            Object acc = bankInfo.getClass().getMethod(&quot;getAccountNumber&quot;).invoke(bankInfo);&#13;&#10;            if (acc instanceof String s) wd.setAccountNumber(s);&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            Object br = bankInfo.getClass().getMethod(&quot;getBranch&quot;).invoke(bankInfo);&#13;&#10;            if (br instanceof String s) wd.setBranch(s);&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        // Try to copy account holder / beneficiary name using several possible getter names&#13;&#10;        try {&#13;&#10;            String[] possibleGetters = new String[]{&quot;getAccountHolder&quot;, &quot;getAccountName&quot;, &quot;getHolderName&quot;, &quot;getBeneficiaryName&quot;, &quot;getOwnerName&quot;};&#13;&#10;            for (String g : possibleGetters) {&#13;&#10;                try {&#13;&#10;                    Object name = bankInfo.getClass().getMethod(g).invoke(bankInfo);&#13;&#10;                    if (name instanceof String s &amp;&amp; s != null &amp;&amp; !s.isBlank()) {&#13;&#10;                        wd.setAccountName(s);&#13;&#10;                        break;&#13;&#10;                    }&#13;&#10;                } catch (Exception ignored) {&#13;&#10;                }&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // Helper: find SellerBankInfo by owner using tolerant queries&#13;&#10;    private SellerBankInfo findBankInfoForOwner(User owner) {&#13;&#10;        Long uid = owner.getId();&#13;&#10;        String[] possibleFields = {&quot;seller.id&quot;, &quot;user.id&quot;, &quot;userId&quot;};&#13;&#10;&#13;&#10;        for (String field : possibleFields) {&#13;&#10;            try {&#13;&#10;                String hql = &quot;select b from SellerBankInfo b where b.&quot; + field + &quot; = :uid&quot;;&#13;&#10;                return entityManager.createQuery(hql, SellerBankInfo.class)&#13;&#10;                        .setParameter(&quot;uid&quot;, uid)&#13;&#10;                        .setMaxResults(1)&#13;&#10;                        .getSingleResult();&#13;&#10;            } catch (Exception ignored) {&#13;&#10;                // This query failed, try the next one&#13;&#10;            }&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Helper: set owner relation via reflection&#13;&#10;    private void setOwner(SellerBankInfo bankInfo, User owner) {&#13;&#10;        try {&#13;&#10;            bankInfo.getClass().getMethod(&quot;setSeller&quot;, User.class).invoke(bankInfo, owner);&#13;&#10;            return;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            bankInfo.getClass().getMethod(&quot;setUser&quot;, User.class).invoke(bankInfo, owner);&#13;&#10;            return;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        try {&#13;&#10;            bankInfo.getClass().getMethod(&quot;setUserId&quot;, Long.class).invoke(bankInfo, owner.getId());&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private Long tryGetId(SellerBankInfo bankInfo) {&#13;&#10;        try {&#13;&#10;            Object id = bankInfo.getClass().getMethod(&quot;getId&quot;).invoke(bankInfo);&#13;&#10;            if (id instanceof Long l) return l;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    private boolean trySetString(Object target, String setterName, String value) {&#13;&#10;        try {&#13;&#10;            target.getClass().getMethod(setterName, String.class).invoke(target, value);&#13;&#10;            return true;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        return false;&#13;&#10;    }&#13;&#10;&#13;&#10;    private String tryGetString(Object target, String getterName) {&#13;&#10;        try {&#13;&#10;            Object v = target.getClass().getMethod(getterName).invoke(target);&#13;&#10;            return v != null ? v.toString() : null;&#13;&#10;        } catch (Exception ignored) {&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    private String firstNonBlank(String... vals) {&#13;&#10;        if (vals == null) return null;&#13;&#10;        for (String s : vals) {&#13;&#10;            if (s != null &amp;&amp; !s.isBlank()) return s;&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Danh sách tất cả bank info của user&#13;&#10;    @GetMapping(&quot;/bank-infos&quot;)&#13;&#10;    public String listBankInfos(Model model, RedirectAttributes redirectAttributes) {&#13;&#10;        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;        String email = null;&#13;&#10;        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;            Object principal = authentication.getPrincipal();&#13;&#10;            if (principal instanceof UserDetails) {&#13;&#10;                email = ((UserDetails) principal).getUsername();&#13;&#10;            } else if (principal instanceof OidcUser) {&#13;&#10;                email = ((OidcUser) principal).getEmail();&#13;&#10;            } else if (principal instanceof OAuth2User) {&#13;&#10;                Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            } else {&#13;&#10;                email = authentication.getName();&#13;&#10;            }&#13;&#10;        }&#13;&#10;        if (email == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;            return &quot;redirect:/login&quot;;&#13;&#10;        }&#13;&#10;        // Lấy tất cả bank info của user&#13;&#10;        var bankInfos = entityManager.createQuery(&#13;&#10;                        &quot;SELECT b FROM SellerBankInfo b WHERE b.user = :user AND b.isDelete = false&quot;, SellerBankInfo.class)&#13;&#10;                .setParameter(&quot;user&quot;, user)&#13;&#10;                .getResultList();&#13;&#10;        model.addAttribute(&quot;bankInfos&quot;, bankInfos);&#13;&#10;        return &quot;seller/bank-infos&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Xem chi tiết 1 bank info&#13;&#10;    @GetMapping(&quot;/bank-info/{id}&quot;)&#13;&#10;    public String viewBankInfo(@PathVariable(&quot;id&quot;) Long id, Model model, RedirectAttributes redirectAttributes) {&#13;&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#13;&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#13;&#10;            return &quot;redirect:/seller/bank-infos&quot;;&#13;&#10;        }&#13;&#10;        model.addAttribute(&quot;bankInfo&quot;, bankInfo);&#13;&#10;        return &quot;seller/bank-info-detail&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Sửa bank info&#13;&#10;    @PostMapping(&quot;/bank-info/{id}/edit&quot;)&#13;&#10;    @Transactional&#13;&#10;    public String editBankInfo(@PathVariable(&quot;id&quot;) Long id,&#13;&#10;                               @RequestParam(&quot;bankName&quot;) String bankName,&#13;&#10;                               @RequestParam(&quot;accountNumber&quot;) String accountNumber,&#13;&#10;                               @RequestParam(value = &quot;accountHolder&quot;, required = false) String accountHolder,&#13;&#10;                               @RequestParam(value = &quot;branch&quot;, required = false) String branch,&#13;&#10;                               RedirectAttributes redirectAttributes) {&#13;&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#13;&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#13;&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;        }&#13;&#10;        bankInfo.setBankName(bankName);&#13;&#10;        bankInfo.setAccountNumber(accountNumber);&#13;&#10;        bankInfo.setAccountHolder(accountHolder);&#13;&#10;        bankInfo.setBranch(branch);&#13;&#10;        entityManager.merge(bankInfo);&#13;&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info updated successfully.&quot;);&#13;&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Xóa bank info (soft delete)&#13;&#10;    @PostMapping(&quot;/bank-info/{id}/delete&quot;)&#13;&#10;    @Transactional&#13;&#10;    public String deleteBankInfo(@PathVariable(&quot;id&quot;) Long id, RedirectAttributes redirectAttributes) {&#13;&#10;        SellerBankInfo bankInfo = entityManager.find(SellerBankInfo.class, id);&#13;&#10;        if (bankInfo == null || bankInfo.isDelete()) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank info not found.&quot;);&#13;&#10;            return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;        }&#13;&#10;        bankInfo.setDelete(true);&#13;&#10;        entityManager.merge(bankInfo);&#13;&#10;        redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info deleted successfully.&quot;);&#13;&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Thêm mới bank info&#13;&#10;    @PostMapping(&quot;/bank-info/add&quot;)&#13;&#10;    @Transactional&#13;&#10;    public String addBankInfo(@RequestParam(&quot;bankName&quot;) String bankName,&#13;&#10;                              @RequestParam(&quot;accountNumber&quot;) String accountNumber,&#13;&#10;                              @RequestParam(value = &quot;accountHolder&quot;, required = false) String accountHolder,&#13;&#10;                              @RequestParam(value = &quot;branch&quot;, required = false) String branch,&#13;&#10;                              RedirectAttributes redirectAttributes) {&#13;&#10;        try {&#13;&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#13;&#10;            String email = null;&#13;&#10;            if (authentication != null &amp;&amp; authentication.isAuthenticated()) {&#13;&#10;                Object principal = authentication.getPrincipal();&#13;&#10;                if (principal instanceof UserDetails) {&#13;&#10;                    email = ((UserDetails) principal).getUsername();&#13;&#10;                } else if (principal instanceof OidcUser) {&#13;&#10;                    email = ((OidcUser) principal).getEmail();&#13;&#10;                } else if (principal instanceof OAuth2User) {&#13;&#10;                    Object mailAttr = ((OAuth2User) principal).getAttributes().get(&quot;email&quot;);&#13;&#10;                    if (mailAttr != null) email = mailAttr.toString();&#13;&#10;                } else {&#13;&#10;                    email = authentication.getName();&#13;&#10;                }&#13;&#10;            }&#13;&#10;            if (email == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Please login to continue.&quot;);&#13;&#10;                return &quot;redirect:/login&quot;;&#13;&#10;            }&#13;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (user == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;User not found.&quot;);&#13;&#10;                return &quot;redirect:/login&quot;;&#13;&#10;            }&#13;&#10;            SellerBankInfo bankInfo = new SellerBankInfo();&#13;&#10;            bankInfo.setUser(user);&#13;&#10;            bankInfo.setBankName(bankName);&#13;&#10;            bankInfo.setAccountNumber(accountNumber);&#13;&#10;            bankInfo.setAccountHolder(accountHolder);&#13;&#10;            bankInfo.setBranch(branch);&#13;&#10;            bankInfo.setDelete(false);&#13;&#10;            entityManager.persist(bankInfo);&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info added successfully.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to add bank info: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // Helper DTO for supported bank options (matches template usage: b.displayName)&#13;&#10;    private static class BankOption {&#13;&#10;        private final String displayName;&#13;&#10;        BankOption(String displayName) { this.displayName = displayName; }&#13;&#10;        public String getDisplayName() { return displayName; }&#13;&#10;    }&#13;&#10;    private List&lt;BankOption&gt; defaultBanks() {&#13;&#10;        return Arrays.asList(&#13;&#10;                new BankOption(&quot;Vietcombank&quot;),&#13;&#10;                new BankOption(&quot;Techcombank&quot;),&#13;&#10;                new BankOption(&quot;VietinBank&quot;),&#13;&#10;                new BankOption(&quot;BIDV&quot;),&#13;&#10;                new BankOption(&quot;Agribank&quot;),&#13;&#10;                new BankOption(&quot;MB Bank&quot;),&#13;&#10;                new BankOption(&quot;ACB&quot;),&#13;&#10;                new BankOption(&quot;Sacombank&quot;),&#13;&#10;                new BankOption(&quot;TPBank&quot;),&#13;&#10;                new BankOption(&quot;VPBank&quot;)&#13;&#10;        );&#13;&#10;    }&#13;&#10;&#13;&#10;    @PostMapping(&quot;/withdrawals/{id}/update-bank&quot;)&#13;&#10;    @Transactional&#13;&#10;    public String updateWithdrawalBankInfo(@PathVariable Long id,&#13;&#10;                                           @RequestParam String bankName,&#13;&#10;                                           @RequestParam String accountNumber,&#13;&#10;                                           @RequestParam(name = &quot;accountHolder&quot;) String accountHolder,&#13;&#10;                                           @RequestParam(name = &quot;branch&quot;, required = false) String branch,&#13;&#10;                                           Authentication authentication,&#13;&#10;                                           RedirectAttributes redirectAttributes) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.oidc.user.OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.user.OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;            User user = userRepository.findByEmailAndIsDelete(email, false);&#13;&#10;            if (user == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Unauthorized&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#13;&#10;            if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Withdrawal not found.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            // Only allow when Pending and within 24 hours since createdAt&#13;&#10;            Date createdAt = withdrawal.getCreatedAt();&#13;&#10;            if (createdAt == null) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;This withdrawal cannot be edited at this time.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            long diffMs = System.currentTimeMillis() - createdAt.getTime();&#13;&#10;            boolean within24h = diffMs &lt;= 24L * 60L * 60L * 1000L;&#13;&#10;//            boolean within24h = diffMs &lt;= 2L * 60L * 1000L;&#13;&#10;            String status = withdrawal.getStatus();&#13;&#10;            boolean isPending = status != null &amp;&amp; status.equalsIgnoreCase(&quot;Pending&quot;);&#13;&#10;            if (!isPending || !within24h) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;You can only update bank info within 24h for pending withdrawals.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            // Normalize and validate non-blank fields&#13;&#10;            String bn = bankName == null ? null : bankName.trim();&#13;&#10;            String an = accountNumber == null ? null : accountNumber.trim();&#13;&#10;            String ah = accountHolder == null ? null : accountHolder.trim();&#13;&#10;            String br = branch == null ? null : branch.trim();&#13;&#10;            if (bn == null || bn.isEmpty() || an == null || an.isEmpty() || ah == null || ah.isEmpty()) {&#13;&#10;                redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Bank Name, Account Number, and Account Holder cannot be empty.&quot;);&#13;&#10;                return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;            }&#13;&#10;            // Update allowed fields only&#13;&#10;            withdrawal.setBankName(bn);&#13;&#10;            withdrawal.setAccountNumber(an);&#13;&#10;            withdrawal.setAccountName(ah);&#13;&#10;            if (br != null) {&#13;&#10;                withdrawal.setBranch(br);&#13;&#10;            }&#13;&#10;            entityManager.merge(withdrawal);&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;successMessage&quot;, &quot;Bank info updated successfully.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            redirectAttributes.addFlashAttribute(&quot;errorMessage&quot;, &quot;Failed to update bank info: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;        return &quot;redirect:/seller/withdraw-money&quot;;&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Seller creates a withdrawal request (JSON payload)&#13;&#10;    @PostMapping(path = &quot;/withdrawals/{id}/update-bank&quot;, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)&#13;&#10;    @ResponseBody&#13;&#10;    @Transactional&#13;&#10;    public ResponseEntity&lt;?&gt; updateWithdrawalBankInfoJson(@PathVariable Long id,&#13;&#10;                                                          @RequestBody Map&lt;String, Object&gt; body,&#13;&#10;                                                          Authentication authentication,&#13;&#10;                                                          HttpSession session,&#13;&#10;                                                          HttpServletRequest request) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.oidc.user.OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof org.springframework.security.oauth2.core.user.OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;            User user = userRepository.findByEmailAndIsDelete(email, false);&#13;&#10;            if (user == null) return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;&#13;&#10;            Withdrawal withdrawal = entityManager.find(Withdrawal.class, id);&#13;&#10;            if (withdrawal == null || withdrawal.getSeller() == null || !withdrawal.getSeller().getId().equals(user.getId())) {&#13;&#10;                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Withdrawal not found&quot;);&#13;&#10;            }&#13;&#10;            Date createdAt = withdrawal.getCreatedAt();&#13;&#10;            if (createdAt == null) return ResponseEntity.badRequest().body(&quot;This withdrawal cannot be edited at this time.&quot;);&#13;&#10;            long diffMs = System.currentTimeMillis() - createdAt.getTime();&#13;&#10;            boolean within24h = diffMs &lt;= 24L * 60L * 60L * 1000L;&#13;&#10;            String status = withdrawal.getStatus();&#13;&#10;            boolean isPending = status != null &amp;&amp; status.equalsIgnoreCase(&quot;Pending&quot;);&#13;&#10;            if (!isPending || !within24h) {&#13;&#10;                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(&quot;You can only update bank info within 24h for pending withdrawals.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            String bankName = body.get(&quot;bankName&quot;) != null ? body.get(&quot;bankName&quot;).toString() : null;&#13;&#10;            String accountNumber = body.get(&quot;accountNumber&quot;) != null ? body.get(&quot;accountNumber&quot;).toString() : null;&#13;&#10;            String accountHolder = body.get(&quot;accountHolder&quot;) != null ? body.get(&quot;accountHolder&quot;).toString() : null;&#13;&#10;            String branch = body.get(&quot;branch&quot;) != null ? body.get(&quot;branch&quot;).toString() : null;&#13;&#10;            String otp = body.get(&quot;otp&quot;) != null ? body.get(&quot;otp&quot;).toString() : null;&#13;&#10;            if (bankName == null || bankName.isBlank() || accountNumber == null || accountNumber.isBlank() || accountHolder == null || accountHolder.isBlank()) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;bankName, accountNumber, and accountHolder are required&quot;);&#13;&#10;            }&#13;&#10;            // Require and verify OTP (6 digits)&#13;&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#13;&#10;            }&#13;&#10;            // Lookup latest unused OTP for this user/code&#13;&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#13;&#10;            if (optVerification.isEmpty()) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#13;&#10;            }&#13;&#10;            var verification = optVerification.get();&#13;&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;withdraw_update&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Build old/new info for email&#13;&#10;            String oldInfo = String.format(&quot;%s - %s (%s)%s&quot;,&#13;&#10;                    safeString(withdrawal.getBankName()),&#13;&#10;                    safeString(withdrawal.getAccountNumber()),&#13;&#10;                    safeString(withdrawal.getAccountName()),&#13;&#10;                    withdrawal.getBranch() != null &amp;&amp; !withdrawal.getBranch().isBlank() ? (&quot; - &quot; + withdrawal.getBranch()) : &quot;&quot;);&#13;&#10;            String newInfo = String.format(&quot;%s - %s (%s)%s&quot;,&#13;&#10;                    bankName.trim(),&#13;&#10;                    accountNumber.trim(),&#13;&#10;                    accountHolder.trim(),&#13;&#10;                    branch != null &amp;&amp; !branch.isBlank() ? (&quot; - &quot; + branch.trim()) : &quot;&quot;);&#13;&#10;&#13;&#10;            // Update allowed fields only&#13;&#10;            withdrawal.setBankName(bankName.trim());&#13;&#10;            withdrawal.setAccountNumber(accountNumber.trim());&#13;&#10;            withdrawal.setAccountName(accountHolder.trim());&#13;&#10;            if (branch != null) {&#13;&#10;                withdrawal.setBranch(branch.trim());&#13;&#10;            }&#13;&#10;            entityManager.merge(withdrawal);&#13;&#10;&#13;&#10;            // Mark OTP as used&#13;&#10;            verification.setUsed(true);&#13;&#10;            emailVerificationRepository.save(verification);&#13;&#10;&#13;&#10;            // Clear attempts on success&#13;&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;withdraw_update&quot;);&#13;&#10;&#13;&#10;            // Send async email notify&#13;&#10;            try {&#13;&#10;                String userName = user.getFullName() != null ? user.getFullName() : (user.getEmail() != null ? user.getEmail() : &quot;User&quot;);&#13;&#10;                String updatedAt = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;).format(new Date());&#13;&#10;                String html = EmailTemplate.withdrawalBankInfoUpdatedEmail(userName, oldInfo, newInfo, updatedAt);&#13;&#10;                String subject = &quot;[MMOMarket] Cập nhật thông tin ngân hàng rút tiền&quot;;&#13;&#10;                if (user.getEmail() != null &amp;&amp; !user.getEmail().isBlank()) {&#13;&#10;                    emailService.sendEmailAsync(user.getEmail(), subject, html);&#13;&#10;                }&#13;&#10;            } catch (Exception ignored) {}&#13;&#10;&#13;&#10;            Map&lt;String, Object&gt; res = new HashMap&lt;&gt;();&#13;&#10;            res.put(&quot;message&quot;, &quot;Bank info updated successfully&quot;);&#13;&#10;            res.put(&quot;id&quot;, withdrawal.getId());&#13;&#10;            res.put(&quot;bankName&quot;, withdrawal.getBankName());&#13;&#10;            res.put(&quot;accountNumber&quot;, withdrawal.getAccountNumber());&#13;&#10;            res.put(&quot;accountHolder&quot;, withdrawal.getAccountName());&#13;&#10;            res.put(&quot;branch&quot;, withdrawal.getBranch());&#13;&#10;            return ResponseEntity.ok(res);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Send OTP for shop deletion verification&#13;&#10;    @PostMapping(path = &quot;/delete-shop/send-otp&quot;)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; sendDeleteShopOtp(Authentication authentication) {&#13;&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        String email = authentication.getName();&#13;&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;            if (mailAttr != null) email = mailAttr.toString();&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#13;&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Check if shop is active&#13;&#10;        String shopStatus = user.getShopStatus();&#13;&#10;        boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;        if (!active) {&#13;&#10;            return ResponseEntity.badRequest().body(&quot;Your shop is not in Active status.&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Cooldown: avoid spamming OTP sends (min 60 seconds between sends)&#13;&#10;        try {&#13;&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#13;&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#13;&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#13;&#10;                if (seconds &lt; 60) {&#13;&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#13;&#10;                }&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {}&#13;&#10;&#13;&#10;        // Offload OTP creation + persistence + email to executor; return immediately&#13;&#10;        try {&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000)); // 5 minutes expiry&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] Confirm Shop Cancellation (OTP)&quot;;&#13;&#10;                    String html = EmailTemplate.deleteShopOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;&#13;&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Check delete-shop conditions before showing OTP modal&#13;&#10;    @GetMapping(path = &quot;/delete-shop/check&quot;)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; checkDeleteShopConditions(Authentication authentication) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;&#13;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (user == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            // Check if shop is active&#13;&#10;            String shopStatus = user.getShopStatus();&#13;&#10;            boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;            if (!active) {&#13;&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Your shop is not in Active status.&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            // Business rule a.2: Coins must be 0&#13;&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;            if (coins != 0L) {&#13;&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You must withdraw all your Coins balance to 0 before deleting your shop.&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            // Business rule a.1: No listed products&#13;&#10;            Long remainingProducts = entityManager.createQuery(&#13;&#10;                    &quot;SELECT COUNT(p) FROM Product p WHERE p.seller.id = :sellerId AND p.isDelete = false&quot;, Long.class)&#13;&#10;                .setParameter(&quot;sellerId&quot;, user.getId())&#13;&#10;                .getSingleResult();&#13;&#10;            if (remainingProducts != null &amp;&amp; remainingProducts &gt; 0) {&#13;&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You must remove all listed products before deleting your shop.&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            // Business rule a.3: Not temporarily locked or unresolved policy violation&#13;&#10;            if (shopStatus.equalsIgnoreCase(&quot;Suspended&quot;) || shopStatus.equalsIgnoreCase(&quot;Banned&quot;) || shopStatus.equalsIgnoreCase(&quot;Locked&quot;)) {&#13;&#10;                return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Your account is temporarily locked or has policy violations. Cannot delete shop.&quot;));&#13;&#10;            }&#13;&#10;&#13;&#10;            // All conditions met&#13;&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, true, &quot;message&quot;, &quot;All conditions met. You can proceed.&quot;));&#13;&#10;        } catch (Exception ex) {&#13;&#10;            return ResponseEntity.status(500).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Internal error: &quot; + ex.getMessage()));&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Delete shop with OTP verification (JSON endpoint)&#13;&#10;    @PostMapping(path = &quot;/delete-shop&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#13;&#10;    @ResponseBody&#13;&#10;    @Transactional&#13;&#10;    public ResponseEntity&lt;?&gt; deleteShopWithOtp(@RequestBody Map&lt;String, String&gt; payload,&#13;&#10;                                               Authentication authentication,&#13;&#10;                                               HttpSession session,&#13;&#10;                                               HttpServletRequest request) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;&#13;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (user == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Must have an active shop to delete&#13;&#10;            String shopStatus = user.getShopStatus();&#13;&#10;            boolean active = shopStatus != null &amp;&amp; shopStatus.equalsIgnoreCase(&quot;Active&quot;);&#13;&#10;            if (!active) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;Your shop is not in Active status.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Validate OTP&#13;&#10;            String otp = payload != null ? payload.get(&quot;otp&quot;) : null;&#13;&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_REQUIRED&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Verify OTP&#13;&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#13;&#10;            if (optVerification.isEmpty()) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_INVALID&quot;);&#13;&#10;            }&#13;&#10;            var verification = optVerification.get();&#13;&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;delete_shop&quot;, &quot;MSG_OTP_EXPIRED&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Mark OTP as used&#13;&#10;            verification.setUsed(true);&#13;&#10;            emailVerificationRepository.save(verification);&#13;&#10;&#13;&#10;            // Clear OTP attempts&#13;&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;delete_shop&quot;);&#13;&#10;&#13;&#10;            // Business rule a.2: Coins must be 0&#13;&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;            if (coins != 0L) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;You must withdraw all your Coins balance to 0 before deleting your shop.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Business rule a.1: No listed products — ensure no non-deleted products remain&#13;&#10;            Long remainingProducts = entityManager.createQuery(&#13;&#10;                    &quot;SELECT COUNT(p) FROM Product p WHERE p.seller.id = :sellerId AND p.isDelete = false&quot;, Long.class)&#13;&#10;                .setParameter(&quot;sellerId&quot;, user.getId())&#13;&#10;                .getSingleResult();&#13;&#10;            if (remainingProducts != null &amp;&amp; remainingProducts &gt; 0) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;You must remove all listed products before deleting your shop.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Business rule a.3: Not temporarily locked or unresolved policy violation&#13;&#10;            if (shopStatus != null &amp;&amp; (shopStatus.equalsIgnoreCase(&quot;Suspended&quot;) || shopStatus.equalsIgnoreCase(&quot;Banned&quot;) || shopStatus.equalsIgnoreCase(&quot;Locked&quot;))) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;Your account is temporarily locked or has policy violations. Cannot delete shop.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // All conditions satisfied -&gt; perform soft delete cascade (immediate and irreversible)&#13;&#10;            Long uid = user.getId();&#13;&#10;            Long sellerId = user.getId();&#13;&#10;&#13;&#10;            // Soft delete delivered accounts/inventory first to avoid FK constraints&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE ProductVariantAccount a SET a.isDelete = true, a.deletedBy = :uid &quot; +&#13;&#10;                            &quot;WHERE a.isDelete = false AND a.variant.id IN (SELECT v.id FROM ProductVariant v WHERE v.product.seller.id = :sellerId)&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete reviews of seller's products&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE Review r SET r.isDelete = true, r.deletedBy = :uid WHERE r.isDelete = false AND r.product.seller.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete transactions of this seller&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE Transaction t SET t.isDelete = true, t.deletedBy = :uid WHERE t.isDelete = false AND t.seller.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete product variants&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE ProductVariant v SET v.isDelete = true, v.deletedBy = :uid WHERE v.isDelete = false AND v.product.seller.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete products&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE Product p SET p.isDelete = true, p.deletedBy = :uid WHERE p.isDelete = false AND p.seller.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete seller bank info&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE SellerBankInfo s SET s.isDelete = true, s.deletedBy = :uid WHERE s.isDelete = false AND s.user.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;uid&quot;, uid).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Soft delete ShopInfo - Note: ShopInfo.deletedBy is a User entity, not Long&#13;&#10;            entityManager.createQuery(&#13;&#10;                    &quot;UPDATE ShopInfo s SET s.isDelete = true, s.deletedBy = :userEntity WHERE s.isDelete = false AND s.user.id = :sellerId&quot;&#13;&#10;            ).setParameter(&quot;userEntity&quot;, user).setParameter(&quot;sellerId&quot;, sellerId).executeUpdate();&#13;&#10;&#13;&#10;            // Set shopStatus back to Inactive&#13;&#10;            try {&#13;&#10;                user.setShopStatus(&quot;Inactive&quot;);&#13;&#10;                userRepository.save(user);&#13;&#10;            } catch (Exception ignored) {}&#13;&#10;&#13;&#10;            // Create notification for user&#13;&#10;            try {&#13;&#10;                notificationService.createNotificationForUser(&#13;&#10;                    user.getId(),&#13;&#10;                    &quot;Shop Registration Cancelled&quot;,&#13;&#10;                    &quot;Your shop has been successfully cancelled. You can register a new shop again at any time.&quot;&#13;&#10;                );&#13;&#10;            } catch (Exception e) {&#13;&#10;                // Log error but don't fail the operation&#13;&#10;                System.err.println(&quot;Failed to create notification: &quot; + e.getMessage());&#13;&#10;            }&#13;&#10;&#13;&#10;            return ResponseEntity.ok(&quot;Shop has been successfully cancelled.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Buy Points - send OTP&#13;&#10;    @PostMapping(path = &quot;/buy-points/send-otp&quot;)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; sendBuyPointsOtp(Authentication authentication) {&#13;&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        String email = authentication.getName();&#13;&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;            if (mailAttr != null) email = mailAttr.toString();&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;        }&#13;&#10;        if (user.getEmail() == null || user.getEmail().isBlank()) {&#13;&#10;            return ResponseEntity.badRequest().body(&quot;User has no email configured. Cannot send OTP.&quot;);&#13;&#10;        }&#13;&#10;        // Cooldown&#13;&#10;        try {&#13;&#10;            Optional&lt;com.mmo.entity.EmailVerification&gt; latest = emailVerificationRepository.findTopByUserOrderByCreatedAtDesc(user);&#13;&#10;            if (latest.isPresent() &amp;&amp; latest.get().getCreatedAt() != null) {&#13;&#10;                long seconds = (System.currentTimeMillis() - latest.get().getCreatedAt().getTime()) / 1000L;&#13;&#10;                if (seconds &lt; 60) {&#13;&#10;                    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(&quot;Please wait &quot; + (60 - seconds) + &quot;s before requesting a new OTP.&quot;);&#13;&#10;                }&#13;&#10;            }&#13;&#10;        } catch (Exception ignored) {}&#13;&#10;&#13;&#10;        try {&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] Confirm Points Purchase (OTP)&quot;;&#13;&#10;                    String html = EmailTemplate.buyPointsOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;        return ResponseEntity.ok(&quot;OTP has been sent to your email.&quot;);&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Buy Points - quote how many points/cost to reach a target level&#13;&#10;    @GetMapping(path = &quot;/buy-points/quote&quot;, produces = MediaType.APPLICATION_JSON_VALUE)&#13;&#10;    @ResponseBody&#13;&#10;    public ResponseEntity&lt;?&gt; quoteBuyPoints(@RequestParam(name = &quot;targetLevel&quot;, required = false) Integer targetLevel,&#13;&#10;                                            Authentication authentication) {&#13;&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#13;&#10;        }&#13;&#10;        String email = authentication.getName();&#13;&#10;        if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;        else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;            Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;            if (mailAttr != null) email = mailAttr.toString();&#13;&#10;        }&#13;&#10;        User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;        if (user == null) {&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Unauthorized&quot;));&#13;&#10;        }&#13;&#10;        ShopInfo shop = shopInfoRepository.findByUserIdAndIsDeleteFalse(user.getId()).orElseGet(() -&gt; shopInfoRepository.findByUser_Id(user.getId()).orElse(null));&#13;&#10;        if (shop == null) {&#13;&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;Shop not found.&quot;));&#13;&#10;        }&#13;&#10;        long currentPoints = shop.getPoints() == null ? 0L : shop.getPoints();&#13;&#10;        short currentLevel = shop.getShopLevel() == null ? 0 : shop.getShopLevel();&#13;&#10;        int desired = (targetLevel == null || targetLevel &lt; currentLevel + 1) ? (currentLevel + 1) : Math.min(targetLevel, 7);&#13;&#10;        long threshold = levelThreshold(desired);&#13;&#10;        if (desired &lt;= currentLevel) {&#13;&#10;            return ResponseEntity.ok(Map.of(&quot;ok&quot;, false, &quot;message&quot;, &quot;You already meet or exceed the selected level.&quot;, &quot;currentLevel&quot;, currentLevel));&#13;&#10;        }&#13;&#10;        long neededPoints = Math.max(0L, threshold - currentPoints);&#13;&#10;        long costCoins = neededPoints; // 1 coin per point&#13;&#10;        long coins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;        boolean enough = coins &gt;= costCoins;&#13;&#10;        long shortfall = enough ? 0L : (costCoins - coins);&#13;&#10;        return ResponseEntity.ok(Map.of(&#13;&#10;                &quot;ok&quot;, true,&#13;&#10;                &quot;currentLevel&quot;, currentLevel,&#13;&#10;                &quot;currentPoints&quot;, currentPoints,&#13;&#10;                &quot;targetLevel&quot;, desired,&#13;&#10;                &quot;targetThreshold&quot;, threshold,&#13;&#10;                &quot;neededPoints&quot;, neededPoints,&#13;&#10;                &quot;costCoins&quot;, costCoins,&#13;&#10;                &quot;coins&quot;, coins,&#13;&#10;                &quot;enough&quot;, enough,&#13;&#10;                &quot;shortfall&quot;, shortfall&#13;&#10;        ));&#13;&#10;    }&#13;&#10;&#13;&#10;    private long levelThreshold(int level) {&#13;&#10;        return switch (level) {&#13;&#10;            case 1 -&gt; 1_000_000L;&#13;&#10;            case 2 -&gt; 3_000_000L;&#13;&#10;            case 3 -&gt; 5_000_000L;&#13;&#10;            case 4 -&gt; 10_000_000L;&#13;&#10;            case 5 -&gt; 20_000_000L;&#13;&#10;            case 6 -&gt; 40_000_000L;&#13;&#10;            case 7 -&gt; 50_000_000L;&#13;&#10;            default -&gt; 0L;&#13;&#10;        };&#13;&#10;    }&#13;&#10;&#13;&#10;    // NEW: Buy Points - submit purchase request with OTP&#13;&#10;    @PostMapping(path = &quot;/buy-points&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)&#13;&#10;    @ResponseBody&#13;&#10;    @Transactional&#13;&#10;    public ResponseEntity&lt;?&gt; buyPoints(@RequestBody Map&lt;String, Object&gt; body,&#13;&#10;                                       Authentication authentication,&#13;&#10;                                       HttpSession session,&#13;&#10;                                       HttpServletRequest request) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;            String email = authentication.getName();&#13;&#10;            if (authentication.getPrincipal() instanceof OidcUser oidc) email = oidc.getEmail();&#13;&#10;            else if (authentication.getPrincipal() instanceof OAuth2User ou) {&#13;&#10;                Object mailAttr = ou.getAttributes().get(&quot;email&quot;);&#13;&#10;                if (mailAttr != null) email = mailAttr.toString();&#13;&#10;            }&#13;&#10;            User user = userRepository.findByEmail(email).orElse(null);&#13;&#10;            if (user == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Unauthorized&quot;);&#13;&#10;            }&#13;&#10;            ShopInfo shop = shopInfoRepository.findByUserIdAndIsDeleteFalse(user.getId()).orElseGet(() -&gt; shopInfoRepository.findByUser_Id(user.getId()).orElse(null));&#13;&#10;            if (shop == null) return ResponseEntity.badRequest().body(&quot;Shop not found.&quot;);&#13;&#10;&#13;&#10;            String otp = body.get(&quot;otp&quot;) != null ? body.get(&quot;otp&quot;).toString() : null;&#13;&#10;            if (otp == null || !otp.matches(&quot;\\d{6}&quot;)) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_REQUIRED: Please enter the 6-digit OTP sent to your email.&quot;);&#13;&#10;            }&#13;&#10;            // Pre-validate OTP&#13;&#10;            var optVerification = emailVerificationRepository.findTopByUserAndVerificationCodeAndIsUsedFalseOrderByCreatedAtDesc(user, otp);&#13;&#10;            if (optVerification.isEmpty()) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_INVALID: Code not found or already used.&quot;);&#13;&#10;            }&#13;&#10;            var verification = optVerification.get();&#13;&#10;            if (verification.getExpiryDate() == null || verification.getExpiryDate().before(new Date())) {&#13;&#10;                return handleOtpFailForWithdraw(session, request, authentication, user, user.getId(), &quot;buy_points&quot;, &quot;MSG_OTP_EXPIRED: The code has expired.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Parse pointsToBuy or targetLevel&#13;&#10;            Long pointsToBuy = null;&#13;&#10;            if (body.get(&quot;pointsToBuy&quot;) instanceof Number n) {&#13;&#10;                pointsToBuy = n.longValue();&#13;&#10;            } else if (body.get(&quot;targetLevel&quot;) instanceof Number lv) {&#13;&#10;                int desired = Math.min(7, Math.max(shop.getShopLevel() == null ? 0 : (shop.getShopLevel() + 1), lv.intValue()));&#13;&#10;                long threshold = levelThreshold(desired);&#13;&#10;                long currentPoints = shop.getPoints() == null ? 0L : shop.getPoints();&#13;&#10;                long need = Math.max(0L, threshold - currentPoints);&#13;&#10;                pointsToBuy = need;&#13;&#10;            }&#13;&#10;            if (pointsToBuy == null || pointsToBuy &lt;= 0) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;Invalid pointsToBuy.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Pre-check sufficient coins to avoid unnecessary OTP/queue&#13;&#10;            long coins = user.getCoins() == null ? 0L : user.getCoins();&#13;&#10;            if (coins &lt; pointsToBuy) {&#13;&#10;                long shortfall = pointsToBuy - coins;&#13;&#10;                return ResponseEntity.badRequest().body(&quot;Insufficient coins. Please top up at least &quot; + String.format(&quot;%,d&quot;, shortfall) + &quot; coins.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Success so far: clear attempts&#13;&#10;            clearSellerOtpAttempts(session, user.getId(), &quot;buy_points&quot;);&#13;&#10;&#13;&#10;            String dedupeKey = user.getId() + &quot;:&quot; + pointsToBuy + &quot;:&quot; + otp;&#13;&#10;            com.mmo.mq.dto.BuyPointsMessage msg = new com.mmo.mq.dto.BuyPointsMessage(&#13;&#10;                    user.getId(),&#13;&#10;                    pointsToBuy,&#13;&#10;                    pointsToBuy, // cost 1:1&#13;&#10;                    otp,&#13;&#10;                    dedupeKey&#13;&#10;            );&#13;&#10;            buyPointsPublisher.publish(msg);&#13;&#10;            return ResponseEntity.accepted().body(&quot;Your points purchase request has been queued. It will be applied shortly.&quot;);&#13;&#10;        } catch (Exception ex) {&#13;&#10;            return ResponseEntity.status(500).body(&quot;Internal error: &quot; + ex.getMessage());&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private void sendWithdrawalOtpForUser(User user) {&#13;&#10;        try {&#13;&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] OTP Xác minh rút tiền&quot;;&#13;&#10;                    String html = EmailTemplate.withdrawalOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;    }&#13;&#10;    private void sendDeleteShopOtpForUser(User user) {&#13;&#10;        try {&#13;&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] Confirm Shop Cancellation (OTP)&quot;;&#13;&#10;                    String html = EmailTemplate.deleteShopOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;    }&#13;&#10;    private void sendBuyPointsOtpForUser(User user) {&#13;&#10;        try {&#13;&#10;            if (user == null || user.getEmail() == null || user.getEmail().isBlank()) return;&#13;&#10;            User target = user;&#13;&#10;            emailExecutor.execute(() -&gt; {&#13;&#10;                try {&#13;&#10;                    String code = authService.generateVerificationCode();&#13;&#10;                    com.mmo.entity.EmailVerification verification = new com.mmo.entity.EmailVerification();&#13;&#10;                    verification.setUser(target);&#13;&#10;                    verification.setVerificationCode(code);&#13;&#10;                    verification.setExpiryDate(new Date(System.currentTimeMillis() + 5 * 60 * 1000));&#13;&#10;                    verification.setUsed(false);&#13;&#10;                    emailVerificationRepository.save(verification);&#13;&#10;                    String subject = &quot;[MMOMarket] Confirm Points Purchase (OTP)&quot;;&#13;&#10;                    String html = EmailTemplate.buyPointsOtpEmail(code);&#13;&#10;                    emailService.sendEmailAsync(target.getEmail(), subject, html);&#13;&#10;                } catch (Exception ignored) { }&#13;&#10;            });&#13;&#10;        } catch (Exception ignored) { }&#13;&#10;    }&#13;&#10;    private ResponseEntity&lt;String&gt; handleOtpFailForWithdraw(HttpSession session, HttpServletRequest request, Authentication authentication, User user, Long uid, String action, String baseMessage) {&#13;&#10;        int attempts = incSellerOtpAttempts(session, uid, action);&#13;&#10;        if (attempts &gt;= 5) {&#13;&#10;            try {&#13;&#10;                new SecurityContextLogoutHandler().logout(request, null, authentication);&#13;&#10;            } catch (Exception ignored) { }&#13;&#10;            try { session.invalidate(); } catch (Exception ignored) { }&#13;&#10;            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(&quot;Too many OTP failures. You have been logged out. Please sign in again.&quot;);&#13;&#10;        } else if (attempts &gt;= 3) {&#13;&#10;            try {&#13;&#10;                if (action != null &amp;&amp; action.startsWith(&quot;withdraw&quot;)) {&#13;&#10;                    sendWithdrawalOtpForUser(user);&#13;&#10;                } else if (action != null &amp;&amp; action.startsWith(&quot;delete_shop&quot;)) {&#13;&#10;                    sendDeleteShopOtpForUser(user);&#13;&#10;                } else if (action != null &amp;&amp; action.startsWith(&quot;buy_points&quot;)) {&#13;&#10;                    sendBuyPointsOtpForUser(user);&#13;&#10;                } else {&#13;&#10;                    sendWithdrawalOtpForUser(user);&#13;&#10;                }&#13;&#10;            } catch (Exception ignored) {}&#13;&#10;            return ResponseEntity.badRequest().body(baseMessage + &quot; A new OTP has been sent to your email. Please use the latest OTP.&quot;);&#13;&#10;        } else {&#13;&#10;            return ResponseEntity.badRequest().body(baseMessage);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    // Helpers for OTP attempt tracking per action&#13;&#10;    private String sellerOtpAttemptsKey(Long uid, String action) {&#13;&#10;        return &quot;sellerOtpAttempts:&quot; + uid + &quot;:&quot; + action;&#13;&#10;    }&#13;&#10;    private int incSellerOtpAttempts(HttpSession session, Long uid, String action) {&#13;&#10;        String key = sellerOtpAttemptsKey(uid, action);&#13;&#10;        Integer cur = (Integer) session.getAttribute(key);&#13;&#10;        int next = (cur == null ? 0 : cur) + 1;&#13;&#10;        session.setAttribute(key, next);&#13;&#10;        return next;&#13;&#10;    }&#13;&#10;    private void clearSellerOtpAttempts(HttpSession session, Long uid, String action) {&#13;&#10;        session.removeAttribute(sellerOtpAttemptsKey(uid, action));&#10;    }&#10;    private static String safeString(Object s) {&#10;        return s == null ? &quot;&quot; : s.toString();&#10;    }&#10;&#10;    // ==================== REVIEWS MANAGEMENT ====================&#10;    @GetMapping(&quot;/reviews&quot;)&#10;    public String sellerReviews(@RequestParam(name = &quot;page&quot;, defaultValue = &quot;0&quot;) int page,&#10;                                @RequestParam(name = &quot;search&quot;, defaultValue = &quot;&quot;) String search,&#10;                                @RequestParam(name = &quot;sort&quot;, defaultValue = &quot;rating_desc&quot;) String sort,&#10;                                Authentication authentication,&#10;                                Model model) {&#10;        if (authentication == null || !authentication.isAuthenticated()) {&#10;            return &quot;redirect:/authen/login&quot;;&#10;        }&#10;&#10;        User seller = entityManager.createQuery(&quot;SELECT u FROM User u WHERE LOWER(u.email) = LOWER(:email)&quot;, User.class)&#10;                .setParameter(&quot;email&quot;, authentication.getName())&#10;                .getResultStream()&#10;                .findFirst()&#10;                .orElse(null);&#10;&#10;        if (seller == null) {&#10;            return &quot;redirect:/authen/login&quot;;&#10;        }&#10;&#10;        // Build JPQL query to get reviews for seller's products&#10;        StringBuilder sb = new StringBuilder(&#10;            &quot;SELECT r FROM Review r &quot; +&#10;            &quot;LEFT JOIN FETCH r.product p &quot; +&#10;            &quot;LEFT JOIN FETCH r.user u &quot; +&#10;            &quot;WHERE r.isDelete = false AND p.seller.id = :sellerId&quot;&#10;        );&#10;        &#10;        if (search != null &amp;&amp; !search.isBlank()) {&#10;            sb.append(&quot; AND (LOWER(p.name) LIKE LOWER(:search) OR CAST(p.id AS string) LIKE :search OR CAST(u.id AS string) LIKE :search OR CAST(r.id AS string) LIKE :search)&quot;);&#10;        }&#10;&#10;        // Determine ordering&#10;        String orderField = &quot;r.rating&quot;;&#10;        String orderDir = &quot;DESC&quot;;&#10;        if (sort != null) {&#10;            String s = sort.trim().toLowerCase();&#10;            if (&quot;rating_asc&quot;.equals(s)) {&#10;                orderField = &quot;r.rating&quot;;&#10;                orderDir = &quot;ASC&quot;;&#10;            } else if (&quot;rating_desc&quot;.equals(s)) {&#10;                orderField = &quot;r.rating&quot;;&#10;                orderDir = &quot;DESC&quot;;&#10;            } else if (&quot;date_asc&quot;.equals(s)) {&#10;                orderField = &quot;r.createdAt&quot;;&#10;                orderDir = &quot;ASC&quot;;&#10;            } else if (&quot;date_desc&quot;.equals(s)) {&#10;                orderField = &quot;r.createdAt&quot;;&#10;                orderDir = &quot;DESC&quot;;&#10;            }&#10;        }&#10;        sb.append(&quot; ORDER BY &quot;).append(orderField).append(&quot; &quot;).append(orderDir);&#10;&#10;        jakarta.persistence.TypedQuery&lt;com.mmo.entity.Review&gt; query = entityManager.createQuery(sb.toString(), com.mmo.entity.Review.class);&#10;        query.setParameter(&quot;sellerId&quot;, seller.getId());&#10;        &#10;        if (search != null &amp;&amp; !search.isBlank()) {&#10;            query.setParameter(&quot;search&quot;, &quot;%&quot; + search + &quot;%&quot;);&#10;        }&#10;&#10;        List&lt;com.mmo.entity.Review&gt; all = query.getResultList();&#10;        int total = all.size();&#10;        int totalPages = (int) Math.ceil((double) total / 10);&#10;        List&lt;com.mmo.entity.Review&gt; pageList = all.stream()&#10;                .skip((long) page * 10)&#10;                .limit(10)&#10;                .toList();&#10;&#10;        model.addAttribute(&quot;reviews&quot;, pageList);&#10;        model.addAttribute(&quot;currentPage&quot;, page);&#10;        model.addAttribute(&quot;currentSearch&quot;, search);&#10;        model.addAttribute(&quot;currentSort&quot;, sort);&#10;        model.addAttribute(&quot;totalPages&quot;, totalPages);&#10;        model.addAttribute(&quot;pageTitle&quot;, &quot;Reviews Management&quot;);&#10;        &#10;        return &quot;seller/reviews&quot;;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/customer/wishlist.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/customer/wishlist.html" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;title&gt;My Wishlist&lt;/title&gt;&#10;    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;&#10;&lt;/head&gt;&#10;&lt;body class=&quot;bg-gray-50&quot;&gt;&#10;&lt;div th:replace=&quot;~{fragments/header :: header(active='account')}&quot;&gt;&lt;/div&gt;&#10;&#10;&lt;main class=&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10&quot;&gt;&#10;    &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-4 gap-8&quot;&gt;&#10;        &lt;aside class=&quot;lg:col-span-1&quot;&gt;&#10;            &lt;div class=&quot;bg-white rounded-lg shadow p-6&quot;&gt;&#10;                &lt;h2 class=&quot;text-2xl font-bold mb-6&quot;&gt;Account Setting&lt;/h2&gt;&#10;                &lt;div class=&quot;flex items-center space-x-4 mb-6&quot;&gt;&#10;                    &lt;div class=&quot;w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl font-bold text-gray-600&quot;&#10;                         th:text=&quot;${displayName != null and #strings.length(displayName) &gt; 0 ? #strings.toUpperCase(#strings.substring(displayName,0,1)) : 'C'}&quot;&gt;&lt;/div&gt;&#10;                    &lt;span class=&quot;font-semibold text-lg&quot; th:text=&quot;${displayName}&quot;&gt;customer&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;nav class=&quot;space-y-2&quot;&gt;&#10;                    &lt;a class=&quot;flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg&quot; href=&quot;#&quot;&gt;&#10;                        &lt;span&gt;My Profile&lt;/span&gt;&#10;                    &lt;/a&gt;&#10;                    &lt;a class=&quot;flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg&quot; href=&quot;#&quot;&gt;&#10;                        &lt;span&gt;My Order&lt;/span&gt;&#10;                    &lt;/a&gt;&#10;                    &lt;a class=&quot;flex items-center space-x-3 px-4 py-2 text-white bg-red-500 rounded-lg&quot; th:href=&quot;@{/account/wishlist}&quot;&gt;&#10;                        &lt;span&gt;My Wishlist&lt;/span&gt;&#10;                    &lt;/a&gt;&#10;                    &lt;a class=&quot;flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg&quot; href=&quot;#&quot;&gt;&#10;                        &lt;span&gt;My Complaints&lt;/span&gt;&#10;                    &lt;/a&gt;&#10;                    &lt;a class=&quot;flex items-center space-x-3 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg&quot; th:href=&quot;@{/account/notifications}&quot;&gt;&#10;                        &lt;span&gt;My Notifications&lt;/span&gt;&#10;                    &lt;/a&gt;&#10;                &lt;/nav&gt;&#10;            &lt;/div&gt;&#10;        &lt;/aside&gt;&#10;&#10;        &lt;section class=&quot;lg:col-span-3&quot;&gt;&#10;            &lt;div class=&quot;bg-white rounded-xl border border-gray-200 p-6 shadow-sm&quot;&gt;&#10;                &lt;div class=&quot;flex items-center justify-between mb-4&quot;&gt;&#10;                    &lt;h1 class=&quot;text-2xl font-bold&quot;&gt;My Wishlist&lt;/h1&gt;&#10;                    &lt;div th:if=&quot;${param.removed}&quot;&gt;&#10;                        &lt;span class=&quot;text-green-600 text-sm font-medium&quot;&gt;Item removed.&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div th:if=&quot;${#lists.isEmpty(items)}&quot; class=&quot;text-gray-500&quot;&gt;&#10;                    Your wishlist is empty.&#10;                &lt;/div&gt;&#10;&#10;                &lt;div th:unless=&quot;${#lists.isEmpty(items)}&quot; class=&quot;grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6&quot;&gt;&#10;                    &lt;div th:each=&quot;it : ${items}&quot; class=&quot;border rounded-xl overflow-hidden bg-white shadow-sm&quot;&gt;&#10;                        &lt;a th:with=&quot;p=${it['product']}&quot; th:href=&quot;@{/products(id=${p.id})}&quot;&gt;&#10;                            &lt;img th:src=&quot;${p.image != null ? p.image : '/images/default.jpg'}&quot; alt=&quot;Product Image&quot; class=&quot;w-full h-44 object-cover&quot;&gt;&#10;                        &lt;/a&gt;&#10;                        &lt;div class=&quot;p-4&quot;&gt;&#10;                            &lt;h3 class=&quot;font-semibold text-gray-900 truncate&quot;&gt;&#10;                                &lt;a th:with=&quot;p=${it['product']}&quot; th:text=&quot;${p.name}&quot; th:href=&quot;@{/products(id=${p.id})}&quot;&gt;Product&lt;/a&gt;&#10;                            &lt;/h3&gt;&#10;                            &lt;div class=&quot;mt-2 flex items-center justify-between&quot;&gt;&#10;                                &lt;form th:action=&quot;@{/wishlist/remove}&quot; method=&quot;post&quot;&gt;&#10;                                    &lt;input type=&quot;hidden&quot; name=&quot;productId&quot; th:value=&quot;${it['product'].id}&quot;&gt;&#10;                                    &lt;input type=&quot;hidden&quot; th:name=&quot;${_csrf.parameterName}&quot; th:value=&quot;${_csrf.token}&quot;&gt;&#10;                                    &lt;button type=&quot;submit&quot; class=&quot;text-red-600 text-sm hover:underline&quot;&gt;Remove&lt;/button&gt;&#10;                                &lt;/form&gt;&#10;                                &lt;a class=&quot;text-sm text-blue-600 hover:underline&quot; th:href=&quot;@{/products(id=${it['product'].id})}&quot;&gt;View&lt;/a&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;            &lt;/div&gt;&#10;        &lt;/section&gt;&#10;    &lt;/div&gt;&#10;&lt;/main&gt;&#10;&#10;&lt;div th:replace=&quot;~{fragments/footer :: footer}&quot;&gt;&lt;/div&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/seller/reviews.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/seller/reviews.html" />
              <option name="originalContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta content=&quot;width=device-width, initial-scale=1.0&quot; name=&quot;viewport&quot;&gt;&#10;    &lt;title&gt;MMO Market - Reviews Management&lt;/title&gt;&#10;    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;&#10;    &lt;script src=&quot;/js/tailwind-config.js&quot;&gt;&lt;/script&gt;&#10;    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;style&gt;&#10;        @keyframes fade-in {&#10;            from {&#10;                opacity: 0;&#10;                transform: translateY(40px) scale(0.95);&#10;            }&#10;            to {&#10;                opacity: 1;&#10;                transform: translateY(0) scale(1);&#10;            }&#10;        }&#10;&#10;        .animate-fade-in {&#10;            animation: fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);&#10;        }&#10;        body {&#10;            background: url('/images/home3.jpg') no-repeat center center fixed;&#10;            -webkit-background-size: cover;&#10;            -moz-background-size: cover;&#10;            -o-background-size: cover;&#10;            background-size: cover;&#10;        }&#10;        @media (max-width: 640px) {&#10;            body {&#10;                background-position: top center;&#10;            }&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body class=&quot;bg-gray-50 flex flex-col min-h-screen font-sans&quot;&gt;&#10;&#10;&lt;div th:replace=&quot;~{fragments/header :: header}&quot;&gt;&lt;/div&gt;&#10;&#10;&lt;main class=&quot;container mx-auto px-4 py-8&quot;&gt;&#10;    &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-4 gap-6&quot;&gt;&#10;        &lt;!-- Sidebar --&gt;&#10;        &lt;div th:replace=&quot;~{seller/sidebar :: sidebar}&quot;&gt;&lt;/div&gt;&#10;&#10;        &lt;!-- Main Content --&gt;&#10;        &lt;div class=&quot;lg:col-span-3&quot;&gt;&#10;            &lt;div class=&quot;bg-white rounded-2xl shadow-2xl border border-primary-100 p-6 md:p-8&quot;&gt;&#10;&#10;                &lt;!-- Header --&gt;&#10;                &lt;div class=&quot;mb-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl md:text-3xl font-bold text-primary-900 flex items-center&quot;&gt;&#10;                        &lt;svg class=&quot;h-8 w-8 mr-3 text-primary-600&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;&#10;                            &lt;path d=&quot;M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z&quot;&#10;                                  stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                        Reviews Management&#10;                    &lt;/h2&gt;&#10;                    &lt;p class=&quot;text-gray-500 mb-2&quot;&gt;Manage all reviews for your products&lt;/p&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Search Bar --&gt;&#10;                &lt;div class=&quot;mb-6&quot;&gt;&#10;                    &lt;form method=&quot;get&quot; th:action=&quot;@{/seller/reviews}&quot; class=&quot;flex flex-col md:flex-row gap-3&quot;&gt;&#10;                        &lt;div class=&quot;flex-1&quot;&gt;&#10;                            &lt;label for=&quot;search&quot; class=&quot;sr-only&quot;&gt;Search&lt;/label&gt;&#10;                            &lt;div class=&quot;relative&quot;&gt;&#10;                                &lt;input type=&quot;text&quot;&#10;                                       id=&quot;search&quot;&#10;                                       name=&quot;search&quot;&#10;                                       th:value=&quot;${currentSearch}&quot;&#10;                                       placeholder=&quot;Search by Product Name, Product ID, User ID, Review ID...&quot;&#10;                                       class=&quot;w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent&quot;&gt;&#10;                                &lt;svg class=&quot;absolute left-3 top-3 h-5 w-5 text-gray-400&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;&#10;                                    &lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot; d=&quot;M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z&quot;/&gt;&#10;                                &lt;/svg&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;input type=&quot;hidden&quot; name=&quot;sort&quot; th:value=&quot;${currentSort}&quot;&gt;&#10;                        &lt;button type=&quot;submit&quot; class=&quot;px-6 py-2.5 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors&quot;&gt;&#10;                            Search&#10;                        &lt;/button&gt;&#10;                    &lt;/form&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Reviews Table --&gt;&#10;                &lt;div class=&quot;overflow-x-auto&quot;&gt;&#10;                    &lt;div th:if=&quot;${reviews != null &amp;&amp; !reviews.isEmpty()}&quot;&gt;&#10;                        &lt;table class=&quot;min-w-full divide-y divide-primary-100 rounded-xl overflow-hidden&quot;&gt;&#10;                            &lt;thead class=&quot;bg-primary-50&quot;&gt;&#10;                            &lt;tr&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;STT&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;Review ID&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;Product ID&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;Product Name&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;User ID&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider cursor-pointer&quot;&#10;                                    onclick=&quot;sortTable()&quot;&gt;&#10;                                    Rating&#10;                                    &lt;svg class=&quot;inline h-4 w-4 ml-1 sort-icon&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;&#10;                                        &lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;&#10;                                              d=&quot;M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4&quot;&gt;&lt;/path&gt;&#10;                                    &lt;/svg&gt;&#10;                                &lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;Comment&lt;/th&gt;&#10;                                &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;Actions&lt;/th&gt;&#10;                            &lt;/tr&gt;&#10;                            &lt;/thead&gt;&#10;                            &lt;tbody class=&quot;bg-white divide-y divide-primary-50&quot;&gt;&#10;                            &lt;tr th:each=&quot;review, iterStat : ${reviews}&quot; class=&quot;hover:bg-primary-50 transition-all&quot;&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold&quot;&#10;                                    th:text=&quot;${iterStat.index + 1 + (currentPage * 10)}&quot;&gt;1&lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot;&#10;                                    th:text=&quot;${review.id}&quot;&gt;1&lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot;&#10;                                    th:text=&quot;${review.product.id}&quot;&gt;101&lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 text-sm text-gray-900&quot;&#10;                                    th:text=&quot;${review.product.name}&quot;&gt;Product Name&lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot;&#10;                                    th:text=&quot;${review.user.id}&quot;&gt;201&lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm&quot;&gt;&#10;                                    &lt;div class=&quot;flex items-center&quot;&gt;&#10;                                        &lt;span class=&quot;font-semibold text-gray-900 mr-1&quot; th:text=&quot;${review.rating}&quot;&gt;5&lt;/span&gt;&#10;                                        &lt;div class=&quot;flex&quot;&gt;&#10;                                            &lt;svg th:each=&quot;i : ${#numbers.sequence(1, 5)}&quot;&#10;                                                 class=&quot;h-4 w-4&quot;&#10;                                                 th:classappend=&quot;${i &lt;= review.rating} ? 'text-yellow-400' : 'text-gray-300'&quot;&#10;                                                 fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;&#10;                                                &lt;path d=&quot;M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z&quot;/&gt;&#10;                                            &lt;/svg&gt;&#10;                                        &lt;/div&gt;&#10;                                    &lt;/div&gt;&#10;                                &lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 text-sm text-gray-900&quot;&gt;&#10;                                    &lt;div class=&quot;max-w-xs truncate&quot; th:title=&quot;${review.comment}&quot; th:text=&quot;${review.comment}&quot;&gt;&#10;                                        Great product!&#10;                                    &lt;/div&gt;&#10;                                &lt;/td&gt;&#10;                                &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm&quot;&gt;&#10;                                    &lt;a th:href=&quot;@{/chat(userId=${review.user.id})}&quot;&#10;                                       class=&quot;inline-flex items-center px-3 py-1.5 bg-primary-600 text-white font-semibold rounded-lg shadow hover:bg-primary-700 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200&quot;&gt;&#10;                                        &lt;svg class=&quot;h-4 w-4 mr-1&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&gt;&#10;                                            &lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;&#10;                                                  d=&quot;M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z&quot;/&gt;&#10;                                        &lt;/svg&gt;&#10;                                        Chat&#10;                                    &lt;/a&gt;&#10;                                &lt;/td&gt;&#10;                            &lt;/tr&gt;&#10;                            &lt;/tbody&gt;&#10;                        &lt;/table&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div th:if=&quot;${reviews == null || reviews.isEmpty()}&quot;&gt;&#10;                        &lt;p class=&quot;text-gray-500 text-center py-8&quot;&gt;No reviews found.&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Pagination --&gt;&#10;                &lt;div th:if=&quot;${reviews != null &amp;&amp; !reviews.isEmpty()}&quot; class=&quot;mt-6 flex flex-col sm:flex-row justify-between items-center gap-4&quot;&gt;&#10;                    &lt;div class=&quot;text-sm text-gray-700&quot;&gt;&#10;                        Showing&#10;                        &lt;span class=&quot;font-semibold&quot; th:text=&quot;${currentPage * 10 + 1}&quot;&gt;1&lt;/span&gt;&#10;                        to&#10;                        &lt;span class=&quot;font-semibold&quot; th:text=&quot;${currentPage * 10 + #lists.size(reviews)}&quot;&gt;10&lt;/span&gt;&#10;                        of&#10;                        &lt;span class=&quot;font-semibold&quot; th:text=&quot;${totalPages * 10}&quot;&gt;100&lt;/span&gt;&#10;                        results&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;flex gap-2&quot;&gt;&#10;                        &lt;!-- Previous Button --&gt;&#10;                        &lt;a th:if=&quot;${currentPage &gt; 0}&quot;&#10;                           th:href=&quot;@{/seller/reviews(page=${currentPage - 1}, search=${currentSearch}, sort=${currentSort})}&quot;&#10;                           class=&quot;px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors&quot;&gt;&#10;                            Previous&#10;                        &lt;/a&gt;&#10;&#10;                        &lt;!-- Page Numbers --&gt;&#10;                        &lt;th:block th:each=&quot;i : ${#numbers.sequence(0, totalPages - 1)}&quot;&gt;&#10;                            &lt;a th:if=&quot;${i == 0 || i == currentPage || i == currentPage - 1 || i == currentPage + 1 || i == totalPages - 1}&quot;&#10;                               th:href=&quot;@{/seller/reviews(page=${i}, search=${currentSearch}, sort=${currentSort})}&quot;&#10;                               th:classappend=&quot;${i == currentPage} ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'&quot;&#10;                               th:text=&quot;${i + 1}&quot;&#10;                               class=&quot;px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium transition-colors&quot;&gt;&#10;                                1&#10;                            &lt;/a&gt;&#10;                            &lt;span th:if=&quot;${i == currentPage - 2 &amp;&amp; currentPage &gt; 2}&quot; class=&quot;px-2 py-2 text-gray-500&quot;&gt;...&lt;/span&gt;&#10;                            &lt;span th:if=&quot;${i == currentPage + 2 &amp;&amp; currentPage &lt; totalPages - 3}&quot; class=&quot;px-2 py-2 text-gray-500&quot;&gt;...&lt;/span&gt;&#10;                        &lt;/th:block&gt;&#10;&#10;                        &lt;!-- Next Button --&gt;&#10;                        &lt;a th:if=&quot;${currentPage &lt; totalPages - 1}&quot;&#10;                           th:href=&quot;@{/seller/reviews(page=${currentPage + 1}, search=${currentSearch}, sort=${currentSort})}&quot;&#10;                           class=&quot;px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors&quot;&gt;&#10;                            Next&#10;                        &lt;/a&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&lt;/main&gt;&#10;&#10;&lt;div th:replace=&quot;~{fragments/footer :: footer}&quot;&gt;&lt;/div&gt;&#10;&#10;&lt;script&gt;&#10;    function sortTable() {&#10;        const currentSort = new URLSearchParams(window.location.search).get('sort') || 'rating_desc';&#10;        const currentSearch = new URLSearchParams(window.location.search).get('search') || '';&#10;        const currentPage = new URLSearchParams(window.location.search).get('page') || '0';&#10;&#10;        let newSort = 'rating_asc';&#10;        if (currentSort === 'rating_asc') {&#10;            newSort = 'rating_desc';&#10;        }&#10;&#10;        window.location.href = `/seller/reviews?page=${currentPage}&amp;search=${encodeURIComponent(currentSearch)}&amp;sort=${newSort}`;&#10;    }&#10;&lt;/script&gt;&#10;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;&#10;" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta content=&quot;width=device-width, initial-scale=1.0&quot; name=&quot;viewport&quot;&gt;&#10;    &lt;title&gt;MMO Market - Reviews Management&lt;/title&gt;&#10;    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;&#10;    &lt;script src=&quot;/js/tailwind-config.js&quot;&gt;&lt;/script&gt;&#10;    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;style&gt;&#10;        @keyframes fade-in {&#10;            from {&#10;                opacity: 0;&#10;                transform: translateY(40px) scale(0.95);&#10;            }&#10;            to {&#10;                opacity: 1;&#10;                transform: translateY(0) scale(1);&#10;            }&#10;        }&#10;&#10;        .animate-fade-in {&#10;            animation: fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);&#10;        }&#10;        body {&#10;            background: url('/images/home3.jpg') no-repeat center center fixed;&#10;            -webkit-background-size: cover;&#10;            -moz-background-size: cover;&#10;            -o-background-size: cover;&#10;            background-size: cover;&#10;        }&#10;        @media (max-width: 640px) {&#10;            body {&#10;                background-position: top center;&#10;            }&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body class=&quot;bg-gray-50 flex flex-col min-h-screen font-sans&quot;&gt;&#10;&#10;&lt;div th:replace=&quot;~{fragments/header :: header}&quot;&gt;&lt;/div&gt;&#10;&#10;&lt;main class=&quot;flex-grow&quot;&gt;&#10;    &lt;div class=&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8&quot;&gt;&#10;        &lt;div class=&quot;mb-4 rounded-md bg-green-50 border border-green-200 px-4 py-3 text-green-800&quot;&#10;             th:if=&quot;${successMessage}&quot;&#10;             th:text=&quot;${successMessage}&quot;&gt;&lt;/div&gt;&#10;        &lt;div class=&quot;mb-4 rounded-md bg-red-50 border border-red-200 px-4 py-3 text-red-800&quot; th:if=&quot;${errorMessage}&quot;&#10;             th:text=&quot;${errorMessage}&quot;&gt;&lt;/div&gt;&#10;        &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-4 gap-8&quot;&gt;&#10;            &lt;div th:replace=&quot;~{seller/sidebar :: sidebar}&quot;&gt;&lt;/div&gt;&#10;            &lt;div class=&quot;lg:col-span-3 space-y-8&quot;&gt;&#10;                &lt;div class=&quot;bg-white border-2 border-primary-400 rounded-2xl shadow-md p-6 md:p-8 space-y-6 transition-all duration-300&quot;&gt;&#10;&#10;                    &lt;!-- Header --&gt;&#10;                    &lt;h2 class=&quot;text-xl md:text-2xl font-bold text-primary-900 flex items-center mb-4&quot;&gt;&#10;                        &lt;svg class=&quot;h-7 w-7 mr-3 text-primary-600&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&#10;                             xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                            &lt;path d=&quot;M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z&quot;&#10;                                  stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                        Reviews Management&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;!-- Reviews Table --&gt;&#10;                    &lt;div class=&quot;overflow-x-auto&quot;&gt;&#10;                        &lt;div th:if=&quot;${reviews != null &amp;&amp; !reviews.isEmpty()}&quot;&gt;&#10;                            &lt;table class=&quot;min-w-full divide-y divide-primary-100 rounded-xl overflow-hidden&quot;&gt;&#10;                                &lt;thead class=&quot;bg-primary-50&quot;&gt;&#10;                                &lt;tr&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        STT&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        Review ID&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        Product ID&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        Product Name&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        User ID&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider cursor-pointer&quot;&#10;                                        onclick=&quot;sortTable()&quot;&gt;&#10;                                        Rating&#10;                                        &lt;svg class=&quot;inline h-4 w-4 ml-1 sort-icon&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot;&#10;                                             viewBox=&quot;0 0 24 24&quot;&gt;&#10;                                            &lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;&#10;                                                  d=&quot;M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4&quot;&gt;&lt;/path&gt;&#10;                                        &lt;/svg&gt;&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        Comment&#10;                                    &lt;/th&gt;&#10;                                    &lt;th class=&quot;px-6 py-3 text-left text-xs font-bold text-primary-600 uppercase tracking-wider&quot;&gt;&#10;                                        Actions&#10;                                    &lt;/th&gt;&#10;                                &lt;/tr&gt;&#10;                                &lt;/thead&gt;&#10;                                &lt;tbody class=&quot;bg-white divide-y divide-primary-50&quot;&gt;&#10;                                &lt;tr th:each=&quot;review, iterStat : ${reviews}&quot; class=&quot;hover:bg-primary-50 transition-all&quot;&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold&quot; th:text=&quot;${iterStat.index + 1}&quot;&gt;&lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot; &#10;                                        th:text=&quot;${review.id}&quot;&gt;1&lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot; &#10;                                        th:text=&quot;${review.product.id}&quot;&gt;101&lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot; &#10;                                        th:text=&quot;${review.product.name}&quot;&gt;Product Name&lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot; &#10;                                        th:text=&quot;${review.user.id}&quot;&gt;201&lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot;&gt;&#10;                                        &lt;div class=&quot;flex items-center&quot;&gt;&#10;                                            &lt;span class=&quot;font-semibold mr-1&quot; th:text=&quot;${review.rating}&quot;&gt;5&lt;/span&gt;&#10;                                            &lt;div class=&quot;flex&quot;&gt;&#10;                                                &lt;svg th:each=&quot;i : ${#numbers.sequence(1, 5)}&quot; &#10;                                                     class=&quot;h-4 w-4&quot;&#10;                                                     th:classappend=&quot;${i &lt;= review.rating} ? 'text-yellow-400' : 'text-gray-300'&quot;&#10;                                                     fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&gt;&#10;                                                    &lt;path d=&quot;M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z&quot;/&gt;&#10;                                                &lt;/svg&gt;&#10;                                            &lt;/div&gt;&#10;                                        &lt;/div&gt;&#10;                                    &lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap text-sm text-gray-900&quot;&gt;&#10;                                        &lt;div class=&quot;max-w-xs truncate&quot; th:title=&quot;${review.comment}&quot; th:text=&quot;${review.comment}&quot;&gt;&#10;                                            Great product!&#10;                                        &lt;/div&gt;&#10;                                    &lt;/td&gt;&#10;                                    &lt;td class=&quot;px-6 py-4 whitespace-nowrap space-x-2&quot;&gt;&#10;                                        &lt;button type=&quot;button&quot;&#10;                                                onclick=&quot;window.location.href='/chat?userId=' + this.getAttribute('data-userid')&quot;&#10;                                                th:attr=&quot;data-userid=${review.user.id}&quot;&#10;                                                class=&quot;inline-block px-3 py-1 bg-primary-600 text-white font-semibold rounded-lg shadow hover:bg-primary-700 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200&quot;&gt;&#10;                                            Chat&#10;                                        &lt;/button&gt;&#10;                                    &lt;/td&gt;&#10;                                &lt;/tr&gt;&#10;                                &lt;/tbody&gt;&#10;                            &lt;/table&gt;&#10;                        &lt;/div&gt;&#10;                        &lt;div th:if=&quot;${reviews == null || reviews.isEmpty()}&quot;&gt;&#10;                            &lt;p class=&quot;text-gray-500&quot;&gt;No reviews found.&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;&#10;            &lt;/div&gt;&#10;&#10;        &lt;/div&gt;&#10;&#10;    &lt;/div&gt;&#10;&#10;&lt;/main&gt;&#10;&#10;&lt;div th:replace=&quot;~{fragments/footer :: footer}&quot;&gt;&lt;/div&gt;&#10;&#10;&lt;script&gt;&#10;    function sortTable() {&#10;        const currentSort = new URLSearchParams(window.location.search).get('sort') || 'rating_desc';&#10;        const currentSearch = new URLSearchParams(window.location.search).get('search') || '';&#10;        const currentPage = new URLSearchParams(window.location.search).get('page') || '0';&#10;&#10;        let newSort = 'rating_asc';&#10;        if (currentSort === 'rating_asc') {&#10;            newSort = 'rating_desc';&#10;        }&#10;&#10;        window.location.href = `/seller/reviews?page=${currentPage}&amp;search=${encodeURIComponent(currentSearch)}&amp;sort=${newSort}`;&#10;    }&#10;&lt;/script&gt;&#10;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/seller/sidebar.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MMOMarket/src/main/resources/templates/seller/sidebar.html" />
              <option name="originalContent" value="&lt;div class=&quot;lg:col-span-1&quot; th:fragment=&quot;sidebar&quot;&gt;&#10;    &lt;div class=&quot;bg-white rounded-2xl shadow-2xl border border-primary-100 p-6&quot;&gt;&#10;        &lt;!-- Shop Info --&gt;&#10;        &lt;div class=&quot;mb-6 pb-6 border-b border-primary-100&quot;&gt;&#10;            &lt;div class=&quot;flex items-center space-x-4&quot;&gt;&#10;                &lt;div class=&quot;flex-shrink-0&quot;&gt;&#10;                    &lt;div class=&quot;w-14 h-14 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center shadow-md&quot;&gt;&#10;                        &lt;svg class=&quot;h-7 w-7&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&#10;                             xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                            &lt;path d=&quot;M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z&quot; stroke-linecap=&quot;round&quot;&#10;                                  stroke-linejoin=&quot;round&quot;&#10;                                  stroke-width=&quot;2&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;                &lt;div&gt;&#10;                    &lt;h3 class=&quot;font-semibold text-primary-900 text-lg&quot;&gt;Your Shop&lt;/h3&gt;&#10;                    &lt;p class=&quot;text-xs text-primary-500&quot;&gt;Active since June 2024&lt;/p&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;!-- Navigation --&gt;&#10;        &lt;nav class=&quot;space-y-1&quot;&gt;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/my-shop') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/my-shop}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/my-shop') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Dashboard&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;!-- New: Shop Infor tab --&gt;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/shop-info') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/shop-info}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/shop-info') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 7h18M3 12h18M3 17h18&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Shop Infor&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/withdraw-money') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/withdraw-money}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/withdraw-money') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Withdraw&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4&quot; stroke-linecap=&quot;round&quot;&#10;                          stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Products&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Transactions&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z&quot; stroke-linecap=&quot;round&quot;&#10;                          stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Complaints&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Reviews&lt;/span&gt;&#10;            &lt;/a&gt;&#10;        &lt;/nav&gt;&#10;&#10;        &lt;!-- Quick Stats --&gt;&#10;        &lt;div class=&quot;mt-8 pt-6 border-t border-primary-100&quot;&gt;&#10;            &lt;h3 class=&quot;text-sm font-semibold text-primary-700 mb-3&quot;&gt;Quick Stats&lt;/h3&gt;&#10;            &lt;div class=&quot;grid grid-cols-1 gap-3&quot;&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Avg. Rating&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900 flex items-center&quot;&gt;&#10;                        4.8&#10;                        &lt;svg class=&quot;h-4 w-4 text-yellow-500 ml-1&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&#10;                             xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                            &lt;path d=&quot;M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                    &lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Total Products&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900&quot;&gt;24&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Balance&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900&quot;&gt;85.000 points&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;" />
              <option name="updatedContent" value="&lt;div class=&quot;lg:col-span-1&quot; th:fragment=&quot;sidebar&quot;&gt;&#10;    &lt;div class=&quot;bg-white rounded-2xl shadow-2xl border border-primary-100 p-6&quot;&gt;&#10;        &lt;!-- Shop Info --&gt;&#10;        &lt;div class=&quot;mb-6 pb-6 border-b border-primary-100&quot;&gt;&#10;            &lt;div class=&quot;flex items-center space-x-4&quot;&gt;&#10;                &lt;div class=&quot;flex-shrink-0&quot;&gt;&#10;                    &lt;div class=&quot;w-14 h-14 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center shadow-md&quot;&gt;&#10;                        &lt;svg class=&quot;h-7 w-7&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;&#10;                             xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                            &lt;path d=&quot;M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z&quot; stroke-linecap=&quot;round&quot;&#10;                                  stroke-linejoin=&quot;round&quot;&#10;                                  stroke-width=&quot;2&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;                &lt;div&gt;&#10;                    &lt;h3 class=&quot;font-semibold text-primary-900 text-lg&quot;&gt;Your Shop&lt;/h3&gt;&#10;                    &lt;p class=&quot;text-xs text-primary-500&quot;&gt;Active since June 2024&lt;/p&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;!-- Navigation --&gt;&#10;        &lt;nav class=&quot;space-y-1&quot;&gt;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/my-shop') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/my-shop}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/my-shop') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Dashboard&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;!-- New: Shop Infor tab --&gt;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/shop-info') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/shop-info}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/shop-info') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 7h18M3 12h18M3 17h18&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Shop Infor&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/withdraw-money') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/withdraw-money}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/withdraw-money') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Withdraw&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4&quot; stroke-linecap=&quot;round&quot;&#10;                          stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;/&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Products&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Transactions&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm text-primary-700 hover:bg-primary-50 hover:text-primary-600 transition-all&quot;&#10;               href=&quot;#&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 text-primary-300 group-hover:text-primary-600 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z&quot; stroke-linecap=&quot;round&quot;&#10;                          stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Complaints&lt;/span&gt;&#10;            &lt;/a&gt;&#10;&#10;            &lt;a class=&quot;group flex items-center px-3 py-2.5 rounded-xl font-medium text-sm transition-all&quot;&#10;               th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/reviews') ? 'bg-primary-50 text-primary-700 shadow' : 'text-primary-700 hover:bg-primary-50 hover:text-primary-600'}&quot;&#10;               th:href=&quot;@{/seller/reviews}&quot;&gt;&#10;                &lt;svg class=&quot;mr-3 h-5 w-5 flex-shrink-0 transition-colors&quot;&#10;                     fill=&quot;none&quot;&#10;                     stroke=&quot;currentColor&quot;&#10;                     th:classappend=&quot;${#httpServletRequest != null and #httpServletRequest.requestURI != null and #httpServletRequest.requestURI.contains('/seller/reviews') ? 'text-primary-600' : 'text-primary-300 group-hover:text-primary-600'}&quot;&#10;                     viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                    &lt;path d=&quot;M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z&quot;&#10;                          stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;&#10;                          stroke-width=&quot;2&quot;&gt;&lt;/path&gt;&#10;                &lt;/svg&gt;&#10;                &lt;span&gt;Reviews&lt;/span&gt;&#10;            &lt;/a&gt;&#10;        &lt;/nav&gt;&#10;&#10;        &lt;!-- Quick Stats --&gt;&#10;        &lt;div class=&quot;mt-8 pt-6 border-t border-primary-100&quot;&gt;&#10;            &lt;h3 class=&quot;text-sm font-semibold text-primary-700 mb-3&quot;&gt;Quick Stats&lt;/h3&gt;&#10;            &lt;div class=&quot;grid grid-cols-1 gap-3&quot;&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Avg. Rating&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900 flex items-center&quot;&gt;&#10;                        4.8&#10;                        &lt;svg class=&quot;h-4 w-4 text-yellow-500 ml-1&quot; fill=&quot;currentColor&quot; viewBox=&quot;0 0 20 20&quot;&#10;                             xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;                            &lt;path d=&quot;M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z&quot;/&gt;&#10;                        &lt;/svg&gt;&#10;                    &lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Total Products&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900&quot;&gt;24&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;flex justify-between items-center bg-primary-50 rounded-lg px-4 py-2&quot;&gt;&#10;                    &lt;span class=&quot;text-xs text-primary-600&quot;&gt;Balance&lt;/span&gt;&#10;                    &lt;span class=&quot;font-bold text-primary-900&quot;&gt;85.000 points&lt;/span&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>